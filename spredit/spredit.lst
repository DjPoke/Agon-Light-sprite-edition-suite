PC     Output      Line
040000             0001   ; spredit.asm
040000             0002   ;
040000             0003   ; by B.Vignoli
040000             0004   ; MIT 2023-2024
040000             0005   ;
040000             0006   
040000             0007   .assume adl=1
040000             0008   .org $040000
040000             0009   
040000 C3 4D 00 04 0010   	jp start
040004             0011   
040004             0012   ; MOS header
040004 00 00 00 00 0013   .align 64
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
       00 00 00 00 
040040 4D 4F 53 00 0014   .db "MOS",0,1
       01          
040045             0015   
040045             0016   .FILLBYTE 0
040045             0017   
040045             0018   	include "mos_api.inc"
040045             0001*  ;
040045             0002*  ; Title:	AGON MOS - API for user projects
040045             0003*  ; Author:	Dean Belfield
040045             0004*  ; Created:	03/08/2022
040045             0005*  ; Last Updated:	11/11/2023
040045             0006*  ;
040045             0007*  ; Modinfo:
040045             0008*  ; 05/08/2022:	Added mos_feof
040045             0009*  ; 09/08/2022:	Added system variables: cursorX, cursorY
040045             0010*  ; 18/08/2022:	Added system variables: scrchar, scrpixel, audioChannel, audioSuccess, vpd_pflags
040045             0011*  ; 05/09/2022:	Added mos_ren, vdp_pflag_mode
040045             0012*  ; 24/09/2022:	Added mos_getError, mos_mkdir
040045             0013*  ; 13/10/2022:	Added mos_oscli
040045             0014*  ; 23/02/2023:	Added more sysvars, fixed typo in sysvar_audioSuccess, offsets for sysvar_scrCols, sysvar_scrRows
040045             0015*  ; 04/03/2023:	Added sysvar_scrpixelIndex
040045             0016*  ; 08/03/2023:	Renamed sysvar_keycode to sysvar_keyascii, added sysvar_vkeycode
040045             0017*  ; 15/03/2023:	Added mos_copy, mos_getrtc, mos_setrtc, rtc, vdp_pflag_rtc
040045             0018*  ; 21/03/2023:	Added mos_setintvector, sysvars for keyboard status, vdu codes for vdp
040045             0019*  ; 22/03/2023:	The VDP commands are now indexed from 0x80
040045             0020*  ; 29/03/2023:	Added mos_uopen, mos_uclose, mos_ugetc, mos_uputc
040045             0021*  ; 13/04/2023:	Added FatFS file structures (FFOBJID, FIL, DIR, FILINFO)
040045             0022*  ; 15/04/2023:	Added mos_getfil, mos_fread, mos_fwrite and mos_flseek
040045             0023*  ; 19/05/2023:	Added sysvar_scrMode
040045             0024*  ; 05/06/2023:	Added sysvar_rtcEnable
040045             0025*  ; 03/08/2023:	Added mos_setkbvector
040045             0026*  ; 10/08/2023:	Added mos_getkbmap
040045             0027*  ; 11/11/2023:	Added mos_i2c_open, mos_i2c_close, mos_i2c_write and mos_i2c_read
040045             0028*  
040045             0029*  ; VDP control (VDU 23, 0, n)
040045             0030*  ;
040045             0031*  vdp_gp:			EQU 	80h
040045             0032*  vdp_keycode:		EQU 	81h
040045             0033*  vdp_cursor:		EQU	82h
040045             0034*  vdp_scrchar:		EQU	83h
040045             0035*  vdp_scrpixel:		EQU	84h
040045             0036*  vdp_audio:		EQU	85h
040045             0037*  vdp_mode:		EQU	86h
040045             0038*  vdp_rtc:		EQU	87h
040045             0039*  vdp_keystate:		EQU	88h
040045             0040*  vdp_logicalcoords:	EQU	C0h
040045             0041*  vdp_terminalmode:	EQU	FFh
040045             0042*  
040045             0043*  ; MOS high level functions
040045             0044*  ;
040045             0045*  mos_getkey:		EQU	00h
040045             0046*  mos_load:		EQU	01h
040045             0047*  mos_save:		EQU	02h
040045             0048*  mos_cd:			EQU	03h
040045             0049*  mos_dir:		EQU	04h
040045             0050*  mos_del:		EQU	05h
040045             0051*  mos_ren:		EQU	06h
040045             0052*  mos_mkdir:		EQU	07h
040045             0053*  mos_sysvars:		EQU	08h
040045             0054*  mos_editline:		EQU	09h
040045             0055*  mos_fopen:		EQU	0Ah
040045             0056*  mos_fclose:		EQU	0Bh
040045             0057*  mos_fgetc:		EQU	0Ch
040045             0058*  mos_fputc:		EQU	0Dh
040045             0059*  mos_feof:		EQU	0Eh
040045             0060*  mos_getError:		EQU	0Fh
040045             0061*  mos_oscli:		EQU	10h
040045             0062*  mos_copy:		EQU	11h
040045             0063*  mos_getrtc:		EQU	12h
040045             0064*  mos_setrtc:		EQU	13h
040045             0065*  mos_setintvector:	EQU	14h
040045             0066*  mos_uopen:		EQU	15h
040045             0067*  mos_uclose:		EQU	16h
040045             0068*  mos_ugetc:		EQU	17h
040045             0069*  mos_uputc:		EQU 	18h
040045             0070*  mos_getfil:		EQU	19h
040045             0071*  mos_fread:		EQU	1Ah
040045             0072*  mos_fwrite:		EQU	1Bh
040045             0073*  mos_flseek:		EQU	1Ch
040045             0074*  mos_setkbvector:	EQU	1Dh
040045             0075*  mos_getkbmap:		EQU	1Eh
040045             0076*  mos_i2c_open:		EQU	1Fh
040045             0077*  mos_i2c_close:		EQU	20h
040045             0078*  mos_i2c_write:		EQU	21h
040045             0079*  mos_i2c_read:		EQU	22h
040045             0080*  
040045             0081*  
040045             0082*  ; FatFS file access functions
040045             0083*  ;
040045             0084*  ffs_fopen:		EQU	80h
040045             0085*  ffs_fclose:		EQU	81h
040045             0086*  ffs_fread:		EQU	82h
040045             0087*  ffs_fwrite:		EQU	83h
040045             0088*  ffs_flseek:		EQU	84h
040045             0089*  ffs_ftruncate:		EQU	85h
040045             0090*  ffs_fsync:		EQU	86h
040045             0091*  ffs_fforward:		EQU	87h
040045             0092*  ffs_fexpand:		EQU	88h
040045             0093*  ffs_fgets:		EQU	89h
040045             0094*  ffs_fputc:		EQU	8Ah
040045             0095*  ffs_fputs:		EQU	8Bh
040045             0096*  ffs_fprintf:		EQU	8Ch
040045             0097*  ffs_ftell:		EQU	8Dh
040045             0098*  ffs_feof:		EQU	8Eh
040045             0099*  ffs_fsize:		EQU	8Fh
040045             0100*  ffs_ferror:		EQU	90h
040045             0101*  
040045             0102*  ; FatFS directory access functions
040045             0103*  ;
040045             0104*  ffs_dopen:		EQU	91h
040045             0105*  ffs_dclose:		EQU	92h
040045             0106*  ffs_dread:		EQU	93h
040045             0107*  ffs_dfindfirst:		EQU	94h
040045             0108*  ffs_dfindnext:		EQU	95h
040045             0109*  
040045             0110*  ; FatFS file and directory management functions
040045             0111*  ;
040045             0112*  ffs_stat:		EQU	96h
040045             0113*  ffs_unlink:		EQU	97h
040045             0114*  ffs_rename:		EQU	98h
040045             0115*  ffs_chmod:		EQU	99h
040045             0116*  ffs_utime:		EQU	9Ah
040045             0117*  ffs_mkdir:		EQU	9Bh
040045             0118*  ffs_chdir:		EQU	9Ch
040045             0119*  ffs_chdrive:		EQU	9Dh
040045             0120*  ffs_getcwd:		EQU	9Eh
040045             0121*  
040045             0122*  ; FatFS volume management and system configuration functions
040045             0123*  ;
040045             0124*  ffs_mount:		EQU	9Fh
040045             0125*  ffs_mkfs:		EQU	A0h
040045             0126*  ffs_fdisk:		EQU	A1h
040045             0127*  ffs_getfree:		EQU	A2h
040045             0128*  ffs_getlabel:		EQU	A3h
040045             0129*  ffs_setlabel:		EQU	A4h
040045             0130*  ffs_setcp:		EQU	A5h
040045             0131*  
040045             0132*  ; File access modes
040045             0133*  ;
040045             0134*  fa_read:		EQU	01h
040045             0135*  fa_write:		EQU	02h
040045             0136*  fa_open_existing:	EQU	00h
040045             0137*  fa_create_new:		EQU	04h
040045             0138*  fa_create_always:	EQU	08h
040045             0139*  fa_open_always:		EQU	10h
040045             0140*  fa_open_append:		EQU	30h
040045             0141*  
040045             0142*  ; System variable indexes for api_sysvars
040045             0143*  ; Index into _sysvars in globals.asm
040045             0144*  ;
040045             0145*  sysvar_time:		EQU	00h	; 4: Clock timer in centiseconds (incremented by 2 every VBLANK)
040045             0146*  sysvar_vpd_pflags:	EQU	04h	; 1: Flags to indicate completion of VDP commands
040045             0147*  sysvar_keyascii:	EQU	05h	; 1: ASCII keycode, or 0 if no key is pressed
040045             0148*  sysvar_keymods:		EQU	06h	; 1: Keycode modifiers
040045             0149*  sysvar_cursorX:		EQU	07h	; 1: Cursor X position
040045             0150*  sysvar_cursorY:		EQU	08h	; 1: Cursor Y position
040045             0151*  sysvar_scrchar:		EQU	09h	; 1: Character read from screen
040045             0152*  sysvar_scrpixel:	EQU	0Ah	; 3: Pixel data read from screen (R,B,G)
040045             0153*  sysvar_audioChannel:	EQU	0Dh	; 1: Audio channel
040045             0154*  sysvar_audioSuccess:	EQU	0Eh	; 1: Audio channel note queued (0 = no, 1 = yes)
040045             0155*  sysvar_scrWidth:	EQU	0Fh	; 2: Screen width in pixels
040045             0156*  sysvar_scrHeight:	EQU	11h	; 2: Screen height in pixels
040045             0157*  sysvar_scrCols:		EQU	13h	; 1: Screen columns in characters
040045             0158*  sysvar_scrRows:		EQU	14h	; 1: Screen rows in characters
040045             0159*  sysvar_scrColours:	EQU	15h	; 1: Number of colours displayed
040045             0160*  sysvar_scrpixelIndex:	EQU	16h	; 1: Index of pixel data read from screen
040045             0161*  sysvar_vkeycode:	EQU	17h	; 1: Virtual key code from FabGL
040045             0162*  sysvar_vkeydown:	EQU	18h	; 1: Virtual key state from FabGL (0=up, 1=down)
040045             0163*  sysvar_vkeycount:	EQU	19h	; 1: Incremented every time a key packet is received
040045             0164*  sysvar_rtc:		EQU	1Ah	; 6: Real time clock data
040045             0165*  sysvar_spare:		EQU	20h	; 2: Spare, previously used by rtc
040045             0166*  sysvar_keydelay:	EQU	22h	; 2: Keyboard repeat delay
040045             0167*  sysvar_keyrate:		EQU	24h	; 2: Keyboard repeat reat
040045             0168*  sysvar_keyled:		EQU	26h	; 1: Keyboard LED status
040045             0169*  sysvar_scrMode:		EQU	27h	; 1: Screen mode
040045             0170*  sysvar_rtcEnable:	EQU	28h	; 1: RTC enable flag (0: disabled, 1: use ESP32 RTC)
040045             0171*  sysvar_mouseX:		EQU	29h	; 2: Mouse X position
040045             0172*  sysvar_mouseY:		EQU	2Bh	; 2: Mouse Y position
040045             0173*  sysvar_mouseButtons:	EQU	2Dh	; 1: Mouse button state
040045             0174*  sysvar_mouseWheel:	EQU	2Eh	; 1: Mouse wheel delta
040045             0175*  sysvar_mouseXDelta:	EQU	2Fh	; 2: Mouse X delta
040045             0176*  sysvar_mouseYDelta:	EQU	31h	; 2: Mouse Y delta
040045             0177*  
040045             0178*  ; Flags for the VPD protocol
040045             0179*  ;
040045             0180*  vdp_pflag_cursor:	EQU	00000001b
040045             0181*  vdp_pflag_scrchar:	EQU	00000010b
040045             0182*  vdp_pflag_point:	EQU	00000100b
040045             0183*  vdp_pflag_audio:	EQU	00001000b
040045             0184*  vdp_pflag_mode:		EQU	00010000b
040045             0185*  vdp_pflag_rtc:		EQU	00100000b
040045             0186*  vdp_pflag_mouse:	EQU	01000000b
040045             0187*  vdp_pflag_buffered:	EQU	10000000b
040045             0188*  
040045             0189*  ;
040045             0190*  ; Macro for calling the API
040045             0191*  ; Parameters:
040045             0192*  ; - function: One of the function numbers listed above
040045             0193*  ;
040045             0194*  	MACRO moscall function
040045             0195*  		LD	A, function
040045             0196*  		RST.LIS	08h
040045             0197*  	ENDMACRO
040045             0198*  
040045             0199*  	MACRO vdu function
040045             0200*  		LD	A, function
040045             0201*  		RST.LIS	10h
040045             0202*  	ENDMACRO
040045             0203*  
040045             0204*  	MACRO vdu_a
040045             0205*  		RST.LIS	10h
040045             0206*  	ENDMACRO
040045             0019   
040045             0020   MAX_COLORS:		 	equ 64
040045             0021   
040045             0022   MAX_FRAMES:			equ 8
040045             0023   
040045             0024   COLOR_WHITE:		equ 15
040045             0025   COLOR_BLACK:		equ 0
040045             0026   
040045             0027   TITLE_X: 	equ 17
040045             0028   TITLE_Y: 	equ 2
040045             0029   MENU_X: 	equ 13
040045             0030   MENU1_Y: 	equ 8
040045             0031   MENU2_Y: 	equ 12
040045             0032   MENU3_Y: 	equ 16
040045             0033   MENU4_Y: 	equ 20
040045             0034   MENU5_Y: 	equ 24
040045             0035   FILENAME_X: equ 7
040045             0036   FILENAME_Y: equ 24
040045             0037   
040045             0038   SPR44: 		equ 4
040045             0039   SPR88: 		equ 8
040045             0040   SPR1616: 	equ 16
040045             0041   SPR3232: 	equ 32
040045             0042   
040045             0043   SPR44_width: 	equ 32
040045             0044   SPR88_width: 	equ 16
040045             0045   SPR1616_width: 	equ 8
040045             0046   SPR3232_width: 	equ 4
040045             0047   
040045             0048   BUFFER_SIZE:			equ 8192 ; 8 frames
040045             0049   ONE_FRAME_BUFFER_SIZE:	equ 1024
040045             0050   
040045             0051   FILENAME_LENGTH:	equ 16
040045             0052   
040045             0053   HEADER_BUFFER_SIZE:		equ 16
040045             0054   
040045             0055   SLOWDOWN_DELAY:	equ 20
040045             0056   
040045             0057   KEY_SPACE: equ -99 ; draw with color
040045             0058   KEY_UP: equ -58 ; move
040045             0059   KEY_DOWN: equ -42
040045             0060   KEY_LEFT: equ -26
040045             0061   KEY_RIGHT: equ -122
040045             0062   KEY_DELETE: equ -90 ; remove color with black
040045             0063   KEY_N: equ -86 ; add a new void frame
040045             0064   KEY_C: equ -83 ; copy current frame to a new frame
040045             0065   KEY_BACKSPACE: equ -48 ; delete current selected frame
040045             0066   KEY_PGUP: equ -64 ; select frame
040045             0067   KEY_PGDOWN: equ -79
040045             0068   KEY_L: equ -87 ; load sprite
040045             0069   KEY_S: equ -82 ; save sprite
040045             0070   KEY_E: equ -35 ; export sprite as assembler data
040045             0071   KEY_R: equ -52 ; rotate frame clockwise
040045             0072   KEY_F: equ -68 ; flip frame horizontally
040045             0073   KEY_M: equ -102 ; mirror frame vertically
040045             0074   KEY_ESCAPE: equ -113
040045             0075   KEY_F1: equ -114 ; select 4x4 sprite
040045             0076   KEY_F2: equ -115 ; select 8x8 sprite
040045             0077   KEY_F3: equ -116 ; select 16x16 sprite
040045             0078   KEY_F4: equ -21 ; select 32x32 sprite
040045             0079   KEY_RETURN: equ -74 ; floodfill
040045             0080   
040045             0081   ; play mode:
040045             0082   KEY_P:	equ -56 ; switch to play mode
040045             0083   KEY_D:	equ -51 ; change delay (speeds: normal (100ms), slow (250ms), fast (25ms))
040045             0084   
040045             0085   ; palette mode:
040045             0086   KEY_TAB: equ -97 ; switch to palette mode
040045             0087   KEY_1:	equ -49 ; red+
040045             0088   KEY_2:	equ -50 ; green+
040045             0089   KEY_3:	equ -18 ; blue+
040045             0090   KEY_4:	equ -19 ; red-
040045             0091   KEY_5:	equ -20 ; green-
040045             0092   KEY_6:	equ -53; blue-
040045             0093   KEY_7:	equ -37 ; reset color to black
040045             0094   ; KEY_L: load palette file (must be 2, 4, 16 or 64 colors)
040045             0095   ; KEY_S: save palette file
040045             0096   
040045             0097   MAX_PAL_DATA: equ 836 ; max palette chars
040045             0098   MAX_PAL_DATA_HI: equ 03h
040045             0099   MAX_PAL_DATA_LO: equ 44h
040045             0100   
040045             0101   BITLOOKUP:
040045 01 02 04 08 0102   	DB 01h,02h,04h,08h
040049 10 20 40 80 0103   	DB 10h,20h,40h,80h
04004D             0104   
04004D             0105   ;======================================================================
04004D             0106   start:
04004D F5          0107   	push af
04004E C5          0108   	push bc
04004F D5          0109   	push de
040050 DD E5       0110   	push ix
040052 FD E5       0111   	push iy
040054             0112   
040054             0113   	; set mode 8 (320x240x64)
040054             0114   	vdu 22
040054 3E 16       0001M  		LD	A, function
040056 49 D7       0002M  		RST.LIS	10h
040058             0115   	vdu 8
040058 3E 08       0001M  		LD	A, function
04005A 49 D7       0002M  		RST.LIS	10h
04005C             0116   
04005C             0117   	; disable logical scale coordinates system
04005C             0118   	vdu 23
04005C 3E 17       0001M  		LD	A, function
04005E 49 D7       0002M  		RST.LIS	10h
040060             0119   	vdu 0
040060 3E 00       0001M  		LD	A, function
040062 49 D7       0002M  		RST.LIS	10h
040064             0120   	vdu $c0
040064 3E C0       0001M  		LD	A, function
040066 49 D7       0002M  		RST.LIS	10h
040068             0121   	vdu 0
040068 3E 00       0001M  		LD	A, function
04006A 49 D7       0002M  		RST.LIS	10h
04006C             0122   
04006C             0123   	; set text colors
04006C             0124   	vdu 17
04006C 3E 11       0001M  		LD	A, function
04006E 49 D7       0002M  		RST.LIS	10h
040070             0125   	vdu 128 ; black background
040070 3E 80       0001M  		LD	A, function
040072 49 D7       0002M  		RST.LIS	10h
040074             0126   
040074             0127   	vdu 17
040074 3E 11       0001M  		LD	A, function
040076 49 D7       0002M  		RST.LIS	10h
040078             0128   	vdu COLOR_WHITE ; white pen
040078 3E 0F       0001M  		LD	A, function
04007A 49 D7       0002M  		RST.LIS	10h
04007C             0129   
04007C             0130   	; set graphics pen
04007C             0131   	vdu 18
04007C 3E 12       0001M  		LD	A, function
04007E 49 D7       0002M  		RST.LIS	10h
040080             0132   	vdu 0
040080 3E 00       0001M  		LD	A, function
040082 49 D7       0002M  		RST.LIS	10h
040084             0133   	vdu COLOR_WHITE ; white pen
040084 3E 0F       0001M  		LD	A, function
040086 49 D7       0002M  		RST.LIS	10h
040088             0134   
040088             0135   	; hide cursor
040088             0136   	vdu 23
040088 3E 17       0001M  		LD	A, function
04008A 49 D7       0002M  		RST.LIS	10h
04008C             0137   	vdu 1
04008C 3E 01       0001M  		LD	A, function
04008E 49 D7       0002M  		RST.LIS	10h
040090             0138   	vdu 0
040090 3E 00       0001M  		LD	A, function
040092 49 D7       0002M  		RST.LIS	10h
040094             0139   
040094             0140   	; store coordinates
040094 DD 21 EE 17 0141   	ld ix,x1
       04          
040099 21 00 00 00 0142   	ld hl,0
04009D DD 75 00    0143   	ld (ix+0),l
0400A0 DD 74 01    0144   	ld (ix+1),h
0400A3             0145   
0400A3 DD 21 F0 17 0146   	ld ix,y1
       04          
0400A8 21 00 00 00 0147   	ld hl,0
0400AC DD 75 00    0148   	ld (ix+0),l
0400AF DD 74 01    0149   	ld (ix+1),h
0400B2             0150   
0400B2 DD 21 F2 17 0151   	ld ix,x2
       04          
0400B7 21 3F 01 00 0152   	ld hl,319
0400BB DD 75 00    0153   	ld (ix+0),l
0400BE DD 74 01    0154   	ld (ix+1),h
0400C1             0155   
0400C1 DD 21 F4 17 0156   	ld ix,y2
       04          
0400C6 21 EF 00 00 0157   	ld hl,239
0400CA DD 75 00    0158   	ld (ix+0),l
0400CD DD 74 01    0159   	ld (ix+1),h
0400D0             0160   
0400D0             0161   	; draw the border rectangle
0400D0 CD 81 0A 04 0162   	call fn_rect
0400D4             0163   
0400D4             0164   	; locate x,y
0400D4             0165   	vdu 31
0400D4 3E 1F       0001M  		LD	A, function
0400D6 49 D7       0002M  		RST.LIS	10h
0400D8             0166   	vdu TITLE_X
0400D8 3E 11       0001M  		LD	A, function
0400DA 49 D7       0002M  		RST.LIS	10h
0400DC             0167   	vdu TITLE_Y
0400DC 3E 02       0001M  		LD	A, function
0400DE 49 D7       0002M  		RST.LIS	10h
0400E0             0168   
0400E0             0169   	; print text
0400E0 21 05 18 04 0170   	ld hl,title
0400E4 01 00 00 00 0171   	ld bc,0
0400E8 AF          0172   	xor a
0400E9 49 DF       0173   	rst.lis $18
0400EB             0174   
0400EB             0175   	; locate x,y
0400EB             0176   	vdu 31
0400EB 3E 1F       0001M  		LD	A, function
0400ED 49 D7       0002M  		RST.LIS	10h
0400EF             0177   	vdu MENU_X
0400EF 3E 0D       0001M  		LD	A, function
0400F1 49 D7       0002M  		RST.LIS	10h
0400F3             0178   	vdu MENU1_Y
0400F3 3E 08       0001M  		LD	A, function
0400F5 49 D7       0002M  		RST.LIS	10h
0400F7             0179   
0400F7             0180   	; print text
0400F7 21 0E 18 04 0181   	ld hl,menu1
0400FB 01 00 00 00 0182   	ld bc,0
0400FF AF          0183   	xor a
040100 49 DF       0184   	rst.lis $18
040102             0185   
040102             0186   	; locate x,y
040102             0187   	vdu 31
040102 3E 1F       0001M  		LD	A, function
040104 49 D7       0002M  		RST.LIS	10h
040106             0188   	vdu MENU_X
040106 3E 0D       0001M  		LD	A, function
040108 49 D7       0002M  		RST.LIS	10h
04010A             0189   	vdu MENU2_Y
04010A 3E 0C       0001M  		LD	A, function
04010C 49 D7       0002M  		RST.LIS	10h
04010E             0190   
04010E             0191   	; print text
04010E 21 1D 18 04 0192   	ld hl,menu2
040112 01 00 00 00 0193   	ld bc,0
040116 AF          0194   	xor a
040117 49 DF       0195   	rst.lis $18
040119             0196   
040119             0197   	; locate x,y
040119             0198   	vdu 31
040119 3E 1F       0001M  		LD	A, function
04011B 49 D7       0002M  		RST.LIS	10h
04011D             0199   	vdu MENU_X
04011D 3E 0D       0001M  		LD	A, function
04011F 49 D7       0002M  		RST.LIS	10h
040121             0200   	vdu MENU3_Y
040121 3E 10       0001M  		LD	A, function
040123 49 D7       0002M  		RST.LIS	10h
040125             0201   
040125             0202   	; print text
040125 21 2C 18 04 0203   	ld hl,menu3
040129 01 00 00 00 0204   	ld bc,0
04012D AF          0205   	xor a
04012E 49 DF       0206   	rst.lis $18
040130             0207   
040130             0208   	; locate x,y
040130             0209   	vdu 31
040130 3E 1F       0001M  		LD	A, function
040132 49 D7       0002M  		RST.LIS	10h
040134             0210   	vdu MENU_X
040134 3E 0D       0001M  		LD	A, function
040136 49 D7       0002M  		RST.LIS	10h
040138             0211   	vdu MENU4_Y
040138 3E 14       0001M  		LD	A, function
04013A 49 D7       0002M  		RST.LIS	10h
04013C             0212   
04013C             0213   	; print text
04013C 21 3D 18 04 0214   	ld hl,menu4
040140 01 00 00 00 0215   	ld bc,0
040144 AF          0216   	xor a
040145 49 DF       0217   	rst.lis $18
040147             0218   
040147             0219   ; menu loop
040147             0220   menu_loop:
040147 21 8F FF FF 0221   	ld hl,KEY_ESCAPE
04014B CD 2B 17 04 0222   	call fn_inkey
04014F FE 01       0223   	CP 1
040151 CA 5D 0A 04 0224   	jp z,exit_program
040155             0225   
040155 21 8E FF FF 0226   	ld hl,KEY_F1
040159 CD 2B 17 04 0227   	call fn_inkey
04015D FE 01       0228   	CP 1
04015F CA 91 01 04 0229   	jp z,ml_menu1
040163             0230   
040163 21 8D FF FF 0231   	ld hl,KEY_F2
040167 CD 2B 17 04 0232   	call fn_inkey
04016B FE 01       0233   	CP 1
04016D CA 97 01 04 0234   	jp z,ml_menu2
040171             0235   
040171 21 8C FF FF 0236   	ld hl,KEY_F3
040175 CD 2B 17 04 0237   	call fn_inkey
040179 FE 01       0238   	CP 1
04017B CA 9D 01 04 0239   	jp z,ml_menu3
04017F             0240   
04017F 21 EB FF FF 0241   	ld hl,KEY_F4
040183 CD 2B 17 04 0242   	call fn_inkey
040187 FE 01       0243   	CP 1
040189 CA A3 01 04 0244   	jp z,ml_menu4
04018D             0245   
04018D C3 47 01 04 0246   	jp menu_loop
040191             0247   
040191             0248   ml_menu1:
040191 3E 04       0249   	ld a,SPR44
040193 16 20       0250   	ld d,SPR44_width
040195 18 10       0251   	jr exit_menu_loop
040197             0252   
040197             0253   ml_menu2:
040197 3E 08       0254   	ld a,SPR88
040199 16 10       0255   	ld d,SPR88_width
04019B 18 0A       0256   	jr exit_menu_loop
04019D             0257   
04019D             0258   ml_menu3:
04019D 3E 10       0259   	ld a,SPR1616
04019F 16 08       0260   	ld d,SPR1616_width
0401A1 18 04       0261   	jr exit_menu_loop
0401A3             0262   
0401A3             0263   ml_menu4:
0401A3 3E 20       0264   	ld a,SPR3232
0401A5 16 04       0265   	ld d,SPR3232_width
0401A7             0266   
0401A7             0267   exit_menu_loop:
0401A7             0268   	; store edited sprite size
0401A7 21 03 18 04 0269   	ld hl,spr_size
0401AB 77          0270   	ld (hl),a
0401AC 21 02 18 04 0271   	ld hl,pixel_width
0401B0 72          0272   	ld (hl),d
0401B1             0273   
0401B1             0274   	; clear the text screen
0401B1             0275   	vdu 12
0401B1 3E 0C       0001M  		LD	A, function
0401B3 49 D7       0002M  		RST.LIS	10h
0401B5             0276   
0401B5             0277   	; set colors count to max colors
0401B5 21 23 19 04 0278   	ld hl,colors_count
0401B9 3E 40       0279   	ld a,MAX_COLORS
0401BB 77          0280   	ld (hl),a
0401BC             0281   
0401BC CD 65 17 04 0282   	call fn_draw_the_palette
0401C0             0283   
0401C0             0284   	; store coordinates
0401C0 DD 21 EE 17 0285   	ld ix,x1
       04          
0401C5 21 00 00 00 0286   	ld hl,0
0401C9 DD 75 00    0287   	ld (ix+0),l
0401CC DD 74 01    0288   	ld (ix+1),h
0401CF             0289   
0401CF DD 21 F0 17 0290   	ld ix,y1
       04          
0401D4 21 0B 00 00 0291   	ld hl,11
0401D8 DD 75 00    0292   	ld (ix+0),l
0401DB DD 74 01    0293   	ld (ix+1),h
0401DE             0294   
0401DE DD 21 F2 17 0295   	ld ix,x2
       04          
0401E3 21 3F 01 00 0296   	ld hl,319
0401E7 DD 75 00    0297   	ld (ix+0),l
0401EA DD 74 01    0298   	ld (ix+1),h
0401ED             0299   
0401ED DD 21 F4 17 0300   	ld ix,y2
       04          
0401F2 21 EF 00 00 0301   	ld hl,239
0401F6 DD 75 00    0302   	ld (ix+0),l
0401F9 DD 74 01    0303   	ld (ix+1),h
0401FC             0304   
0401FC             0305   	; draw the border rectangle
0401FC CD 81 0A 04 0306   	call fn_rect
040200             0307   
040200             0308   	; store edited sprite coordinates
040200 DD 21 F6 17 0309   	ld ix,xs1
       04          
040205 FD 21 EE 17 0310   	ld iy,x1
       04          
04020A DD 6E 00    0311   	ld l,(ix+0)
04020D DD 66 01    0312   	ld h,(ix+1)
040210 FD 75 00    0313   	ld (iy+0),l
040213 FD 74 01    0314   	ld (iy+1),h
040216             0315   
040216 DD 21 F8 17 0316   	ld ix,ys1
       04          
04021B FD 21 F0 17 0317   	ld iy,y1
       04          
040220 DD 6E 00    0318   	ld l,(ix+0)
040223 DD 66 01    0319   	ld h,(ix+1)
040226 FD 75 00    0320   	ld (iy+0),l
040229 FD 74 01    0321   	ld (iy+1),h
04022C             0322   
04022C DD 21 FA 17 0323   	ld ix,xs2
       04          
040231 FD 21 F2 17 0324   	ld iy,x2
       04          
040236 DD 6E 00    0325   	ld l,(ix+0)
040239 DD 66 01    0326   	ld h,(ix+1)
04023C FD 75 00    0327   	ld (iy+0),l
04023F FD 74 01    0328   	ld (iy+1),h
040242             0329   
040242 DD 21 FC 17 0330   	ld ix,ys2
       04          
040247 FD 21 F4 17 0331   	ld iy,y2
       04          
04024C DD 6E 00    0332   	ld l,(ix+0)
04024F DD 66 01    0333   	ld h,(ix+1)
040252 FD 75 00    0334   	ld (iy+0),l
040255 FD 74 01    0335   	ld (iy+1),h
040258             0336   
040258             0337   	; draw the sprite's border rectangle
040258 CD 81 0A 04 0338   	call fn_rect
04025C             0339   
04025C             0340   	; update sprite size descriptions
04025C CD C7 16 04 0341   	call fn_show_spr_descr
040260             0342   
040260             0343   ; initialize sprite vars
040260             0344   init_sprite_vars:
040260             0345   	; initialize coordinates before drawing the sprite
040260 DD 21 FE 17 0346   	ld ix,xpix
       04          
040265 AF          0347   	xor a
040266 DD 77 00    0348   	ld (ix+0),a ; xpix = 0
040269 DD 77 01    0349   	ld (ix+1),a	; ypix = 0
04026C DD 21 04 18 0350   	ld ix,current_pen
       04          
040271 3E 0F       0351   	ld a,COLOR_WHITE
040273 DD 77 00    0352   	ld (ix+0),a ; current pen -> white
040276             0353   
040276             0354   	; set vars
040276 21 28 19 04 0355   	ld hl,current_frame
04027A AF          0356   	xor a
04027B 77          0357   	ld (hl),a
04027C 3C          0358   	inc a
04027D 21 29 19 04 0359   	ld hl,frames_count
040281 77          0360   	ld (hl),a
040282             0361   
040282             0362   	; fill buffers with zeros
040282 01 00 20 00 0363   	ld bc,BUFFER_SIZE
040286 21 31 19 04 0364   	ld hl,sprite_buffer
04028A             0365   
04028A             0366   isv_fill_loop:
04028A AF          0367   	xor a
04028B 77          0368   	ld (hl),a
04028C 0B          0369   	dec bc
04028D 23          0370   	inc hl
04028E 78          0371   	ld a,b
04028F B1          0372   	or c
040290 FE 00       0373   	cp 0
040292 20 F6       0374   	jr nz,isv_fill_loop
040294             0375   
040294             0376   ; draw the pixel with a border
040294 CD 0E 0C 04 0377   	call fn_draw_pixel_with_border
040298             0378   
040298             0379   ; draw sprite loop
040298             0380   draw_sprite_loop:
040298 21 9D FF FF 0381   	ld hl,KEY_SPACE
04029C CD 2B 17 04 0382   	call fn_inkey
0402A0 FE 01       0383   	cp 1
0402A2 CC B4 03 04 0384   	call z,dsl_set_pen
0402A6             0385   
0402A6 21 C6 FF FF 0386   	ld hl,KEY_UP
0402AA CD 2B 17 04 0387   	call fn_inkey
0402AE FE 01       0388   	cp 1
0402B0 CC D9 03 04 0389   	call z,dsl_up
0402B4             0390   
0402B4 21 D6 FF FF 0391   	ld hl,KEY_DOWN
0402B8 CD 2B 17 04 0392   	call fn_inkey
0402BC FE 01       0393   	cp 1
0402BE CC 00 04 04 0394   	call z,dsl_down
0402C2             0395   
0402C2 21 E6 FF FF 0396   	ld hl,KEY_LEFT
0402C6 CD 2B 17 04 0397   	call fn_inkey
0402CA FE 01       0398   	cp 1
0402CC CC 2C 04 04 0399   	call z,dsl_left
0402D0             0400   
0402D0 21 86 FF FF 0401   	ld hl,KEY_RIGHT
0402D4 CD 2B 17 04 0402   	call fn_inkey
0402D8 FE 01       0403   	cp 1
0402DA CC 53 04 04 0404   	call z,dsl_right
0402DE             0405   
0402DE 21 A6 FF FF 0406   	ld hl,KEY_DELETE
0402E2 CD 2B 17 04 0407   	call fn_inkey
0402E6 FE 01       0408   	cp 1
0402E8 CC C8 03 04 0409   	call z,dsl_reset_pen
0402EC             0410   
0402EC 21 9F FF FF 0411   	ld hl,KEY_TAB
0402F0 CD 2B 17 04 0412   	call fn_inkey
0402F4 FE 01       0413   	cp 1
0402F6 CA 27 09 04 0414   	jp z,dsl_palette_tool
0402FA             0415   
0402FA 21 AA FF FF 0416   	ld hl,KEY_N
0402FE CD 2B 17 04 0417   	call fn_inkey
040302 FE 01       0418   	cp 1
040304 CC CE 04 04 0419   	call z,dsl_add_frame
040308             0420   
040308 21 AD FF FF 0421   	ld hl,KEY_C
04030C CD 2B 17 04 0422   	call fn_inkey
040310 FE 01       0423   	cp 1
040312 CC 65 05 04 0424   	call z,dsl_add_and_copy_frame
040316             0425   
040316 21 D0 FF FF 0426   	ld hl,KEY_BACKSPACE
04031A CD 2B 17 04 0427   	call fn_inkey
04031E FE 01       0428   	cp 1
040320 CC CC 05 04 0429   	call z,dsl_delete_frame
040324             0430   
040324 21 C0 FF FF 0431   	ld hl,KEY_PGUP
040328 CD 2B 17 04 0432   	call fn_inkey
04032C FE 01       0433   	cp 1
04032E CC C5 06 04 0434   	call z,dsl_next_frame
040332             0435   
040332 21 B1 FF FF 0436   	ld hl,KEY_PGDOWN
040336 CD 2B 17 04 0437   	call fn_inkey
04033A FE 01       0438   	cp 1
04033C CC A6 06 04 0439   	call z,dsl_previous_frame
040340             0440   
040340 21 A9 FF FF 0441   	ld hl,KEY_L
040344 CD 2B 17 04 0442   	call fn_inkey
040348 FE 01       0443   	cp 1
04034A CC 7F 04 04 0444   	call z,dsl_load_sprite
04034E             0445   
04034E 21 AE FF FF 0446   	ld hl,KEY_S
040352 CD 2B 17 04 0447   	call fn_inkey
040356 FE 01       0448   	cp 1
040358 CC 9C 04 04 0449   	call z,dsl_save_sprite
04035C             0450   
04035C 21 DD FF FF 0451   	ld hl,KEY_E
040360 CD 2B 17 04 0452   	call fn_inkey
040364 FE 01       0453   	cp 1
040366 CC B5 04 04 0454   	call z,dsl_export_sprite
04036A             0455   
04036A 21 CC FF FF 0456   	ld hl,KEY_R
04036E CD 2B 17 04 0457   	call fn_inkey
040372 FE 01       0458   	cp 1
040374 CC EB 06 04 0459   	call z,dsl_rotate_frame
040378             0460   
040378 21 BC FF FF 0461   	ld hl,KEY_F
04037C CD 2B 17 04 0462   	call fn_inkey
040380 FE 01       0463   	cp 1
040382 CC A0 07 04 0464   	call z,dsl_flip_frame
040386             0465   
040386 21 9A FF FF 0466   	ld hl,KEY_M
04038A CD 2B 17 04 0467   	call fn_inkey
04038E FE 01       0468   	cp 1
040390 CC 07 08 04 0469   	call z,dsl_mirror_frame
040394             0470   
040394 21 B6 FF FF 0471   	ld hl,KEY_RETURN
040398 CD 2B 17 04 0472   	call fn_inkey
04039C FE 01       0473   	cp 1
04039E CC 87 08 04 0474   	call z,dsl_flood_fill
0403A2             0475   
0403A2 21 8F FF FF 0476   	ld hl,KEY_ESCAPE
0403A6 CD 2B 17 04 0477   	call fn_inkey
0403AA FE 01       0478   	cp 1
0403AC CA 5D 0A 04 0479   	jp z,exit_program
0403B0             0480   
0403B0 C3 98 02 04 0481   	jp draw_sprite_loop
0403B4             0482   
0403B4             0483   ; set the pen of the current pixel
0403B4             0484   dsl_set_pen:
0403B4 CD 38 0C 04 0485   	call fn_get_pixel_color
0403B8 21 04 18 04 0486   	ld hl,current_pen
0403BC BE          0487   	cp (hl)
0403BD C8          0488   	ret z
0403BE 7E          0489   	ld a,(hl)
0403BF CD 7A 0C 04 0490   	call fn_set_pixel_color
0403C3 CD 0E 0C 04 0491   	call fn_draw_pixel_with_border
0403C7 C9          0492   	ret
0403C8             0493   
0403C8             0494   ; reset the pen of the current pixel
0403C8             0495   dsl_reset_pen:
0403C8 CD 38 0C 04 0496   	call fn_get_pixel_color
0403CC FE 00       0497   	cp 0
0403CE C8          0498   	ret z
0403CF AF          0499   	xor a
0403D0 CD 7A 0C 04 0500   	call fn_set_pixel_color
0403D4 CD 0E 0C 04 0501   	call fn_draw_pixel_with_border
0403D8 C9          0502   	ret
0403D9             0503   
0403D9             0504   ; move pixel up
0403D9             0505   dsl_up:
0403D9 21 FF 17 04 0506   	ld hl,ypix
0403DD 7E          0507   	ld a,(hl)
0403DE FE 00       0508   	cp 0
0403E0 C8          0509   	ret z
0403E1             0510   
0403E1 21 9D FF FF 0511   	ld hl,KEY_SPACE
0403E5 CD 2B 17 04 0512   	call fn_inkey
0403E9 FE 01       0513   	cp 1
0403EB CC B4 03 04 0514   	call z,dsl_set_pen
0403EF             0515   
0403EF CD 22 0C 04 0516   	call fn_draw_pixel_without_border
0403F3 CD BE 0C 04 0517   	call fn_move_up
0403F7 CD 0E 0C 04 0518   	call fn_draw_pixel_with_border
0403FB CD A6 16 04 0519   	call fn_slowdown
0403FF C9          0520   	ret
040400             0521   
040400             0522   ; move pixel down
040400             0523   dsl_down:
040400 21 03 18 04 0524   	ld hl,spr_size
040404 56          0525   	ld d,(hl)
040405 15          0526   	dec d
040406             0527   
040406 21 FF 17 04 0528   	ld hl,ypix
04040A 7E          0529   	ld a,(hl)
04040B BA          0530   	cp d
04040C C8          0531   	ret z
04040D             0532   
04040D 21 9D FF FF 0533   	ld hl,KEY_SPACE
040411 CD 2B 17 04 0534   	call fn_inkey
040415 FE 01       0535   	cp 1
040417 CC B4 03 04 0536   	call z,dsl_set_pen
04041B             0537   
04041B CD 22 0C 04 0538   	call fn_draw_pixel_without_border
04041F CD C4 0C 04 0539   	call fn_move_down
040423 CD 0E 0C 04 0540   	call fn_draw_pixel_with_border
040427 CD A6 16 04 0541   	call fn_slowdown
04042B C9          0542   	ret
04042C             0543   
04042C             0544   ; move pixel left
04042C             0545   dsl_left:
04042C 21 FE 17 04 0546   	ld hl,xpix
040430 7E          0547   	ld a,(hl)
040431 FE 00       0548   	cp 0
040433 C8          0549   	ret z
040434             0550   
040434 21 9D FF FF 0551   	ld hl,KEY_SPACE
040438 CD 2B 17 04 0552   	call fn_inkey
04043C FE 01       0553   	cp 1
04043E CC B4 03 04 0554   	call z,dsl_set_pen
040442             0555   
040442 CD 22 0C 04 0556   	call fn_draw_pixel_without_border
040446 CD CA 0C 04 0557   	call fn_move_left
04044A CD 0E 0C 04 0558   	call fn_draw_pixel_with_border
04044E CD A6 16 04 0559   	call fn_slowdown
040452 C9          0560   	ret
040453             0561   
040453             0562   ; move pixel right
040453             0563   dsl_right:
040453 21 03 18 04 0564   	ld hl,spr_size
040457 56          0565   	ld d,(hl)
040458 15          0566   	dec d
040459             0567   
040459 21 FE 17 04 0568   	ld hl,xpix
04045D 7E          0569   	ld a,(hl)
04045E BA          0570   	cp d
04045F C8          0571   	ret z
040460             0572   
040460 21 9D FF FF 0573   	ld hl,KEY_SPACE
040464 CD 2B 17 04 0574   	call fn_inkey
040468 FE 01       0575   	cp 1
04046A CC B4 03 04 0576   	call z,dsl_set_pen
04046E             0577   
04046E CD 22 0C 04 0578   	call fn_draw_pixel_without_border
040472 CD D0 0C 04 0579   	call fn_move_right
040476 CD 0E 0C 04 0580   	call fn_draw_pixel_with_border
04047A CD A6 16 04 0581   	call fn_slowdown
04047E C9          0582   	ret
04047F             0583   
04047F             0584   ; load a sprite
04047F             0585   dsl_load_sprite:
04047F 21 A9 FF FF 0586   	ld hl,KEY_L
040483 CD 2B 17 04 0587   	call fn_inkey
040487 FE 00       0588   	cp 0
040489 20 F4       0589   	jr nz,dsl_load_sprite
04048B             0590   
04048B CD 22 0C 04 0591   	call fn_draw_pixel_without_border
04048F CD C0 11 04 0592   	call fn_load_sprite
040493 CD 1D 16 04 0593   	call fn_refresh_sprite
040497 CD 0E 0C 04 0594   	call fn_draw_pixel_with_border
04049B C9          0595   	ret
04049C             0596   
04049C             0597   ; save a sprite
04049C             0598   dsl_save_sprite:
04049C 21 AE FF FF 0599   	ld hl,KEY_S
0404A0 CD 2B 17 04 0600   	call fn_inkey
0404A4 FE 00       0601   	cp 0
0404A6 20 F4       0602   	jr nz,dsl_save_sprite
0404A8             0603   
0404A8 CD 22 0C 04 0604   	call fn_draw_pixel_without_border
0404AC CD EF 12 04 0605   	call fn_save_sprite
0404B0 CD 1D 16 04 0606   	call fn_refresh_sprite
0404B4 C9          0607   	ret
0404B5             0608   
0404B5             0609   dsl_export_sprite:
0404B5 21 DD FF FF 0610   	ld hl,KEY_E
0404B9 CD 2B 17 04 0611   	call fn_inkey
0404BD FE 00       0612   	cp 0
0404BF 20 F4       0613   	jr nz,dsl_export_sprite
0404C1             0614   
0404C1 CD 22 0C 04 0615   	call fn_draw_pixel_without_border
0404C5 CD FA 13 04 0616   	call fn_export_sprite
0404C9 CD 1D 16 04 0617   	call fn_refresh_sprite
0404CD C9          0618   	ret
0404CE             0619   
0404CE             0620   
0404CE             0621   ; add a frame to the animation
0404CE             0622   dsl_add_frame:
0404CE 21 AA FF FF 0623   	ld hl,KEY_N
0404D2 CD 2B 17 04 0624   	call fn_inkey
0404D6 FE 00       0625   	cp 0
0404D8 20 F4       0626   	jr nz,dsl_add_frame
0404DA             0627   
0404DA             0628   	; frames limit reached ? exit
0404DA 21 29 19 04 0629   	ld hl,frames_count
0404DE 7E          0630   	ld a,(hl)
0404DF FE 08       0631   	cp MAX_FRAMES
0404E1 C8          0632   	ret z
0404E2             0633   
0404E2             0634   	; get the number of frames to copy
0404E2 21 29 19 04 0635   	ld hl,frames_count
0404E6 7E          0636   	ld a,(hl)
0404E7 21 28 19 04 0637   	ld hl,current_frame
0404EB 46          0638   	ld b,(hl)
0404EC 90          0639   	sub b
0404ED 3D          0640   	dec a
0404EE             0641   
0404EE             0642   	; get sprsize² (length of a sprite, in bytes)
0404EE 21 03 18 04 0643   	ld hl,spr_size
0404F2 11 00 00 00 0644   	ld de,$000000
0404F6 5E          0645   	ld e,(hl)
0404F7 56          0646   	ld d,(hl)
0404F8 ED 5C       0647   	mlt de ; DE = sprsize²
0404FA             0648   
0404FA             0649   	; prepare for the case we goto af_zap...
0404FA 21 31 19 04 0650   	ld hl,sprite_buffer
0404FE             0651   
0404FE F5          0652   	push af
0404FF E5          0653   	push hl
040500 21 28 19 04 0654   	ld hl,current_frame
040504 7E          0655   	ld a,(hl)
040505 3C          0656   	inc a
040506 47          0657   	ld b,a
040507 E1          0658   	pop hl
040508 F1          0659   	pop af
040509             0660   
040509             0661   af_loop0:
040509 19          0662   	add hl,de ; for if current frame = 0 (prepare to zap!)
04050A 10 FD       0663   	djnz af_loop0
04050C             0664   
04050C E5          0665   	push hl ; store HL = sprite buffer + sprsize²
04050D FE 00       0666   	cp 0
04050F CA 37 05 04 0667   	jp z,af_zap ; zap the copy, if the 'current frame' is at the last frame
040513 E1          0668   	pop hl ; HL unused in this case
040514             0669   
040514 21 00 00 00 0670   	ld hl,$000000 ; HL is 0 to store the result
040518 47          0671   	ld b,a ; B = frames to copy
040519             0672   
040519             0673   ; multiply number of frames to copy by sprsize²
040519             0674   af_loop1:
040519 19          0675   	add hl,de ; HL = length (in bytes) to copy (a few frames)
04051A 10 FD       0676   	djnz af_loop1
04051C             0677   
04051C E5          0678   	push hl
04051D C1          0679   	pop bc ; BC = HL = length (in bytes) to copy (a few frames)
04051E             0680   
04051E 21 28 19 04 0681   	ld hl,current_frame
040522 7E          0682   	ld a,(hl)
040523 3C          0683   	inc a
040524 21 31 19 04 0684   	ld hl,sprite_buffer
040528             0685   
040528 C5          0686   	push bc
040529 47          0687   	ld b,a
04052A             0688   
04052A             0689   af_loop2:
04052A 19          0690   	add hl,de ; HL = sprite buffer + length to copy
04052B 10 FD       0691   	djnz af_loop2
04052D             0692   
04052D C1          0693   	pop bc
04052E             0694   
04052E E5          0695   	push hl ; HL = sprite_buffer + (current frame * sprsize²)
04052F             0696   
04052F 09          0697   	add hl,bc
040530 2B          0698   	dec hl ; HL = end address to copy to end target address
040531             0699   
040531 E5          0700   	push hl
040532 19          0701   	add hl,de
040533 EB          0702   	ex de,hl ; DE = end target address
040534 E1          0703   	pop hl
040535             0704   
040535 ED B8       0705   	lddr
040537             0706   
040537             0707   af_zap:
040537             0708   	; multiply number of frames to copy by sprsize²
040537 21 03 18 04 0709   	ld hl,spr_size
04053B 01 00 00 00 0710   	ld bc,$000000
04053F 4E          0711   	ld c,(hl)
040540 46          0712   	ld b,(hl)
040541 ED 4C       0713   	mlt bc ; BC = sprsize²
040543             0714   
040543 E1          0715   	pop hl ; HL = sprite_buffer + (current frame * sprsize²)
040544             0716   
040544             0717   ; fill frame with 0 color
040544             0718   af_loop3:
040544 AF          0719   	xor a
040545 77          0720   	ld (hl),a
040546 23          0721   	inc hl
040547 0B          0722   	dec bc
040548 78          0723   	ld a,b
040549 B1          0724   	or c
04054A FE 00       0725   	cp 0
04054C 20 F6       0726   	jr nz,af_loop3
04054E             0727   
04054E             0728   	; increment the frames count and the current frame values
04054E 21 29 19 04 0729   	ld hl,frames_count
040552 34          0730   	inc (hl)
040553 21 28 19 04 0731   	ld hl,current_frame
040557 34          0732   	inc (hl)
040558             0733   
040558 CD 5D 16 04 0734   	call fn_change_frame
04055C CD 82 16 04 0735   	call fn_change_frames_count
040560 CD 1D 16 04 0736   	call fn_refresh_sprite
040564 C9          0737   	ret
040565             0738   
040565             0739   ; add a copy of the current frame to the animation
040565             0740   dsl_add_and_copy_frame: ; TODO! debug me!
040565 21 AD FF FF 0741   	ld hl,KEY_C
040569 CD 2B 17 04 0742   	call fn_inkey
04056D FE 00       0743   	cp 0
04056F 20 F4       0744   	jr nz,dsl_add_and_copy_frame
040571             0745   
040571             0746   	; frames limit reached ? exit
040571 21 29 19 04 0747   	ld hl,frames_count
040575 7E          0748   	ld a,(hl)
040576 FE 08       0749   	cp MAX_FRAMES
040578 C8          0750   	ret z
040579             0751   
040579             0752   	; get the number of frames to copy
040579 21 29 19 04 0753   	ld hl,frames_count
04057D 7E          0754   	ld a,(hl)
04057E 21 28 19 04 0755   	ld hl,current_frame
040582 46          0756   	ld b,(hl)
040583 90          0757   	sub b
040584             0758   
040584             0759   	; get sprsize² (length of a sprite, in bytes)
040584 21 03 18 04 0760   	ld hl,spr_size
040588 11 00 00 00 0761   	ld de,$000000
04058C 5E          0762   	ld e,(hl)
04058D 56          0763   	ld d,(hl)
04058E ED 5C       0764   	mlt de ; DE = sprsize²
040590             0765   
040590 21 00 00 00 0766   	ld hl,$000000 ; HL is 0 to store the result
040594 47          0767   	ld b,a ; B = frames to copy
040595             0768   
040595             0769   ; multiply number of frames to copy by sprsize²
040595             0770   aacf_loop1:
040595 19          0771   	add hl,de ; HL = length (in bytes) to copy (a few frames)
040596 10 FD       0772   	djnz aacf_loop1
040598             0773   
040598 E5          0774   	push hl
040599 C1          0775   	pop bc ; BC = HL = length (in bytes) to copy (a few frames)
04059A             0776   
04059A 21 28 19 04 0777   	ld hl,current_frame
04059E 7E          0778   	ld a,(hl)
04059F 21 31 19 04 0779   	ld hl,sprite_buffer
0405A3 FE 00       0780   	cp 0
0405A5 28 06       0781   	jr z,aacf_loop_end2
0405A7             0782   
0405A7 C5          0783   	push bc
0405A8 47          0784   	ld b,a
0405A9             0785   
0405A9             0786   aacf_loop2:
0405A9 19          0787   	add hl,de ; HL = sprite buffer + length to copy
0405AA 10 FD       0788   	djnz aacf_loop2
0405AC             0789   
0405AC C1          0790   	pop bc
0405AD             0791   
0405AD             0792   aacf_loop_end2:
0405AD 09          0793   	add hl,bc
0405AE 2B          0794   	dec hl ; HL = end address to copy to end target address
0405AF             0795   
0405AF E5          0796   	push hl
0405B0 19          0797   	add hl,de
0405B1 EB          0798   	ex de,hl ; DE = end target address
0405B2 E1          0799   	pop hl
0405B3             0800   
0405B3 ED B8       0801   	lddr
0405B5             0802   
0405B5             0803   	; increment the frames count and the current frame values
0405B5 21 29 19 04 0804   	ld hl,frames_count
0405B9 34          0805   	inc (hl)
0405BA 21 28 19 04 0806   	ld hl,current_frame
0405BE 34          0807   	inc (hl)
0405BF             0808   
0405BF CD 5D 16 04 0809   	call fn_change_frame
0405C3 CD 82 16 04 0810   	call fn_change_frames_count
0405C7 CD 1D 16 04 0811   	call fn_refresh_sprite
0405CB C9          0812   	ret
0405CC             0813   
0405CC             0814   ; delete last frame from animation
0405CC             0815   dsl_delete_frame:
0405CC 21 D0 FF FF 0816   	ld hl,KEY_BACKSPACE
0405D0 CD 2B 17 04 0817   	call fn_inkey
0405D4 FE 00       0818   	cp 0
0405D6 20 F4       0819   	jr nz,dsl_delete_frame
0405D8             0820   
0405D8             0821   	; delete current selected frame
0405D8 21 03 18 04 0822   	ld hl,spr_size
0405DC 01 00 00 00 0823   	ld bc,$000000
0405E0 4E          0824   	ld c,(hl)
0405E1 46          0825   	ld b,(hl)
0405E2 ED 4C       0826   	mlt bc ; BC = sprsize²
0405E4 21 28 19 04 0827   	ld hl,current_frame
0405E8 7E          0828   	ld a,(hl) ; A = current frame
0405E9 21 31 19 04 0829   	ld hl,sprite_buffer ; HL = sprite buffer
0405ED C5          0830   	push bc
0405EE FE 00       0831   	cp 0
0405F0 28 06       0832   	jr z,df_loop2
0405F2             0833   
0405F2             0834   df_loop1:
0405F2 09          0835   	add hl,bc ; HL = sprite buffer + (current frame * sprsize²)
0405F3 3D          0836   	dec a
0405F4 FE 00       0837   	cp 0
0405F6 20 FA       0838   	jr nz,df_loop1
0405F8             0839   
0405F8             0840   ; clear the current frame
0405F8             0841   df_loop2:
0405F8 AF          0842   	xor a
0405F9 77          0843   	ld (hl),a
0405FA 23          0844   	inc hl
0405FB 0B          0845   	dec bc
0405FC 78          0846   	ld a,b
0405FD B1          0847   	or c
0405FE FE 00       0848   	cp 0
040600 20 F6       0849   	jr nz,df_loop2
040602             0850   
040602             0851   	; current frame + 1 = frames count ?
040602 E5          0852   	push hl
040603 21 28 19 04 0853   	ld hl,current_frame
040607 5E          0854   	ld e,(hl)
040608 1C          0855   	inc e
040609 21 29 19 04 0856   	ld hl,frames_count
04060D 7E          0857   	ld a,(hl)
04060E BB          0858   	cp e
04060F E1          0859   	pop hl
040610 C1          0860   	pop bc
040611 CA 8A 06 04 0861   	jp z,df_exit
040615             0862   
040615 11 29 19 04 0863   	ld de,frames_count
040619 1A          0864   	ld a,(de) ; A = frames count
04061A E5          0865   	push hl
04061B 21 28 19 04 0866   	ld hl,current_frame
04061F 5E          0867   	ld e,(hl) ; E = current frame
040620 E1          0868   	pop hl
040621 93          0869   	sub e
040622 3D          0870   	dec a ; A = number of frames to copy back
040623             0871   
040623 EB          0872   	ex de,hl ; DE = sprite buffer + ((current frame + 1) * sprsize²)
040624 21 00 00 00 0873   	ld hl,$000000
040628 FE 00       0874   	cp 0 ; 0 frames to copy ?
04062A 28 06       0875   	jr z,df_exit_loop3
04062C             0876   
04062C             0877   df_loop3:
04062C 09          0878   	add hl,bc ; HL = length of a frame (sprsize²) * frames count
04062D 3D          0879   	dec a
04062E FE 00       0880   	cp 0
040630 20 FA       0881   	jr nz,df_loop3
040632             0882   
040632             0883   df_exit_loop3:
040632 E5          0884   	push hl
040633 C1          0885   	pop bc ; BC = total length of area to copy
040634 D5          0886   	push de
040635 E1          0887   	pop hl ; HL = DE = start of area to copy
040636             0888   
040636 C5          0889   	push bc
040637 D5          0890   	push de
040638 E5          0891   	push hl
040639 21 03 18 04 0892   	ld hl,spr_size
04063D 11 00 00 00 0893   	ld de,$000000
040641 5E          0894   	ld e,(hl)
040642 56          0895   	ld d,(hl)
040643 ED 5C       0896   	mlt de ; DE = one sprite frame length
040645 E1          0897   	pop hl
040646 B7          0898   	or a
040647 ED 52       0899   	sbc hl,de ; HL = target area to copy
040649 D1          0900   	pop de
04064A EB          0901   	ex de,hl ; DE = target, HL = start
04064B C1          0902   	pop bc
04064C ED B0       0903   	ldir
04064E             0904   
04064E 21 03 18 04 0905   	ld hl,spr_size
040652 01 00 00 00 0906   	ld bc,$000000
040656 4E          0907   	ld c,(hl)
040657 46          0908   	ld b,(hl)
040658 ED 4C       0909   	mlt bc ; DE = one sprite frame length
04065A             0910   
04065A             0911   	; delete last frame data
04065A 21 29 19 04 0912   	ld hl,frames_count
04065E 7E          0913   	ld a,(hl) ; A =frames count
04065F 3D          0914   	dec a ; A = last frame
040660 21 31 19 04 0915   	ld hl,sprite_buffer ; HL = sprite buffer
040664 FE 00       0916   	cp 0
040666 28 06       0917   	jr z,df_loop5
040668             0918   
040668             0919   df_loop4:
040668 09          0920   	add hl,bc ; HL = sprite buffer + (last frame * sprsize²)
040669 3D          0921   	dec a
04066A FE 00       0922   	cp 0
04066C 20 FA       0923   	jr nz,df_loop4
04066E             0924   
04066E             0925   ; clear the current frame
04066E             0926   df_loop5:
04066E AF          0927   	xor a
04066F 77          0928   	ld (hl),a
040670 23          0929   	inc hl
040671 0B          0930   	dec bc
040672 78          0931   	ld a,b
040673 B1          0932   	or c
040674 FE 00       0933   	cp 0
040676 20 F6       0934   	jr nz,df_loop5
040678             0935   
040678             0936   	; decrement frames count
040678 21 29 19 04 0937   	ld hl,frames_count
04067C 35          0938   	dec (hl)
04067D             0939   
04067D CD 5D 16 04 0940   	call fn_change_frame
040681 CD 82 16 04 0941   	call fn_change_frames_count
040685 CD 1D 16 04 0942   	call fn_refresh_sprite
040689 C9          0943   	ret
04068A             0944   
04068A             0945   df_exit:
04068A 21 29 19 04 0946   	ld hl,frames_count
04068E 7E          0947   	ld a,(hl)
04068F FE 01       0948   	cp 1
040691 28 06       0949   	jr z,df_exit_end
040693 35          0950   	dec (hl)
040694 21 28 19 04 0951   	ld hl,current_frame
040698 35          0952   	dec (hl)
040699             0953   
040699             0954   df_exit_end:
040699 CD 5D 16 04 0955   	call fn_change_frame
04069D CD 82 16 04 0956   	call fn_change_frames_count
0406A1 CD 1D 16 04 0957   	call fn_refresh_sprite
0406A5 C9          0958   	ret
0406A6             0959   
0406A6             0960   ; goto previous frame
0406A6             0961   dsl_previous_frame:
0406A6 21 B1 FF FF 0962   	ld hl,KEY_PGDOWN
0406AA CD 2B 17 04 0963   	call fn_inkey
0406AE FE 00       0964   	cp 0
0406B0 20 F4       0965   	jr nz,dsl_previous_frame
0406B2             0966   
0406B2 21 28 19 04 0967   	ld hl,current_frame
0406B6 7E          0968   	ld a,(hl)
0406B7 FE 00       0969   	cp 0
0406B9 C8          0970   	ret z
0406BA             0971   
0406BA 3D          0972   	dec a
0406BB 77          0973   	ld (hl),a
0406BC CD 5D 16 04 0974   	call fn_change_frame
0406C0 CD 1D 16 04 0975   	call fn_refresh_sprite
0406C4 C9          0976   	ret
0406C5             0977   
0406C5             0978   ; goto next frame
0406C5             0979   dsl_next_frame:
0406C5 21 C0 FF FF 0980   	ld hl,KEY_PGUP
0406C9 CD 2B 17 04 0981   	call fn_inkey
0406CD FE 00       0982   	cp 0
0406CF 20 F4       0983   	jr nz,dsl_next_frame
0406D1             0984   
0406D1 21 28 19 04 0985   	ld hl,current_frame
0406D5 7E          0986   	ld a,(hl)
0406D6 3C          0987   	inc a
0406D7 21 29 19 04 0988   	ld hl,frames_count
0406DB BE          0989   	cp (hl)
0406DC C8          0990   	ret z
0406DD             0991   
0406DD 21 28 19 04 0992   	ld hl,current_frame
0406E1 77          0993   	ld (hl),a
0406E2 CD 5D 16 04 0994   	call fn_change_frame
0406E6 CD 1D 16 04 0995   	call fn_refresh_sprite
0406EA C9          0996   	ret
0406EB             0997   
0406EB             0998   ; rotate a frame 90° clockwise
0406EB             0999   dsl_rotate_frame:
0406EB 21 CC FF FF 1000   	ld hl,KEY_R
0406EF CD 2B 17 04 1001   	call fn_inkey
0406F3 FE 00       1002   	cp 0
0406F5 20 F4       1003   	jr nz,dsl_rotate_frame
0406F7             1004   
0406F7             1005   	; find HL as start of the first frame (buffer)
0406F7 21 03 18 04 1006   	ld hl,spr_size
0406FB 01 00 00 00 1007   	ld bc,$000000
0406FF 11 00 00 00 1008   	ld de,$000000
040703 5E          1009   	ld e,(hl)
040704 56          1010   	ld d,(hl)
040705 4B          1011   	ld c,e
040706 ED 5C       1012   	mlt de ; DE = sprite length in bytes
040708 21 28 19 04 1013   	ld hl,current_frame
04070C 7E          1014   	ld a,(hl) ; A = current frame
04070D 21 31 19 04 1015   	ld hl,sprite_buffer
040711 FE 00       1016   	cp 0
040713 28 04       1017   	jr z,rf_noloop1
040715 47          1018   	ld b,a
040716             1019   
040716             1020   rf_loop1:
040716 19          1021   	add hl,de ; HL = sprite_buffer + (current frame * sprsize²)
040717 10 FD       1022   	djnz rf_loop1
040719             1023   
040719             1024   rf_noloop1:
040719 C5          1025   	push bc
04071A E5          1026   	push hl
04071B             1027   
04071B             1028   	; copy current frame to swap sprite buffer
04071B 11 9D 3C 04 1029   	ld de,swap_sprite_buffer
04071F 41          1030   	ld b,c
040720 ED 4C       1031   	mlt bc
040722 ED B0       1032   	ldir
040724             1033   
040724 FD E1       1034   	pop iy ; IY: destination
040726 C1          1035   	pop bc
040727             1036   
040727 79          1037   	ld a,c
040728 01 00 00 00 1038   	ld bc,$000000
04072C 4F          1039   	ld c,a ; BC = sprite size
04072D             1040   
04072D             1041   	; turn and copy swap sprite buffer frame to sprite buffer
04072D DD 21 9D 3C 1042   	ld ix,swap_sprite_buffer ; IX: source
       04          
040732 11 00 00 00 1043   	ld de,0 ; x
040736 21 00 00 00 1044   	ld hl,0 ; y
04073A             1045   
04073A             1046   rf_loop2:
04073A DD E5       1047   	push ix
04073C FD E5       1048   	push iy
04073E             1049   
04073E D5          1050   	push de
04073F E5          1051   	push hl
040740             1052   
040740             1053   	; add x
040740 DD 19       1054   	add ix,de
040742             1055   
040742             1056   	; add y * width
040742 7C          1057   	ld a,h
040743 B5          1058   	or l
040744 FE 00       1059   	cp 0
040746 28 09       1060   	jr z,rf_done1
040748             1061   rf_loop3:
040748 DD 09       1062   	add ix,bc
04074A 2B          1063   	dec hl
04074B 7C          1064   	ld a,h
04074C B5          1065   	or l
04074D FE 00       1066   	cp 0
04074F 20 F7       1067   	jr nz,rf_loop3
040751             1068   
040751             1069   rf_done1:
040751             1070   	; found the pixel value
040751 DD 7E 00    1071   	ld a,(ix+0)
040754             1072   
040754 E1          1073   	pop hl
040755 D1          1074   	pop de
040756 D5          1075   	push de
040757 E5          1076   	push hl
040758             1077   
040758             1078   	; add y
040758 EB          1079   	ex de,hl
040759 FD 09       1080   	add iy,bc
04075B B7          1081   	or a
04075C E5          1082   	push hl
04075D FD E5       1083   	push iy
04075F E1          1084   	pop hl
040760 ED 52       1085   	sbc hl,de
040762 E5          1086   	push hl
040763 FD E1       1087   	pop iy
040765 FD 2B       1088   	dec iy
040767 E1          1089   	pop hl
040768 EB          1090   	ex de,hl
040769             1091   
040769             1092   	; add x * width
040769 F5          1093   	push af
04076A 7A          1094   	ld a,d
04076B B3          1095   	or e
04076C FE 00       1096   	cp 0
04076E 28 09       1097   	jr z,rf_done2
040770             1098   rf_loop5:
040770 FD 09       1099   	add iy,bc
040772 1B          1100   	dec de
040773 7A          1101   	ld a,d
040774 B3          1102   	or e
040775 FE 00       1103   	cp 0
040777 20 F7       1104   	jr nz,rf_loop5
040779             1105   
040779             1106   rf_done2:
040779 F1          1107   	pop af
04077A             1108   
04077A             1109   	; store the pixel value
04077A FD 77 00    1110   	ld (iy+0),a
04077D             1111   
04077D E1          1112   	pop hl
04077E D1          1113   	pop de
04077F             1114   
04077F FD E1       1115   	pop iy
040781 DD E1       1116   	pop ix
040783             1117   
040783 13          1118   	inc de
040784 EB          1119   	ex de,hl
040785 B7          1120   	or a
040786 ED 42       1121   	sbc hl,bc
040788 09          1122   	add hl,bc
040789 EB          1123   	ex de,hl
04078A DA 3A 07 04 1124   	jp c,rf_loop2
04078E             1125   
04078E 11 00 00 00 1126   	ld de,0
040792 23          1127   	inc hl
040793 B7          1128   	or a
040794 ED 42       1129   	sbc hl,bc
040796 09          1130   	add hl,bc
040797 DA 3A 07 04 1131   	jp c,rf_loop2
04079B             1132   
04079B CD 1D 16 04 1133   	call fn_refresh_sprite
04079F C9          1134   	ret
0407A0             1135   
0407A0             1136   ; flip frame horizontally
0407A0             1137   dsl_flip_frame:
0407A0 21 BC FF FF 1138   	ld hl,KEY_F
0407A4 CD 2B 17 04 1139   	call fn_inkey
0407A8 FE 00       1140   	cp 0
0407AA 20 F4       1141   	jr nz,dsl_flip_frame
0407AC             1142   
0407AC 21 03 18 04 1143   	ld hl,spr_size
0407B0 11 00 00 00 1144   	ld de,$000000
0407B4 5E          1145   	ld e,(hl)
0407B5 56          1146   	ld d,(hl)
0407B6 4B          1147   	ld c,e
0407B7 ED 5C       1148   	mlt de ; DE = sprite length in bytes
0407B9 21 28 19 04 1149   	ld hl,current_frame
0407BD 7E          1150   	ld a,(hl) ; A = current frame
0407BE 21 31 19 04 1151   	ld hl,sprite_buffer
0407C2 FE 00       1152   	cp 0
0407C4 28 04       1153   	jr z,ff_noloop1
0407C6 47          1154   	ld b,a
0407C7             1155   
0407C7             1156   ff_loop1:
0407C7 19          1157   	add hl,de ; HL = sprite_buffer + (current frame * sprsize²)
0407C8 10 FD       1158   	djnz ff_loop1
0407CA             1159   
0407CA             1160   ff_noloop1:
0407CA 41          1161   	ld b,c ; B = sprite height
0407CB 11 00 00 00 1162   	ld de,$000000
0407CF 59          1163   	ld e,c ; DE = sprite width
0407D0 79          1164   	ld a,c ; A = sprite width
0407D1 CB 3F       1165   	srl a ; A = sprite height / 2
0407D3             1166   
0407D3 E5          1167   	push hl
0407D4 DD E1       1168   	pop ix ; IX = frame address
0407D6 19          1169   	add hl,de ; HL = frame address + sprite width - 1
0407D7 2B          1170   	dec hl
0407D8 E5          1171   	push hl
0407D9 FD E1       1172   	pop iy ; IY = IX + sprite width - 1
0407DB             1173   
0407DB             1174   ff_loop2:
0407DB F5          1175   	push af
0407DC D5          1176   	push de
0407DD DD E5       1177   	push ix
0407DF FD E5       1178   	push iy
0407E1             1179   ff_loop3:
0407E1 DD 5E 00    1180   	ld e,(ix+0)
0407E4 FD 56 00    1181   	ld d,(iy+0)
0407E7 DD 72 00    1182   	ld (ix+0),d
0407EA FD 73 00    1183   	ld (iy+0),e
0407ED DD 23       1184   	inc ix
0407EF FD 2B       1185   	dec iy
0407F1 3D          1186   	dec a
0407F2 FE 00       1187   	cp 0
0407F4 20 EB       1188   	jr nz,ff_loop3
0407F6 FD E1       1189   	pop iy
0407F8 DD E1       1190   	pop ix
0407FA D1          1191   	pop de
0407FB F1          1192   	pop af
0407FC DD 19       1193   	add ix,de
0407FE FD 19       1194   	add iy,de
040800 10 D9       1195   	djnz ff_loop2
040802             1196   
040802 CD 1D 16 04 1197   	call fn_refresh_sprite
040806 C9          1198   	ret
040807             1199   
040807             1200   ; mirror frame vertically
040807             1201   dsl_mirror_frame:
040807 21 9A FF FF 1202   	ld hl,KEY_M
04080B CD 2B 17 04 1203   	call fn_inkey
04080F FE 00       1204   	cp 0
040811 20 F4       1205   	jr nz,dsl_mirror_frame
040813             1206   
040813 21 03 18 04 1207   	ld hl,spr_size
040817 01 00 00 00 1208   	ld bc,$000000
04081B 11 00 00 00 1209   	ld de,$000000
04081F 5E          1210   	ld e,(hl)
040820 56          1211   	ld d,(hl)
040821 4B          1212   	ld c,e
040822 ED 5C       1213   	mlt de ; DE = sprite length in bytes
040824 21 28 19 04 1214   	ld hl,current_frame
040828 7E          1215   	ld a,(hl) ; A = current frame
040829 21 31 19 04 1216   	ld hl,sprite_buffer
04082D FE 00       1217   	cp 0
04082F 28 04       1218   	jr z,mf_noloop1
040831 47          1219   	ld b,a
040832             1220   
040832             1221   mf_loop1:
040832 19          1222   	add hl,de ; HL = sprite_buffer + (current frame * sprsize²)
040833 10 FD       1223   	djnz mf_loop1
040835             1224   
040835             1225   mf_noloop1:
040835 11 00 00 00 1226   	ld de,$000000
040839 59          1227   	ld e,c ; E = sprite height
04083A 79          1228   	ld a,c ; A = sprite width
04083B 41          1229   	ld b,c ; B = sprite height
04083C CB 38       1230   	srl b ; divide B by 2, so B = sprite height / 2
04083E             1231   
04083E E5          1232   	push hl
04083F DD E1       1233   	pop ix ; IX = frame address
040841 51          1234   	ld d,c
040842 15          1235   	dec d
040843 ED 5C       1236   	mlt de ; DE = sprite length - sprite width
040845 19          1237   	add hl,de ; HL = frame address + sprite length - sprite width
040846 E5          1238   	push hl
040847 FD E1       1239   	pop iy ; IY = IX + sprite length - sprite width
040849 21 00 00 00 1240   	ld hl,$000000
04084D 69          1241   	ld l,c ; HL = sprite width
04084E             1242   
04084E             1243   mf_loop2:
04084E F5          1244   	push af
04084F D5          1245   	push de
040850 DD E5       1246   	push ix
040852 FD E5       1247   	push iy
040854             1248   mf_loop3:
040854 DD 5E 00    1249   	ld e,(ix+0)
040857 FD 56 00    1250   	ld d,(iy+0)
04085A DD 72 00    1251   	ld (ix+0),d
04085D FD 73 00    1252   	ld (iy+0),e
040860 DD 23       1253   	inc ix
040862 FD 23       1254   	inc iy
040864 3D          1255   	dec a
040865 FE 00       1256   	cp 0
040867 20 EB       1257   	jr nz,mf_loop3
040869 FD E1       1258   	pop iy
04086B DD E1       1259   	pop ix
04086D D1          1260   	pop de
04086E F1          1261   	pop af
04086F EB          1262   	ex de,hl
040870 DD 19       1263   	add ix,de
040872 EB          1264   	ex de,hl
040873 E5          1265   	push hl
040874 FD E5       1266   	push iy
040876 E1          1267   	pop hl
040877 D1          1268   	pop de
040878 B7          1269   	or a
040879 ED 52       1270   	sbc hl,de
04087B E5          1271   	push hl
04087C D5          1272   	push de
04087D E1          1273   	pop hl
04087E FD E1       1274   	pop iy
040880 10 CC       1275   	djnz mf_loop2
040882             1276   
040882 CD 1D 16 04 1277   	call fn_refresh_sprite
040886 C9          1278   	ret
040887             1279   
040887             1280   dsl_flood_fill:
040887 21 B6 FF FF 1281   	ld hl,KEY_RETURN
04088B CD 2B 17 04 1282   	call fn_inkey
04088F FE 00       1283   	cp 0
040891 20 F4       1284   	jr nz,dsl_flood_fill
040893             1285   
040893             1286   	; hide the cursor
040893 CD 22 0C 04 1287   	call fn_draw_pixel_without_border
040897             1288   
040897             1289   	; memorize pixel coordinates
040897 3A FE 17 04 1290   	ld a,(xpix)
04089B 32 00 18 04 1291   	ld (memxpix),a
04089F 3A FF 17 04 1292   	ld a,(ypix)
0408A3 32 01 18 04 1293   	ld (memypix),a
0408A7             1294   
0408A7             1295   	; fill all recursively
0408A7 3A FE 17 04 1296   	ld a,(xpix)
0408AB 5F          1297   	ld e,a
0408AC 3A FF 17 04 1298   	ld a,(ypix)
0408B0 57          1299   	ld d,a
0408B1 CD D2 08 04 1300   	call dsl_flood_fill_loop
0408B5             1301   
0408B5             1302   	; refresh all the sprite
0408B5 CD 1D 16 04 1303   	call fn_refresh_sprite
0408B9             1304   
0408B9             1305   	; hide the cursor again
0408B9 CD 22 0C 04 1306   	call fn_draw_pixel_without_border
0408BD             1307   
0408BD             1308   	; restore pixel coordinates
0408BD             1309   	; and cursor
0408BD 3A 00 18 04 1310   	ld a,(memxpix)
0408C1 32 FE 17 04 1311   	ld (xpix),a
0408C5 3A 01 18 04 1312   	ld a,(memypix)
0408C9 32 FF 17 04 1313   	ld (ypix),a
0408CD CD 0E 0C 04 1314   	call fn_draw_pixel_with_border
0408D1 C9          1315   	ret
0408D2             1316   
0408D2             1317   dsl_flood_fill_loop:
0408D2 D5          1318   	push de
0408D3             1319   
0408D3 DD 21 03 18 1320   	ld ix,spr_size
       04          
0408D8             1321   
0408D8             1322   	; out  of the sprite area ?
0408D8 7B          1323   	ld a,e
0408D9 DD BE 00    1324   	cp (ix+0)
0408DC D2 25 09 04 1325   	jp nc,ffl_exit
0408E0             1326   
0408E0             1327   	; out  of the sprite area ?
0408E0 7A          1328   	ld a,d
0408E1 DD BE 00    1329   	cp (ix+0)
0408E4 D2 25 09 04 1330   	jp nc,ffl_exit
0408E8             1331   
0408E8             1332   	; replace current pixel, if it is
0408E8             1333   	; inside the sprite area,
0408E8             1334   	; and has not the select palette color
0408E8 7B          1335   	ld a,e
0408E9 32 FE 17 04 1336   	ld (xpix),a
0408ED 7A          1337   	ld a,d
0408EE 32 FF 17 04 1338   	ld (ypix),a
0408F2 CD 38 0C 04 1339   	call fn_get_pixel_color
0408F6 21 04 18 04 1340   	ld hl,current_pen
0408FA BE          1341   	cp (hl)
0408FB CA 25 09 04 1342   	jp z,ffl_exit
0408FF 7E          1343   	ld a,(hl)
040900 CD 7A 0C 04 1344   	call fn_set_pixel_color
040904             1345   
040904             1346   	; restore coordinates
040904 3A FE 17 04 1347   	ld a,(xpix)
040908 5F          1348   	ld e,a
040909 3A FF 17 04 1349   	ld a,(ypix)
04090D 57          1350   	ld d,a
04090E             1351   
04090E             1352   	; draw pixel at right
04090E 1C          1353   	inc e
04090F CD D2 08 04 1354   	call dsl_flood_fill_loop
040913 1D          1355   	dec e
040914             1356   	; draw pixel at left
040914 1D          1357   	dec e
040915 CD D2 08 04 1358   	call dsl_flood_fill_loop
040919 1C          1359   	inc e
04091A             1360   	; draw pixel up
04091A 14          1361   	inc d
04091B CD D2 08 04 1362   	call dsl_flood_fill_loop
04091F 15          1363   	dec d
040920             1364   	; draw pixel down
040920 15          1365   	dec d
040921 CD D2 08 04 1366   	call dsl_flood_fill_loop
040925             1367   
040925             1368   ffl_exit:
040925 D1          1369   	pop de
040926 C9          1370   	ret
040927             1371   
040927             1372   ; change current tool to palette tool
040927             1373   dsl_palette_tool:
040927 21 9F FF FF 1374   	ld hl,KEY_TAB
04092B CD 2B 17 04 1375   	call fn_inkey
04092F FE 00       1376   	cp 0
040931 20 F4       1377   	jr nz,dsl_palette_tool
040933             1378   
040933             1379   	; hide sprite drawing cursor
040933 CD 22 0C 04 1380   	call fn_draw_pixel_without_border
040937             1381   
040937             1382   	; draw selected palette color
040937 21 04 18 04 1383   	ld hl,current_pen
04093B 4E          1384   	ld c,(hl)
04093C CD D6 0C 04 1385   	call fn_draw_palette_with_border
040940             1386   
040940             1387   ; select palette color
040940             1388   dsl_palette_tool_loop:
040940             1389   	; move to left color in the palette
040940 21 E6 FF FF 1390   	ld hl,KEY_LEFT
040944 CD 2B 17 04 1391   	call fn_inkey
040948 FE 01       1392   	cp 1
04094A CC 0D 0A 04 1393   	call z,dsl_dec_pen
04094E             1394   
04094E             1395   	; move to right color in the palette
04094E 21 86 FF FF 1396   	ld hl,KEY_RIGHT
040952 CD 2B 17 04 1397   	call fn_inkey
040956 FE 01       1398   	cp 1
040958 CC 34 0A 04 1399   	call z,dsl_inc_pen
04095C             1400   
04095C             1401   	; return to draw sprite tool
04095C 21 9F FF FF 1402   	ld hl,KEY_TAB
040960 CD 2B 17 04 1403   	call fn_inkey
040964 FE 01       1404   	cp 1
040966 CA F0 09 04 1405   	jp z,dsl_draw_sprite_tool
04096A             1406   
04096A             1407   	; load palette
04096A 21 A9 FF FF 1408   	ld hl,KEY_L
04096E CD 2B 17 04 1409   	call fn_inkey
040972 FE 01       1410   	cp 1
040974 CC 98 09 04 1411   	call z,dslp_load_palette
040978             1412   
040978             1413   	; save palette
040978 21 AE FF FF 1414   	ld hl,KEY_S
04097C CD 2B 17 04 1415   	call fn_inkey
040980 FE 01       1416   	cp 1
040982 CC CA 09 04 1417   	call z,dslp_save_palette
040986             1418   
040986             1419   	; exit program
040986 21 8F FF FF 1420   	ld hl,KEY_ESCAPE
04098A CD 2B 17 04 1421   	call fn_inkey
04098E FE 01       1422   	cp 1
040990 CA 5D 0A 04 1423   	jp z,exit_program
040994             1424   
040994 C3 40 09 04 1425   	jp dsl_palette_tool_loop
040998             1426   
040998             1427   dslp_load_palette:
040998 21 A9 FF FF 1428   	ld hl,KEY_L
04099C CD 2B 17 04 1429   	call fn_inkey
0409A0 FE 00       1430   	cp 0
0409A2 20 F4       1431   	jr nz,dslp_load_palette
0409A4             1432   
0409A4 21 04 18 04 1433   	ld hl,current_pen
0409A8 4E          1434   	ld c,(hl)
0409A9 CD 3B 0D 04 1435   	call fn_draw_palette_without_border
0409AD CD B5 0E 04 1436   	call fn_load_palette
0409B1 CD 65 17 04 1437   	call fn_draw_the_palette
0409B5 CD 1D 16 04 1438   	call fn_refresh_sprite
0409B9 21 04 18 04 1439   	ld hl,current_pen
0409BD 4E          1440   	ld c,(hl)
0409BE CD D6 0C 04 1441   	call fn_draw_palette_with_border
0409C2 CD 5D 16 04 1442   	call fn_change_frame
0409C6 C3 40 09 04 1443   	jp dsl_palette_tool_loop
0409CA             1444   
0409CA             1445   dslp_save_palette:
0409CA 21 AE FF FF 1446   	ld hl,KEY_S
0409CE CD 2B 17 04 1447   	call fn_inkey
0409D2 FE 00       1448   	cp 0
0409D4 20 F4       1449   	jr nz,dslp_save_palette
0409D6             1450   
0409D6 21 04 18 04 1451   	ld hl,current_pen
0409DA 4E          1452   	ld c,(hl)
0409DB CD 3B 0D 04 1453   	call fn_draw_palette_without_border
0409DF CD BF 11 04 1454   	call fn_save_palette
0409E3 21 04 18 04 1455   	ld hl,current_pen
0409E7 4E          1456   	ld c,(hl)
0409E8 CD D6 0C 04 1457   	call fn_draw_palette_with_border
0409EC C3 40 09 04 1458   	jp dsl_palette_tool_loop
0409F0             1459   
0409F0             1460   dsl_draw_sprite_tool:
0409F0 21 9F FF FF 1461   	ld hl,KEY_TAB
0409F4 CD 2B 17 04 1462   	call fn_inkey
0409F8 FE 00       1463   	cp 0
0409FA 20 F4       1464   	jr nz,dsl_draw_sprite_tool
0409FC             1465   
0409FC             1466   	; unselect palette color
0409FC 21 04 18 04 1467   	ld hl,current_pen
040A00 4E          1468   	ld c,(hl)
040A01 CD 3B 0D 04 1469   	call fn_draw_palette_without_border
040A05             1470   
040A05             1471   	; draw the pixel with a border
040A05 CD 0E 0C 04 1472   	call fn_draw_pixel_with_border
040A09             1473   
040A09 C3 98 02 04 1474   	jp draw_sprite_loop
040A0D             1475   
040A0D             1476   dsl_dec_pen:
040A0D 21 04 18 04 1477   	ld hl,current_pen
040A11 7E          1478   	ld a,(hl)
040A12 FE 00       1479   	cp 0
040A14 C8          1480   	ret z
040A15 FE 40       1481   	cp MAX_COLORS
040A17 D0          1482   	ret nc
040A18             1483   
040A18 4F          1484   	ld c,a ; c is the old pen
040A19 3D          1485   	dec a ; a is the new pen
040A1A             1486   
040A1A F5          1487   	push af
040A1B C5          1488   	push bc
040A1C             1489   
040A1C             1490   	; unselect palette color
040A1C CD 3B 0D 04 1491   	call fn_draw_palette_without_border
040A20             1492   
040A20 C1          1493   	pop bc
040A21 F1          1494   	pop af
040A22             1495   
040A22             1496   	; replace current pen value
040A22 21 04 18 04 1497   	ld hl,current_pen
040A26 77          1498   	ld (hl),a
040A27             1499   
040A27             1500   	; select palette color
040A27 4F          1501   	ld c,a
040A28 CD D6 0C 04 1502   	call fn_draw_palette_with_border
040A2C CD A6 16 04 1503   	call fn_slowdown
040A30 C3 40 09 04 1504   	jp dsl_palette_tool_loop
040A34             1505   
040A34             1506   dsl_inc_pen:
040A34 21 04 18 04 1507   	ld hl,current_pen
040A38 7E          1508   	ld a,(hl)
040A39 21 23 19 04 1509   	ld hl,colors_count
040A3D 4E          1510   	ld c,(hl)
040A3E 0D          1511   	dec c
040A3F B9          1512   	cp c
040A40 D0          1513   	ret nc
040A41             1514   
040A41 4F          1515   	ld c,a ; c is the old pen
040A42 3C          1516   	inc a ; a is the new pen
040A43             1517   
040A43 F5          1518   	push af
040A44 C5          1519   	push bc
040A45             1520   
040A45             1521   	; unselect palette color
040A45 CD 3B 0D 04 1522   	call fn_draw_palette_without_border
040A49             1523   
040A49 C1          1524   	pop bc
040A4A F1          1525   	pop af
040A4B             1526   
040A4B             1527   	; replace current pen value
040A4B 21 04 18 04 1528   	ld hl,current_pen
040A4F 77          1529   	ld (hl),a
040A50             1530   
040A50             1531   	; select palette color
040A50 4F          1532   	ld c,a
040A51 CD D6 0C 04 1533   	call fn_draw_palette_with_border
040A55 CD A6 16 04 1534   	call fn_slowdown
040A59 C3 40 09 04 1535   	jp dsl_palette_tool_loop
040A5D             1536   
040A5D             1537   ; exit program
040A5D             1538   exit_program:
040A5D             1539   	; reset to mode 1
040A5D             1540   	vdu 22
040A5D 3E 16       0001M  		LD	A, function
040A5F 49 D7       0002M  		RST.LIS	10h
040A61             1541   	vdu 1
040A61 3E 01       0001M  		LD	A, function
040A63 49 D7       0002M  		RST.LIS	10h
040A65             1542   
040A65             1543   	; position the texte cursor at home
040A65             1544   	vdu 30
040A65 3E 1E       0001M  		LD	A, function
040A67 49 D7       0002M  		RST.LIS	10h
040A69             1545   
040A69             1546   	; show cursor
040A69             1547   	vdu 23
040A69 3E 17       0001M  		LD	A, function
040A6B 49 D7       0002M  		RST.LIS	10h
040A6D             1548   	vdu 1
040A6D 3E 01       0001M  		LD	A, function
040A6F 49 D7       0002M  		RST.LIS	10h
040A71             1549   	vdu 1
040A71 3E 01       0001M  		LD	A, function
040A73 49 D7       0002M  		RST.LIS	10h
040A75             1550   
040A75 FD E1       1551   	pop iy
040A77 DD E1       1552   	pop ix
040A79 D1          1553   	pop de
040A7A C1          1554   	pop bc
040A7B F1          1555   	pop af
040A7C 21 00 00 00 1556   	ld hl,0
040A80             1557   
040A80 C9          1558   	ret
040A81             1559   ;======================================================================
040A81             1560   
040A81             1561   ; draw a rectangle
040A81             1562   fn_rect:
040A81             1563   	vdu 25
040A81 3E 19       0001M  		LD	A, function
040A83 49 D7       0002M  		RST.LIS	10h
040A85             1564   	vdu 4
040A85 3E 04       0001M  		LD	A, function
040A87 49 D7       0002M  		RST.LIS	10h
040A89 DD 21 EE 17 1565   	ld ix,x1
       04          
040A8E DD 7E 00    1566   	ld a,(ix + 0)
040A91             1567   	vdu_a
040A91 49 D7       0001M  		RST.LIS	10h
040A93 DD 7E 01    1568   	ld a,(ix + 1)
040A96             1569   	vdu_a
040A96 49 D7       0001M  		RST.LIS	10h
040A98 FD 21 F0 17 1570   	ld iy,y1
       04          
040A9D FD 7E 00    1571   	ld a,(iy + 0)
040AA0             1572   	vdu_a
040AA0 49 D7       0001M  		RST.LIS	10h
040AA2 FD 7E 01    1573   	ld a,(iy + 1)
040AA5             1574   	vdu_a
040AA5 49 D7       0001M  		RST.LIS	10h
040AA7             1575   
040AA7             1576   	vdu 25
040AA7 3E 19       0001M  		LD	A, function
040AA9 49 D7       0002M  		RST.LIS	10h
040AAB             1577   	vdu 5
040AAB 3E 05       0001M  		LD	A, function
040AAD 49 D7       0002M  		RST.LIS	10h
040AAF DD 21 F2 17 1578   	ld ix,x2
       04          
040AB4 DD 7E 00    1579   	ld a,(ix + 0)
040AB7             1580   	vdu_a
040AB7 49 D7       0001M  		RST.LIS	10h
040AB9 DD 7E 01    1581   	ld a,(ix + 1)
040ABC             1582   	vdu_a
040ABC 49 D7       0001M  		RST.LIS	10h
040ABE FD 21 F0 17 1583   	ld iy,y1
       04          
040AC3 FD 7E 00    1584   	ld a,(iy + 0)
040AC6             1585   	vdu_a
040AC6 49 D7       0001M  		RST.LIS	10h
040AC8 FD 7E 01    1586   	ld a,(iy + 1)
040ACB             1587   	vdu_a
040ACB 49 D7       0001M  		RST.LIS	10h
040ACD             1588   
040ACD             1589   	vdu 25
040ACD 3E 19       0001M  		LD	A, function
040ACF 49 D7       0002M  		RST.LIS	10h
040AD1             1590   	vdu 5
040AD1 3E 05       0001M  		LD	A, function
040AD3 49 D7       0002M  		RST.LIS	10h
040AD5 DD 21 F2 17 1591   	ld ix,x2
       04          
040ADA DD 7E 00    1592   	ld a,(ix + 0)
040ADD             1593   	vdu_a
040ADD 49 D7       0001M  		RST.LIS	10h
040ADF DD 7E 01    1594   	ld a,(ix + 1)
040AE2             1595   	vdu_a
040AE2 49 D7       0001M  		RST.LIS	10h
040AE4 FD 21 F4 17 1596   	ld iy,y2
       04          
040AE9 FD 7E 00    1597   	ld a,(iy + 0)
040AEC             1598   	vdu_a
040AEC 49 D7       0001M  		RST.LIS	10h
040AEE FD 7E 01    1599   	ld a,(iy + 1)
040AF1             1600   	vdu_a
040AF1 49 D7       0001M  		RST.LIS	10h
040AF3             1601   
040AF3             1602   	vdu 25
040AF3 3E 19       0001M  		LD	A, function
040AF5 49 D7       0002M  		RST.LIS	10h
040AF7             1603   	vdu 5
040AF7 3E 05       0001M  		LD	A, function
040AF9 49 D7       0002M  		RST.LIS	10h
040AFB DD 21 EE 17 1604   	ld ix,x1
       04          
040B00 DD 7E 00    1605   	ld a,(ix + 0)
040B03             1606   	vdu_a
040B03 49 D7       0001M  		RST.LIS	10h
040B05 DD 7E 01    1607   	ld a,(ix + 1)
040B08             1608   	vdu_a
040B08 49 D7       0001M  		RST.LIS	10h
040B0A FD 21 F4 17 1609   	ld iy,y2
       04          
040B0F FD 7E 00    1610   	ld a,(iy + 0)
040B12             1611   	vdu_a
040B12 49 D7       0001M  		RST.LIS	10h
040B14 FD 7E 01    1612   	ld a,(iy + 1)
040B17             1613   	vdu_a
040B17 49 D7       0001M  		RST.LIS	10h
040B19             1614   
040B19             1615   	vdu 25
040B19 3E 19       0001M  		LD	A, function
040B1B 49 D7       0002M  		RST.LIS	10h
040B1D             1616   	vdu 5
040B1D 3E 05       0001M  		LD	A, function
040B1F 49 D7       0002M  		RST.LIS	10h
040B21 DD 21 EE 17 1617   	ld ix,x1
       04          
040B26 DD 7E 00    1618   	ld a,(ix + 0)
040B29             1619   	vdu_a
040B29 49 D7       0001M  		RST.LIS	10h
040B2B DD 7E 01    1620   	ld a,(ix + 1)
040B2E             1621   	vdu_a
040B2E 49 D7       0001M  		RST.LIS	10h
040B30 FD 21 F0 17 1622   	ld iy,y1
       04          
040B35 FD 7E 00    1623   	ld a,(iy + 0)
040B38             1624   	vdu_a
040B38 49 D7       0001M  		RST.LIS	10h
040B3A FD 7E 01    1625   	ld a,(iy + 1)
040B3D             1626   	vdu_a
040B3D 49 D7       0001M  		RST.LIS	10h
040B3F             1627   
040B3F C9          1628   	ret
040B40             1629   
040B40             1630   ; draw a filled rectangle
040B40             1631   fn_rectf:
040B40 DD 21 EE 17 1632   	ld ix,x1
       04          
040B45 FD 21 F0 17 1633   	ld iy,y1
       04          
040B4A             1634   
040B4A             1635   	vdu 25
040B4A 3E 19       0001M  		LD	A, function
040B4C 49 D7       0002M  		RST.LIS	10h
040B4E             1636   	vdu 4
040B4E 3E 04       0001M  		LD	A, function
040B50 49 D7       0002M  		RST.LIS	10h
040B52 DD 7E 00    1637   	ld a,(ix+0)
040B55             1638   	vdu_a
040B55 49 D7       0001M  		RST.LIS	10h
040B57 DD 7E 01    1639   	ld a,(ix+1)
040B5A             1640   	vdu_a
040B5A 49 D7       0001M  		RST.LIS	10h
040B5C FD 7E 00    1641   	ld a,(iy+0)
040B5F             1642   	vdu_a
040B5F 49 D7       0001M  		RST.LIS	10h
040B61 FD 7E 01    1643   	ld a,(iy+1)
040B64             1644   	vdu_a
040B64 49 D7       0001M  		RST.LIS	10h
040B66             1645   
040B66 DD 21 F2 17 1646   	ld ix,x2
       04          
040B6B FD 21 F4 17 1647   	ld iy,y2
       04          
040B70             1648   
040B70             1649   	vdu 25
040B70 3E 19       0001M  		LD	A, function
040B72 49 D7       0002M  		RST.LIS	10h
040B74             1650   	vdu 101
040B74 3E 65       0001M  		LD	A, function
040B76 49 D7       0002M  		RST.LIS	10h
040B78 DD 7E 00    1651   	ld a,(ix+0)
040B7B             1652   	vdu_a
040B7B 49 D7       0001M  		RST.LIS	10h
040B7D DD 7E 01    1653   	ld a,(ix+1)
040B80             1654   	vdu_a
040B80 49 D7       0001M  		RST.LIS	10h
040B82 FD 7E 00    1655   	ld a,(iy+0)
040B85             1656   	vdu_a
040B85 49 D7       0001M  		RST.LIS	10h
040B87 FD 7E 01    1657   	ld a,(iy+1)
040B8A             1658   	vdu_a
040B8A 49 D7       0001M  		RST.LIS	10h
040B8C             1659   
040B8C C9          1660   	ret
040B8D             1661   
040B8D             1662   fn_calc_pixel_coords:
040B8D 11 00 00 00 1663   	ld de,$000000 ; reset deu
040B91             1664   
040B91             1665   	; calculate coordinates x of the resized pixel
040B91 21 FE 17 04 1666   	ld hl,xpix
040B95 5E          1667   	ld e,(hl) ; E = xpix
040B96 21 02 18 04 1668   	ld hl,pixel_width
040B9A 56          1669   	ld d,(hl) ; D = pixel_width
040B9B D5          1670   	push de
040B9C E1          1671   	pop hl ; HL = DE
040B9D ED 6C       1672   	mlt hl ; HL = xpix * pixel_width
040B9F DD 21 F6 17 1673   	ld ix,xs1
       04          
040BA4 DD 5E 00    1674   	ld e,(ix+0)
040BA7 DD 56 01    1675   	ld d,(ix+1)
040BAA 13          1676   	inc de ; DE = xs1 + 1
040BAB 19          1677   	add hl,de ; HL = (xpix * pixel_width) + xs1 + 1
040BAC FD 21 EE 17 1678   	ld iy,x1
       04          
040BB1 FD 75 00    1679   	ld (iy+0),l
040BB4 FD 74 01    1680   	ld (iy+1),h ; x1 = (xpix * pixel_width) + xs1 + 1
040BB7 E5          1681   	push hl
040BB8 21 02 18 04 1682   	ld hl,pixel_width
040BBC 16 00       1683   	ld d,0
040BBE 5E          1684   	ld e,(hl)
040BBF E1          1685   	pop hl
040BC0 19          1686   	add hl,de
040BC1 2B          1687   	dec hl
040BC2 FD 21 F2 17 1688   	ld iy,x2
       04          
040BC7 FD 75 00    1689   	ld (iy+0),l
040BCA FD 74 01    1690   	ld (iy+1),h ; x2 = x1 + pixel_width - 1
040BCD             1691   
040BCD 11 00 00 00 1692   	ld de,$000000 ; reset deu
040BD1             1693   
040BD1             1694   	; calculate coordinates y of the resized pixel
040BD1 21 FF 17 04 1695   	ld hl,ypix
040BD5 5E          1696   	ld e,(hl) ; E = ypix
040BD6 21 02 18 04 1697   	ld hl,pixel_width
040BDA 56          1698   	ld d,(hl) ; D = pixel_width
040BDB D5          1699   	push de
040BDC E1          1700   	pop hl ; HL = DE
040BDD ED 6C       1701   	mlt hl ; HL = ypix * pixel_width
040BDF DD 21 F8 17 1702   	ld ix,ys1
       04          
040BE4 DD 5E 00    1703   	ld e,(ix+0)
040BE7 DD 56 01    1704   	ld d,(ix+1) ; ys1 = ypix * pixel_width
040BEA 13          1705   	inc de ; DE = ys1 + 1
040BEB 19          1706   	add hl,de ; HL = (ypix * pixel_width) + ys1 + 1
040BEC FD 21 F0 17 1707   	ld iy,y1
       04          
040BF1 FD 75 00    1708   	ld (iy+0),l
040BF4 FD 74 01    1709   	ld (iy+1),h ; y1 = (ypix * pixel_width) + ys1 + 1
040BF7 E5          1710   	push hl
040BF8 21 02 18 04 1711   	ld hl,pixel_width
040BFC 16 00       1712   	ld d,0
040BFE 5E          1713   	ld e,(hl)
040BFF E1          1714   	pop hl
040C00 19          1715   	add hl,de
040C01 2B          1716   	dec hl
040C02 FD 21 F4 17 1717   	ld iy,y2
       04          
040C07 FD 75 00    1718   	ld (iy+0),l
040C0A FD 74 01    1719   	ld (iy+1),h ; y2 = y1 + pixel_width - 1
040C0D             1720   
040C0D C9          1721   	ret
040C0E             1722   
040C0E             1723   ; draw the resized pixel border, with its color
040C0E             1724   fn_draw_pixel_with_border:
040C0E CD 22 0C 04 1725   	call fn_draw_pixel_without_border
040C12             1726   
040C12             1727   	; set graphics pen
040C12             1728   	vdu 18
040C12 3E 12       0001M  		LD	A, function
040C14 49 D7       0002M  		RST.LIS	10h
040C16             1729   	vdu 0
040C16 3E 00       0001M  		LD	A, function
040C18 49 D7       0002M  		RST.LIS	10h
040C1A             1730   	vdu 1 ; pen 1
040C1A 3E 01       0001M  		LD	A, function
040C1C 49 D7       0002M  		RST.LIS	10h
040C1E             1731   
040C1E             1732   	; draw the sprite's border rectangle
040C1E C3 81 0A 04 1733   	jp fn_rect
040C22             1734   
040C22             1735   ; draw the resized pixel color
040C22             1736   fn_draw_pixel_without_border:
040C22 CD 8D 0B 04 1737   	call fn_calc_pixel_coords
040C26             1738   
040C26             1739   	; set graphics pen
040C26             1740   	vdu 18
040C26 3E 12       0001M  		LD	A, function
040C28 49 D7       0002M  		RST.LIS	10h
040C2A             1741   	vdu 0
040C2A 3E 00       0001M  		LD	A, function
040C2C 49 D7       0002M  		RST.LIS	10h
040C2E CD 38 0C 04 1742   	call fn_get_pixel_color
040C32             1743   	vdu_a
040C32 49 D7       0001M  		RST.LIS	10h
040C34             1744   
040C34             1745   	; draw the sprite's color rectangle
040C34 C3 40 0B 04 1746   	jp fn_rectf
040C38             1747   
040C38             1748   ; get pixel color value in the sprite buffer
040C38             1749   ; returns A: pixel color (0-63)
040C38             1750   fn_get_pixel_color:
040C38 11 00 00 00 1751   	ld de,$000000 ; reset deu
040C3C             1752   
040C3C             1753   	; calculate the offset to add to the address
040C3C 21 FF 17 04 1754   	ld hl,ypix
040C40 5E          1755   	ld e,(hl) ; E = ypix
040C41 21 03 18 04 1756   	ld hl,spr_size
040C45 56          1757   	ld d,(hl) ; D = sprsize
040C46 D5          1758   	push de
040C47 E1          1759   	pop hl
040C48 ED 6C       1760   	mlt hl ; HL = ypix * sprsize
040C4A E5          1761   	push hl
040C4B 21 FE 17 04 1762   	ld hl,xpix
040C4F 5E          1763   	ld e,(hl)
040C50 16 00       1764   	ld d,0
040C52 E1          1765   	pop hl
040C53 19          1766   	add hl,de ; HL = (ypix * sprsize) + xpix
040C54             1767   
040C54 11 28 19 04 1768   	ld de,current_frame
040C58 1A          1769   	ld a,(de)
040C59 FE 00       1770   	cp 0
040C5B 28 16       1771   	jr z,gpc_end_loop
040C5D             1772   
040C5D 47          1773   	ld b,a
040C5E E5          1774   	push hl
040C5F 11 00 00 00 1775   	ld de,$000000
040C63 21 03 18 04 1776   	ld hl,spr_size
040C67 5E          1777   	ld e,(hl)
040C68 56          1778   	ld d,(hl)
040C69 D5          1779   	push de
040C6A E1          1780   	pop hl
040C6B ED 6C       1781   	mlt hl
040C6D E5          1782   	push hl
040C6E D1          1783   	pop de ; DE = sprsize²
040C6F E1          1784   	pop hl
040C70             1785   
040C70             1786   gpc_loop:
040C70 19          1787   	add hl,de
040C71 10 FD       1788   	djnz gpc_loop
040C73             1789   
040C73             1790   gpc_end_loop:
040C73             1791   	; add the offset to the address
040C73 11 31 19 04 1792   	ld de,sprite_buffer
040C77 19          1793   	add hl,de ; HL = sprite_buffer + ((ypix * sprsize) + xpix)
040C78             1794   
040C78             1795   	; get pixel color value
040C78 7E          1796   	ld a,(hl)
040C79             1797   
040C79 C9          1798   	ret
040C7A             1799   
040C7A             1800   ; get pixel color value in the sprite buffer
040C7A             1801   ; A: pixel color (0-63)
040C7A             1802   fn_set_pixel_color:
040C7A 11 00 00 00 1803   	ld de,$000000 ; reset deu
040C7E             1804   
040C7E             1805   	; calculate the offset to add to the address
040C7E 21 FF 17 04 1806   	ld hl,ypix
040C82 5E          1807   	ld e,(hl) ; E = ypix
040C83 21 03 18 04 1808   	ld hl,spr_size
040C87 56          1809   	ld d,(hl) ; D = sprsize
040C88 D5          1810   	push de
040C89 E1          1811   	pop hl
040C8A ED 6C       1812   	mlt hl ; HL = ypix * sprsize
040C8C E5          1813   	push hl
040C8D 21 FE 17 04 1814   	ld hl,xpix
040C91 5E          1815   	ld e,(hl)
040C92 16 00       1816   	ld d,0
040C94 E1          1817   	pop hl
040C95 19          1818   	add hl,de ; HL = (ypix * sprsize) + xpix
040C96 F5          1819   	push af
040C97             1820   
040C97 11 28 19 04 1821   	ld de,current_frame
040C9B 1A          1822   	ld a,(de)
040C9C FE 00       1823   	cp 0
040C9E 28 16       1824   	jr z,spc_end_loop
040CA0             1825   
040CA0 47          1826   	ld b,a
040CA1 E5          1827   	push hl
040CA2 11 00 00 00 1828   	ld de,$000000
040CA6 21 03 18 04 1829   	ld hl,spr_size
040CAA 5E          1830   	ld e,(hl)
040CAB 56          1831   	ld d,(hl)
040CAC D5          1832   	push de
040CAD E1          1833   	pop hl
040CAE ED 6C       1834   	mlt hl
040CB0 E5          1835   	push hl
040CB1 D1          1836   	pop de ; DE = sprsize²
040CB2 E1          1837   	pop hl
040CB3             1838   
040CB3             1839   spc_loop:
040CB3 19          1840   	add hl,de
040CB4 10 FD       1841   	djnz spc_loop
040CB6             1842   
040CB6             1843   spc_end_loop:
040CB6             1844   
040CB6             1845   	; add the offset to the address
040CB6 11 31 19 04 1846   	ld de,sprite_buffer
040CBA 19          1847   	add hl,de ; HL = sprite_buffer + ((ypix * sprsize) + xpix)
040CBB             1848   
040CBB             1849   	; set pixel color value
040CBB F1          1850   	pop af
040CBC 77          1851   	ld (hl),a
040CBD             1852   
040CBD C9          1853   	ret
040CBE             1854   
040CBE             1855   fn_move_up:
040CBE 21 FF 17 04 1856   	ld hl,ypix
040CC2 35          1857   	dec (hl)
040CC3 C9          1858   	ret
040CC4             1859   
040CC4             1860   fn_move_down:
040CC4 21 FF 17 04 1861   	ld hl,ypix
040CC8 34          1862   	inc (hl)
040CC9 C9          1863   	ret
040CCA             1864   
040CCA             1865   fn_move_left:
040CCA 21 FE 17 04 1866   	ld hl,xpix
040CCE 35          1867   	dec (hl)
040CCF C9          1868   	ret
040CD0             1869   
040CD0             1870   fn_move_right:
040CD0 21 FE 17 04 1871   	ld hl,xpix
040CD4 34          1872   	inc (hl)
040CD5 C9          1873   	ret
040CD6             1874   
040CD6             1875   ; draw palette color whit border and selection
040CD6             1876   ; C = color number (0-63)
040CD6             1877   fn_draw_palette_with_border:
040CD6 C5          1878   	push bc
040CD7             1879   
040CD7             1880   	; choose palette color
040CD7             1881   	vdu 18
040CD7 3E 12       0001M  		LD	A, function
040CD9 49 D7       0002M  		RST.LIS	10h
040CDB             1882   	vdu 0
040CDB 3E 00       0001M  		LD	A, function
040CDD 49 D7       0002M  		RST.LIS	10h
040CDF C1          1883   	pop bc
040CE0 C5          1884   	push bc
040CE1 79          1885   	ld a,c
040CE2             1886   	vdu_a
040CE2 49 D7       0001M  		RST.LIS	10h
040CE4             1887   
040CE4             1888   	; store coordinates for a palette square
040CE4 DD 21 EE 17 1889   	ld ix,x1
       04          
040CE9 E1          1890   	pop hl
040CEA E5          1891   	push hl
040CEB 26 05       1892   	ld h,5
040CED ED 6C       1893   	mlt hl
040CEF E5          1894   	push hl
040CF0 DD 75 00    1895   	ld (ix+0),l
040CF3 DD 74 01    1896   	ld (ix+1),h
040CF6             1897   
040CF6 DD 21 F0 17 1898   	ld ix,y1
       04          
040CFB 21 00 00 00 1899   	ld hl,0
040CFF DD 75 00    1900   	ld (ix+0),l
040D02 DD 74 01    1901   	ld (ix+1),h
040D05             1902   
040D05 DD 21 F2 17 1903   	ld ix,x2
       04          
040D0A E1          1904   	pop hl
040D0B 11 04 00 00 1905   	ld de,4
040D0F 19          1906   	add hl,de
040D10 DD 75 00    1907   	ld (ix+0),l
040D13 DD 74 01    1908   	ld (ix+1),h
040D16             1909   
040D16 DD 21 F4 17 1910   	ld ix,y2
       04          
040D1B 21 0A 00 00 1911   	ld hl,10
040D1F DD 75 00    1912   	ld (ix+0),l
040D22 DD 74 01    1913   	ld (ix+1),h
040D25             1914   
040D25             1915   	; draw the palette filled square
040D25 CD 40 0B 04 1916   	call fn_rectf
040D29             1917   
040D29             1918   	; choose pen 1
040D29             1919   	vdu 18
040D29 3E 12       0001M  		LD	A, function
040D2B 49 D7       0002M  		RST.LIS	10h
040D2D             1920   	vdu 0
040D2D 3E 00       0001M  		LD	A, function
040D2F 49 D7       0002M  		RST.LIS	10h
040D31 3E 01       1921   	ld a,1
040D33             1922   	vdu_a
040D33 49 D7       0001M  		RST.LIS	10h
040D35             1923   
040D35             1924   	; draw the palette square border
040D35 CD 81 0A 04 1925   	call fn_rect
040D39             1926   
040D39             1927   	; next color ?
040D39 C1          1928   	pop bc
040D3A             1929   
040D3A C9          1930   	ret
040D3B             1931   
040D3B             1932   ; draw palette color whitout border and selection
040D3B             1933   ; C = color number (0-63)
040D3B             1934   fn_draw_palette_without_border:
040D3B C5          1935   	push bc
040D3C             1936   
040D3C             1937   	; choose palette color
040D3C             1938   	vdu 18
040D3C 3E 12       0001M  		LD	A, function
040D3E 49 D7       0002M  		RST.LIS	10h
040D40             1939   	vdu 0
040D40 3E 00       0001M  		LD	A, function
040D42 49 D7       0002M  		RST.LIS	10h
040D44 C1          1940   	pop bc
040D45 C5          1941   	push bc
040D46 79          1942   	ld a,c
040D47             1943   	vdu_a
040D47 49 D7       0001M  		RST.LIS	10h
040D49             1944   
040D49             1945   	; store coordinates for a palette square
040D49 DD 21 EE 17 1946   	ld ix,x1
       04          
040D4E E1          1947   	pop hl
040D4F E5          1948   	push hl
040D50 26 05       1949   	ld h,5
040D52 ED 6C       1950   	mlt hl
040D54 E5          1951   	push hl
040D55 DD 75 00    1952   	ld (ix+0),l
040D58 DD 74 01    1953   	ld (ix+1),h
040D5B             1954   
040D5B DD 21 F0 17 1955   	ld ix,y1
       04          
040D60 21 00 00 00 1956   	ld hl,0
040D64 DD 75 00    1957   	ld (ix+0),l
040D67 DD 74 01    1958   	ld (ix+1),h
040D6A             1959   
040D6A DD 21 F2 17 1960   	ld ix,x2
       04          
040D6F E1          1961   	pop hl
040D70 11 04 00 00 1962   	ld de,4
040D74 19          1963   	add hl,de
040D75 DD 75 00    1964   	ld (ix+0),l
040D78 DD 74 01    1965   	ld (ix+1),h
040D7B             1966   
040D7B DD 21 F4 17 1967   	ld ix,y2
       04          
040D80 21 0A 00 00 1968   	ld hl,10
040D84 DD 75 00    1969   	ld (ix+0),l
040D87 DD 74 01    1970   	ld (ix+1),h
040D8A             1971   
040D8A             1972   	; draw the palette filled square
040D8A CD 40 0B 04 1973   	call fn_rectf
040D8E             1974   
040D8E C1          1975   	pop bc
040D8F             1976   
040D8F C9          1977   	ret
040D90             1978   
040D90             1979   ; get an ascii key value
040D90             1980   fn_input_key:
040D90 C5          1981   	push bc
040D91             1982   	moscall mos_getkey
040D91 3E 00       0001M  		LD	A, function
040D93 49 CF       0002M  		RST.LIS	08h
040D95 C1          1983   	pop bc
040D96 C9          1984   	ret
040D97             1985   
040D97             1986   ; input a text of 8 chars
040D97             1987   fn_input_text8:
040D97             1988   	; locate x,y
040D97             1989   	vdu 31
040D97 3E 1F       0001M  		LD	A, function
040D99 49 D7       0002M  		RST.LIS	10h
040D9B             1990   	vdu FILENAME_X
040D9B 3E 07       0001M  		LD	A, function
040D9D 49 D7       0002M  		RST.LIS	10h
040D9F             1991   	vdu FILENAME_Y
040D9F 3E 18       0001M  		LD	A, function
040DA1 49 D7       0002M  		RST.LIS	10h
040DA3             1992   
040DA3             1993   	; print text
040DA3 21 70 18 04 1994   	ld hl,filename_label
040DA7 01 00 00 00 1995   	ld bc,0
040DAB AF          1996   	xor a
040DAC 49 DF       1997   	rst.lis $18
040DAE             1998   
040DAE             1999   	; show cursor
040DAE             2000   	vdu 23
040DAE 3E 17       0001M  		LD	A, function
040DB0 49 D7       0002M  		RST.LIS	10h
040DB2             2001   	vdu 1
040DB2 3E 01       0001M  		LD	A, function
040DB4 49 D7       0002M  		RST.LIS	10h
040DB6             2002   	vdu 1
040DB6 3E 01       0001M  		LD	A, function
040DB8 49 D7       0002M  		RST.LIS	10h
040DBA             2003   
040DBA 0E 00       2004   	ld c,0
040DBC             2005   
040DBC             2006   it8_loop:
040DBC             2007   	; get ascii key
040DBC CD 90 0D 04 2008   	call fn_input_key
040DC0 B7          2009   	or a
040DC1 CA BC 0D 04 2010   	jp z,it8_loop
040DC5             2011   
040DC5 FE 2E       2012   	cp '.'
040DC7 CA 11 0E 04 2013   	jp z,it8l_add_char
040DCB             2014   
040DCB FE 2D       2015   	cp '-'
040DCD CA 11 0E 04 2016   	jp z,it8l_add_char
040DD1             2017   
040DD1 FE 5F       2018   	cp '_'
040DD3 CA 11 0E 04 2019   	jp z,it8l_add_char
040DD7             2020   
040DD7 FE 7F       2021   	cp 127
040DD9 CA 45 0E 04 2022   	jp z,it8l_backspace
040DDD             2023   
040DDD FE 0D       2024   	cp 13
040DDF CA 83 0E 04 2025   	jp z,it8l_return
040DE3             2026   
040DE3 FE 30       2027   	cp '0'
040DE5 DA BC 0D 04 2028   	jp c,it8_loop
040DE9             2029   
040DE9 16 39       2030   	ld d,'9'
040DEB 14          2031   	inc d
040DEC BA          2032   	cp d
040DED DA 11 0E 04 2033   	jp c,it8l_add_char
040DF1             2034   
040DF1 FE 41       2035   	cp 'A'
040DF3 DA BC 0D 04 2036   	jp c,it8_loop
040DF7             2037   
040DF7 16 5A       2038   	ld d,'Z'
040DF9 14          2039   	inc d
040DFA BA          2040   	cp d
040DFB DA 11 0E 04 2041   	jp c,it8l_add_char
040DFF             2042   
040DFF FE 61       2043   	cp 'a'
040E01 DA BC 0D 04 2044   	jp c,it8_loop
040E05             2045   
040E05 16 7A       2046   	ld d,'z'
040E07 14          2047   	inc d
040E08 BA          2048   	cp d
040E09 DA 11 0E 04 2049   	jp c,it8l_add_char
040E0D             2050   
040E0D C3 BC 0D 04 2051   	jp it8_loop
040E11             2052   
040E11             2053   it8l_add_char:
040E11 F5          2054   	push af
040E12 79          2055   	ld a,c
040E13 FE 10       2056   	cp 16
040E15 38 05       2057   	jr c,it8l_poke_char
040E17 F1          2058   	pop af
040E18 C3 BC 0D 04 2059   	jp it8_loop
040E1C             2060   
040E1C             2061   it8l_poke_char:
040E1C F1          2062   	pop af
040E1D 21 7A 18 04 2063   	ld hl,filename
040E21 06 00       2064   	ld b,0
040E23 09          2065   	add hl,bc
040E24 77          2066   	ld (hl),a
040E25 0C          2067   	inc c
040E26 F5          2068   	push af
040E27 C5          2069   	push bc
040E28             2070   
040E28             2071   	; locate x,y
040E28             2072   	vdu 31
040E28 3E 1F       0001M  		LD	A, function
040E2A 49 D7       0002M  		RST.LIS	10h
040E2C             2073   	vdu FILENAME_X+9
040E2C 3E 10       0001M  		LD	A, function
040E2E 49 D7       0002M  		RST.LIS	10h
040E30             2074   	vdu FILENAME_Y
040E30 3E 18       0001M  		LD	A, function
040E32 49 D7       0002M  		RST.LIS	10h
040E34             2075   
040E34             2076   	; print text
040E34 21 7A 18 04 2077   	ld hl,filename
040E38 01 00 00 00 2078   	ld bc,0
040E3C AF          2079   	xor a
040E3D 49 DF       2080   	rst.lis $18
040E3F             2081   
040E3F C1          2082   	pop bc
040E40 F1          2083   	pop af
040E41             2084   
040E41 C3 BC 0D 04 2085   	jp it8_loop
040E45             2086   
040E45             2087   it8l_backspace:
040E45 79          2088   	ld a,c
040E46 FE 00       2089   	cp 0
040E48 CA BC 0D 04 2090   	jp z,it8_loop
040E4C             2091   
040E4C             2092   	; delete a character of the filename
040E4C 21 7A 18 04 2093   	ld hl,filename
040E50 06 00       2094   	ld b,0
040E52 09          2095   	add hl,bc
040E53 AF          2096   	xor a
040E54 77          2097   	ld (hl),a
040E55 0D          2098   	dec c
040E56 C5          2099   	push bc
040E57             2100   
040E57             2101   	; locate x,y
040E57             2102   	vdu 31
040E57 3E 1F       0001M  		LD	A, function
040E59 49 D7       0002M  		RST.LIS	10h
040E5B 3E 10       2103   	ld a,FILENAME_X+9
040E5D 81          2104   	add a,c
040E5E             2105   	vdu_a
040E5E 49 D7       0001M  		RST.LIS	10h
040E60             2106   	vdu FILENAME_Y
040E60 3E 18       0001M  		LD	A, function
040E62 49 D7       0002M  		RST.LIS	10h
040E64             2107   
040E64 C5          2108   	push bc
040E65             2109   
040E65             2110   	; print text
040E65 21 9F 18 04 2111   	ld hl,spacechar
040E69 01 00 00 00 2112   	ld bc,0
040E6D AF          2113   	xor a
040E6E 49 DF       2114   	rst.lis $18
040E70             2115   
040E70 C1          2116   	pop bc
040E71             2117   
040E71             2118   	; locate x,y
040E71             2119   	vdu 31
040E71 3E 1F       0001M  		LD	A, function
040E73 49 D7       0002M  		RST.LIS	10h
040E75 3E 10       2120   	ld a,FILENAME_X+9
040E77 81          2121   	add a,c
040E78             2122   	vdu_a
040E78 49 D7       0001M  		RST.LIS	10h
040E7A             2123   	vdu FILENAME_Y
040E7A 3E 18       0001M  		LD	A, function
040E7C 49 D7       0002M  		RST.LIS	10h
040E7E             2124   
040E7E C1          2125   	pop bc
040E7F C3 BC 0D 04 2126   	jp it8_loop
040E83             2127   
040E83             2128   it8l_return:
040E83             2129   	; locate x,y
040E83             2130   	vdu 31
040E83 3E 1F       0001M  		LD	A, function
040E85 49 D7       0002M  		RST.LIS	10h
040E87             2131   	vdu FILENAME_X
040E87 3E 07       0001M  		LD	A, function
040E89 49 D7       0002M  		RST.LIS	10h
040E8B             2132   	vdu FILENAME_Y
040E8B 3E 18       0001M  		LD	A, function
040E8D 49 D7       0002M  		RST.LIS	10h
040E8F             2133   
040E8F             2134   	; print text
040E8F 21 A1 18 04 2135   	ld hl,void_filename
040E93 01 00 00 00 2136   	ld bc,0
040E97 AF          2137   	xor a
040E98 49 DF       2138   	rst.lis $18
040E9A             2139   
040E9A             2140   	; hide cursor
040E9A             2141   	vdu 23
040E9A 3E 17       0001M  		LD	A, function
040E9C 49 D7       0002M  		RST.LIS	10h
040E9E             2142   	vdu 1
040E9E 3E 01       0001M  		LD	A, function
040EA0 49 D7       0002M  		RST.LIS	10h
040EA2             2143   	vdu 0
040EA2 3E 00       0001M  		LD	A, function
040EA4 49 D7       0002M  		RST.LIS	10h
040EA6             2144   
040EA6             2145   it8l_endloop:
040EA6 21 B6 FF FF 2146   	ld hl,KEY_RETURN
040EAA CD 2B 17 04 2147   	call fn_inkey
040EAE FE 01       2148   	CP 1
040EB0 CA A6 0E 04 2149   	jp z,it8l_endloop
040EB4             2150   
040EB4 C9          2151   	ret
040EB5             2152   
040EB5             2153   ; load a palette
040EB5             2154   fn_load_palette:
040EB5             2155   	; clear the filename on the screen
040EB5 21 7A 18 04 2156   	ld hl,filename
040EB9 06 10       2157   	ld b,FILENAME_LENGTH
040EBB AF          2158   	xor a
040EBC             2159   
040EBC             2160   lp_clear_filename:
040EBC 77          2161   	ld (hl),a
040EBD 23          2162   	inc hl
040EBE 10 FC       2163   	djnz lp_clear_filename
040EC0             2164   
040EC0             2165   	; get filename
040EC0 CD 97 0D 04 2166   	call fn_input_text8
040EC4             2167   
040EC4             2168   	; set path to 'palettes/'
040EC4 21 93 18 04 2169   	ld hl,palette_path
040EC8             2170   	moscall mos_cd
040EC8 3E 03       0001M  		LD	A, function
040ECA 49 CF       0002M  		RST.LIS	08h
040ECC             2171   
040ECC             2172   	; exit on folder error
040ECC FE 00       2173   	cp 0
040ECE C2 90 0F 04 2174   	jp nz,lp_folder_error
040ED2             2175   
040ED2             2176   	; open the file for read
040ED2 21 7A 18 04 2177   	ld hl,filename
040ED6 0E 01       2178   	ld c,fa_open_existing|fa_read
040ED8             2179   	moscall mos_fopen
040ED8 3E 0A       0001M  		LD	A, function
040EDA 49 CF       0002M  		RST.LIS	08h
040EDC             2180   
040EDC             2181   	; exit on file error
040EDC FE 00       2182   	cp 0
040EDE CA F4 10 04 2183   	jp z,lp_file_error
040EE2             2184   
040EE2             2185   	; filehandle -> C
040EE2 4F          2186   	ld c,a
040EE3             2187   
040EE3             2188   	; get palette header
040EE3 21 31 39 04 2189   	ld hl,header_buffer
040EE7 11 10 00 00 2190   	ld de,16
040EEB C5          2191   	push bc ; store filehandle
040EEC             2192   	moscall mos_fread
040EEC 3E 1A       0001M  		LD	A, function
040EEE 49 CF       0002M  		RST.LIS	08h
040EF0 C1          2193   	pop bc ; restore filehandle
040EF1 3E 10       2194   	ld a,16
040EF3 BB          2195   	cp e
040EF4 C2 74 0F 04 2196   	jp nz,lp_close_error
040EF8             2197   
040EF8             2198   	; compare loaded header with needed header
040EF8 11 8D 3C 04 2199   	ld de,header
040EFC 21 31 39 04 2200   	ld hl,header_buffer
040F00 47          2201   	ld b,a
040F01             2202   
040F01             2203   lp_compare:
040F01 1A          2204   	ld a,(de)
040F02 BE          2205   	cp (hl)
040F03 C2 98 0F 04 2206   	jp nz,lp_header_error
040F07             2207   
040F07 13          2208   	inc de
040F08 23          2209   	inc hl
040F09 05          2210   	dec b
040F0A             2211   
040F0A 78          2212   	ld a,b
040F0B FE 00       2213   	cp 0
040F0D C2 01 0F 04 2214   	jp nz,lp_compare
040F11             2215   
040F11             2216   	; prepare to read the number of colors
040F11 21 41 39 04 2217   	ld hl,color_buffer
040F15             2218   
040F15             2219   lp_getcount:
040F15             2220   	; read a string for colors count
040F15 C5          2221   	push bc
040F16 E5          2222   	push hl
040F17             2223   
040F17             2224   	; read colors data
040F17             2225   	moscall mos_fgetc
040F17 3E 0C       0001M  		LD	A, function
040F19 49 CF       0002M  		RST.LIS	08h
040F1B             2226   
040F1B E1          2227   	pop hl
040F1C C1          2228   	pop bc
040F1D             2229   
040F1D             2230   	; exit if eof
040F1D DA 74 0F 04 2231   	jp c,lp_close_error
040F21             2232   
040F21 FE 30       2233   	cp 48 ; < 0
040F23 38 0A       2234   	jr c,lpgc_next
040F25 FE 3A       2235   	cp 58 ; > 9
040F27 D2 EF 10 04 2236   	jp nc,lp_data_error
040F2B             2237   
040F2B 77          2238   	ld (hl),a
040F2C 23          2239   	inc hl
040F2D 18 E6       2240   	jr lp_getcount
040F2F             2241   
040F2F             2242   lpgc_next:
040F2F F5          2243   	push af
040F30 3E 0D       2244   	ld a,13
040F32 77          2245   	ld (hl),a ; store CR
040F33 F1          2246   	pop af
040F34             2247   
040F34             2248   	; test CR
040F34 FE 0D       2249   	cp 13
040F36 C2 74 0F 04 2250   	jp nz,lp_close_error
040F3A             2251   
040F3A C5          2252   	push bc
040F3B             2253   
040F3B             2254   	; read LF
040F3B             2255   	moscall mos_fgetc
040F3B 3E 0C       0001M  		LD	A, function
040F3D 49 CF       0002M  		RST.LIS	08h
040F3F             2256   
040F3F C1          2257   	pop bc
040F40             2258   
040F40             2259   	; test LF
040F40 FE 0A       2260   	cp 10
040F42 C2 74 0F 04 2261   	jp nz,lp_close_error
040F46             2262   
040F46             2263   	; prepare to read color strings
040F46 11 00 00 00 2264   	ld de,#000000
040F4A 21 44 39 04 2265   	ld hl,palette_buffer
040F4E             2266   
040F4E             2267   lp_load_pal_loop:
040F4E C5          2268   	push bc
040F4F D5          2269   	push de
040F50 E5          2270   	push hl
040F51             2271   
040F51             2272   	; read colors data
040F51             2273   	moscall mos_fgetc
040F51 3E 0C       0001M  		LD	A, function
040F53 49 CF       0002M  		RST.LIS	08h
040F55             2274   
040F55             2275   	; exit if eof
040F55 DA 6D 0F 04 2276   	jp c,lp_loaded
040F59             2277   
040F59 E1          2278   	pop hl
040F5A D1          2279   	pop de
040F5B C1          2280   	pop bc
040F5C             2281   
040F5C 77          2282   	ld (hl),a ; store loaded char in palette buffer
040F5D 23          2283   	inc hl
040F5E 13          2284   	inc de ; count chars
040F5F 7A          2285   	ld a,d
040F60 FE 03       2286   	cp MAX_PAL_DATA_HI
040F62 DA 4E 0F 04 2287   	jp c,lp_load_pal_loop
040F66 7B          2288   	ld a,e
040F67 FE 44       2289   	cp MAX_PAL_DATA_LO
040F69 DA 4E 0F 04 2290   	jp c,lp_load_pal_loop
040F6D             2291   
040F6D             2292   ; end of file
040F6D             2293   lp_loaded:
040F6D E1          2294   	pop hl
040F6E D1          2295   	pop de
040F6F C1          2296   	pop bc
040F70             2297   
040F70 C3 A0 0F 04 2298   	jp lp_close
040F74             2299   
040F74             2300   lp_close_error:
040F74 C5          2301   	push bc
040F75             2302   
040F75             2303   	; read error
040F75 CD 41 15 04 2304   	call fn_print_file_error
040F79             2305   
040F79 C1          2306   	pop bc
040F7A             2307   
040F7A             2308   	; close the file
040F7A             2309   	moscall mos_fclose
040F7A 3E 0B       0001M  		LD	A, function
040F7C 49 CF       0002M  		RST.LIS	08h
040F7E             2310   
040F7E             2311   	; set path to home
040F7E 21 9C 18 04 2312   	ld hl,back_path
040F82             2313   	moscall mos_cd
040F82 3E 03       0001M  		LD	A, function
040F84 49 CF       0002M  		RST.LIS	08h
040F86             2314   
040F86             2315   	; exit on error
040F86 FE 00       2316   	cp 0
040F88 C2 90 0F 04 2317   	jp nz,lp_folder_error
040F8C             2318   
040F8C C3 E9 10 04 2319   	jp lp_exit
040F90             2320   
040F90             2321   lp_folder_error:
040F90             2322   	; write error
040F90 CD 78 15 04 2323   	call fn_print_folder_error
040F94 C3 E9 10 04 2324   	jp lp_exit
040F98             2325   
040F98             2326   lp_header_error:
040F98             2327   	; write error
040F98 CD AF 15 04 2328   	call fn_print_header_error
040F9C C3 E9 10 04 2329   	jp lp_exit
040FA0             2330   
040FA0             2331   lp_close:
040FA0 C5          2332   	push bc
040FA1             2333   
040FA1             2334   	; close the file
040FA1             2335   	moscall mos_fclose
040FA1 3E 0B       0001M  		LD	A, function
040FA3 49 CF       0002M  		RST.LIS	08h
040FA5             2336   
040FA5 C1          2337   	pop bc
040FA6             2338   
040FA6             2339   	; set path to home
040FA6 21 9C 18 04 2340   	ld hl,back_path
040FAA             2341   	moscall mos_cd
040FAA 3E 03       0001M  		LD	A, function
040FAC 49 CF       0002M  		RST.LIS	08h
040FAE             2342   
040FAE             2343   	; exit on error
040FAE FE 00       2344   	cp 0
040FB0 C2 90 0F 04 2345   	jp nz,lp_folder_error
040FB4             2346   
040FB4             2347   	; read the number of colors we have in the palette
040FB4 21 41 39 04 2348   	ld hl,color_buffer
040FB8 7E          2349   	ld a,(hl)
040FB9 47          2350   	ld b,a
040FBA 23          2351   	inc hl
040FBB 7E          2352   	ld a,(hl)
040FBC 4F          2353   	ld c,a ; bc = 1st char, 2nd char or CR
040FBD             2354   
040FBD             2355   	; first is a char number ?
040FBD 78          2356   	ld a,b
040FBE FE 30       2357   	cp 48
040FC0 DA EF 10 04 2358   	jp c,lp_data_error
040FC4 FE 3A       2359   	cp 58
040FC6 D2 EF 10 04 2360   	jp nc,lp_data_error
040FCA             2361   
040FCA 79          2362   	ld a,c
040FCB FE 0D       2363   	cp 13
040FCD C2 EF 0F 04 2364   	jp nz,lp_two_numbers
040FD1             2365   
040FD1             2366   ; only one number
040FD1 78          2367   	ld a,b
040FD2 D6 30       2368   	sub 48
040FD4             2369   
040FD4 21 24 19 04 2370   	ld hl,new_colors_count
040FD8 77          2371   	ld (hl),a
040FD9             2372   
040FD9 FE 00       2373   	cp 0
040FDB CA EF 10 04 2374   	jp z,lp_data_error
040FDF FE 03       2375   	cp 3
040FE1 DA 24 10 04 2376   	jp c,lp_two_colors
040FE5 FE 05       2377   	cp 5
040FE7 DA 45 10 04 2378   	jp c,lp_four_colors
040FEB             2379   
040FEB C3 66 10 04 2380   	jp lp_sixteen_colors
040FEF             2381   
040FEF             2382   ; two numbers
040FEF             2383   lp_two_numbers:
040FEF 79          2384   	ld a,c
040FF0 FE 30       2385   	cp 48
040FF2 DA EF 10 04 2386   	jp c,lp_data_error
040FF6 FE 3A       2387   	cp 58
040FF8 D2 EF 10 04 2388   	jp nc,lp_data_error
040FFC             2389   
040FFC 78          2390   	ld a,b
040FFD D6 30       2391   	sub 48
040FFF 01 00 00 00 2392   	ld bc,#000000
041003 47          2393   	ld b,a
041004 0E 0A       2394   	ld c,10
041006 ED 4C       2395   	mlt bc
041008 81          2396   	add a,c
041009             2397   
041009 21 24 19 04 2398   	ld hl,new_colors_count
04100D 77          2399   	ld (hl),a
04100E             2400   
04100E FE 0A       2401   	cp 10
041010 DA EF 10 04 2402   	jp c,lp_data_error
041014 FE 11       2403   	cp 17
041016 DA 66 10 04 2404   	jp c,lp_sixteen_colors
04101A FE 41       2405   	cp 65
04101C DA 87 10 04 2406   	jp c,lp_sixty_four_colors
041020             2407   
041020 C3 EF 10 04 2408   	jp lp_data_error
041024             2409   
041024             2410   lp_two_colors:
041024 21 23 19 04 2411   	ld hl,colors_count
041028 3E 02       2412   	ld a,2
04102A 77          2413   	ld (hl),a
04102B             2414   
04102B 47          2415   	ld b,a
04102C 21 04 18 04 2416   	ld hl,current_pen
041030 7E          2417   	ld a,(hl)
041031 B8          2418   	cp b
041032 38 02       2419   	jr c,lptc_done
041034 05          2420   	dec b
041035 70          2421   	ld (hl),b
041036             2422   
041036             2423   lptc_done:
041036 21 24 19 04 2424   	ld hl,new_colors_count
04103A 7E          2425   	ld a,(hl) ; real number of coulours
04103B 06 00       2426   	ld b,0 ; start wit color 0
04103D 21 44 39 04 2427   	ld hl,palette_buffer ; palette will be got here
041041 C3 A8 10 04 2428   	jp lp_read_colors
041045             2429   
041045             2430   lp_four_colors:
041045 21 23 19 04 2431   	ld hl,colors_count
041049 3E 04       2432   	ld a,4
04104B 77          2433   	ld (hl),a
04104C             2434   
04104C 47          2435   	ld b,a
04104D 21 04 18 04 2436   	ld hl,current_pen
041051 7E          2437   	ld a,(hl)
041052 B8          2438   	cp b
041053 38 02       2439   	jr c,lpfc_done
041055 05          2440   	dec b
041056 70          2441   	ld (hl),b
041057             2442   
041057             2443   lpfc_done:
041057 21 24 19 04 2444   	ld hl,new_colors_count
04105B 7E          2445   	ld a,(hl) ; real number of coulours
04105C 06 00       2446   	ld b,0 ; start wit color 0
04105E 21 44 39 04 2447   	ld hl,palette_buffer ; palette will be got here
041062 C3 A8 10 04 2448   	jp lp_read_colors
041066             2449   
041066             2450   lp_sixteen_colors:
041066 21 23 19 04 2451   	ld hl,colors_count
04106A 3E 10       2452   	ld a,16
04106C 77          2453   	ld (hl),a
04106D             2454   
04106D 47          2455   	ld b,a
04106E 21 04 18 04 2456   	ld hl,current_pen
041072 7E          2457   	ld a,(hl)
041073 B8          2458   	cp b
041074 38 02       2459   	jr c,lpsc_done
041076 05          2460   	dec b
041077 70          2461   	ld (hl),b
041078             2462   
041078             2463   lpsc_done:
041078 21 24 19 04 2464   	ld hl,new_colors_count
04107C 7E          2465   	ld a,(hl) ; real number of coulours
04107D 06 00       2466   	ld b,0 ; start wit color 0
04107F 21 44 39 04 2467   	ld hl,palette_buffer ; palette will be got here
041083 C3 A8 10 04 2468   	jp lp_read_colors
041087             2469   
041087             2470   lp_sixty_four_colors:
041087 21 23 19 04 2471   	ld hl,colors_count
04108B 3E 40       2472   	ld a,64
04108D 77          2473   	ld (hl),a
04108E             2474   
04108E 47          2475   	ld b,a
04108F 21 04 18 04 2476   	ld hl,current_pen
041093 7E          2477   	ld a,(hl)
041094 B8          2478   	cp b
041095 38 02       2479   	jr c,lpsfc_done
041097 05          2480   	dec b
041098 70          2481   	ld (hl),b
041099             2482   
041099             2483   lpsfc_done:
041099 21 24 19 04 2484   	ld hl,new_colors_count
04109D 7E          2485   	ld a,(hl) ; real number of coulours
04109E 06 00       2486   	ld b,0 ; start wit color 0
0410A0 21 44 39 04 2487   	ld hl,palette_buffer ; palette will be taken here
0410A4 C3 A8 10 04 2488   	jp lp_read_colors
0410A8             2489   
0410A8             2490   lp_read_colors:
0410A8 F5          2491   	push af
0410A9             2492   
0410A9 CD 07 11 04 2493   	call lp_read_tint ; read red tint
0410AD FE FF       2494   	cp 255
0410AF CA EA 10 04 2495   	jp z,lp_wrong_exit
0410B3             2496   
0410B3 E5          2497   	push hl
0410B4 21 25 19 04 2498   	ld hl,red_tint
0410B8 77          2499   	ld (hl),a
0410B9 E1          2500   	pop hl
0410BA             2501   
0410BA CD 07 11 04 2502   	call lp_read_tint ; read green tint
0410BE FE FF       2503   	cp 255
0410C0 CA EA 10 04 2504   	jp z,lp_wrong_exit
0410C4             2505   
0410C4 E5          2506   	push hl
0410C5 21 26 19 04 2507   	ld hl,green_tint
0410C9 77          2508   	ld (hl),a
0410CA E1          2509   	pop hl
0410CB             2510   
0410CB CD 07 11 04 2511   	call lp_read_tint ; read blue tint
0410CF FE FF       2512   	cp 255
0410D1 CA EA 10 04 2513   	jp z,lp_wrong_exit
0410D5             2514   
0410D5 E5          2515   	push hl
0410D6 21 27 19 04 2516   	ld hl,blue_tint
0410DA 77          2517   	ld (hl),a
0410DB E1          2518   	pop hl
0410DC             2519   
0410DC CD 94 11 04 2520   	call lp_set_tint
0410E0             2521   
0410E0 F1          2522   	pop af
0410E1             2523   
0410E1 04          2524   	inc b ; increment number of colors
0410E2 3D          2525   	dec a ; decrement real number of colors
0410E3 FE 00       2526   	cp 0
0410E5 C2 A8 10 04 2527   	jp nz,lp_read_colors
0410E9             2528   
0410E9             2529   lp_exit:
0410E9 C9          2530   	ret
0410EA             2531   
0410EA             2532   lp_wrong_exit:
0410EA F1          2533   	pop af
0410EB C3 EF 10 04 2534   	jp lp_data_error
0410EF             2535   
0410EF             2536   lp_data_error:
0410EF CD E6 15 04 2537   	call fn_print_data_error
0410F3 C9          2538   	ret
0410F4             2539   
0410F4             2540   lp_file_error:
0410F4 CD 41 15 04 2541   	call fn_print_file_error
0410F8             2542   
0410F8             2543   	; set path to home
0410F8 21 9C 18 04 2544   	ld hl,back_path
0410FC             2545   	moscall mos_cd
0410FC 3E 03       0001M  		LD	A, function
0410FE 49 CF       0002M  		RST.LIS	08h
041100             2546   
041100             2547   	; exit on error
041100 FE 00       2548   	cp 0
041102 C2 90 0F 04 2549   	jp nz,lp_folder_error
041106             2550   
041106 C9          2551   	ret
041107             2552   
041107             2553   lp_read_tint:
041107 0E 00       2554   	ld c,0 ; number of chars readen for a single string number
041109 11 89 3C 04 2555   	ld de,temp_chars_buffer ; temp buffer for a string number
04110D             2556   
04110D             2557   	; read next string number
04110D CD 78 11 04 2558   	call lprt_read_chars
041111             2559   
041111 79          2560   	ld a,c
041112 FE 00       2561   	cp 0 ; no numbers
041114 CA 2E 11 04 2562   	jp z,lprt_exit
041118 FE 04       2563   	cp 4 ; too many numbers
04111A D2 2E 11 04 2564   	jp nc,lprt_exit
04111E             2565   
04111E FE 03       2566   	cp 3
041120 28 2A       2567   	jr z,lprt_three_int
041122             2568   
041122 FE 02       2569   	cp 2
041124 28 0B       2570   	jr z,lprt_two_int
041126             2571   
041126             2572   	; one int only
041126 11 89 3C 04 2573   	ld de,temp_chars_buffer
04112A 1A          2574   	ld a,(de)
04112B D6 30       2575   	sub 48
04112D C9          2576   	ret
04112E             2577   
04112E             2578   lprt_exit:
04112E 3E FF       2579   	ld a,255
041130 C9          2580   	ret
041131             2581   
041131             2582   ; two int
041131             2583   lprt_two_int:
041131 C5          2584   	push bc
041132 11 89 3C 04 2585   	ld de,temp_chars_buffer
041136 1A          2586   	ld a,(de)
041137 D6 30       2587   	sub 48
041139 D5          2588   	push de
04113A 11 00 00 00 2589   	ld de,#000000
04113E 5F          2590   	ld e,a
04113F 16 0A       2591   	ld d,10
041141 ED 5C       2592   	mlt de
041143 43          2593   	ld b,e
041144 D1          2594   	pop de
041145 13          2595   	inc de
041146 1A          2596   	ld a,(de)
041147 D6 30       2597   	sub 48
041149 80          2598   	add a,b ; full int value is here
04114A C1          2599   	pop bc
04114B C9          2600   	ret
04114C             2601   
04114C             2602   ; three int
04114C             2603   lprt_three_int:
04114C C5          2604   	push bc
04114D 11 89 3C 04 2605   	ld de,temp_chars_buffer
041151 1A          2606   	ld a,(de)
041152 D6 30       2607   	sub 48
041154 D5          2608   	push de
041155 11 00 00 00 2609   	ld de,#000000
041159 5F          2610   	ld e,a
04115A 16 64       2611   	ld d,100
04115C ED 5C       2612   	mlt de
04115E 43          2613   	ld b,e
04115F D1          2614   	pop de
041160 13          2615   	inc de
041161 1A          2616   	ld a,(de)
041162 D6 30       2617   	sub 48
041164 D5          2618   	push de
041165 11 00 00 00 2619   	ld de,#000000
041169 5F          2620   	ld e,a
04116A 16 0A       2621   	ld d,10
04116C ED 5C       2622   	mlt de
04116E 4B          2623   	ld c,e
04116F D1          2624   	pop de
041170 13          2625   	inc de
041171 1A          2626   	ld a,(de)
041172 D6 30       2627   	sub 48
041174 81          2628   	add a,c
041175 80          2629   	add a,b ; full int value is here
041176 C1          2630   	pop bc
041177 C9          2631   	ret
041178             2632   
041178             2633   lprt_read_chars:
041178 3E 0D       2634   	ld a,13
04117A 12          2635   	ld (de),a ; store eol as next default temp char
04117B             2636   
04117B 7E          2637   	ld a,(hl) ; get the new char in the palette buffer
04117C 23          2638   	inc hl
04117D             2639   
04117D FE 20       2640   	cp 32
04117F C8          2641   	ret z ; ret if space
041180 FE 0D       2642   	cp 13
041182 28 F4       2643   	jr z,lprt_read_chars ; loop if CR
041184 FE 0A       2644   	cp 10
041186 C8          2645   	ret z ; ret if LF
041187 FE 30       2646   	cp 48
041189 D8          2647   	ret c ; ret if not number
04118A FE 3A       2648   	cp 58
04118C D0          2649   	ret nc ; ret if not number
04118D             2650   
04118D             2651   ; found a number, store it
04118D 12          2652   	ld (de),a
04118E 13          2653   	inc de
04118F 0C          2654   	inc c
041190 C3 78 11 04 2655   	jp lprt_read_chars
041194             2656   
041194             2657   ; set tint (RGB = c,e,l)
041194             2658   lp_set_tint:
041194 F5          2659   	push af
041195 C5          2660   	push bc
041196 D5          2661   	push de
041197 E5          2662   	push hl
041198             2663   
041198 C5          2664   	push bc
041199             2665   	vdu 19
041199 3E 13       0001M  		LD	A, function
04119B 49 D7       0002M  		RST.LIS	10h
04119D C1          2666   	pop bc
04119E 78          2667   	ld a,b
04119F             2668   	vdu_a
04119F 49 D7       0001M  		RST.LIS	10h
0411A1             2669   	vdu 255
0411A1 3E FF       0001M  		LD	A, function
0411A3 49 D7       0002M  		RST.LIS	10h
0411A5             2670   
0411A5 21 25 19 04 2671   	ld hl,red_tint
0411A9 7E          2672   	ld a,(hl)
0411AA             2673   	vdu_a
0411AA 49 D7       0001M  		RST.LIS	10h
0411AC             2674   
0411AC 21 26 19 04 2675   	ld hl,green_tint
0411B0 7E          2676   	ld a,(hl)
0411B1             2677   	vdu_a
0411B1 49 D7       0001M  		RST.LIS	10h
0411B3             2678   
0411B3 21 27 19 04 2679   	ld hl,blue_tint
0411B7 7E          2680   	ld a,(hl)
0411B8             2681   	vdu_a
0411B8 49 D7       0001M  		RST.LIS	10h
0411BA             2682   
0411BA E1          2683   	pop hl
0411BB D1          2684   	pop de
0411BC C1          2685   	pop bc
0411BD F1          2686   	pop af
0411BE C9          2687   	ret
0411BF             2688   
0411BF             2689   ; save the palette
0411BF             2690   fn_save_palette:
0411BF C9          2691   	ret
0411C0             2692   
0411C0             2693   ; load a sprite, giving its full name, with extension
0411C0             2694   fn_load_sprite:
0411C0             2695   	; clear the filename on the screen
0411C0 21 7A 18 04 2696   	ld hl,filename
0411C4 06 10       2697   	ld b,FILENAME_LENGTH
0411C6 AF          2698   	xor a
0411C7             2699   
0411C7             2700   ls_clear_filename:
0411C7 77          2701   	ld (hl),a
0411C8 23          2702   	inc hl
0411C9 10 FC       2703   	djnz ls_clear_filename
0411CB             2704   
0411CB             2705   	; get filename
0411CB CD 97 0D 04 2706   	call fn_input_text8
0411CF             2707   
0411CF             2708   	; set path to 'sprites/'
0411CF 21 8B 18 04 2709   	ld hl,sprite_path
0411D3             2710   	moscall mos_cd
0411D3 3E 03       0001M  		LD	A, function
0411D5 49 CF       0002M  		RST.LIS	08h
0411D7             2711   
0411D7             2712   	; exit on folder error
0411D7 FE 00       2713   	cp 0
0411D9 C2 AA 12 04 2714   	jp nz,ls_folder_error
0411DD             2715   
0411DD             2716   	; open the file for read
0411DD 21 7A 18 04 2717   	ld hl,filename
0411E1 0E 01       2718   	ld c,fa_open_existing|fa_read
0411E3             2719   	moscall mos_fopen
0411E3 3E 0A       0001M  		LD	A, function
0411E5 49 CF       0002M  		RST.LIS	08h
0411E7             2720   
0411E7             2721   	; exit on file error
0411E7 FE 00       2722   	cp 0
0411E9 CA DC 12 04 2723   	jp z,ls_file_error
0411ED             2724   
0411ED             2725   	; filehandle -> C
0411ED 4F          2726   	ld c,a
0411EE             2727   
0411EE             2728   	; get colors count
0411EE             2729   	moscall mos_fgetc
0411EE 3E 0C       0001M  		LD	A, function
0411F0 49 CF       0002M  		RST.LIS	08h
0411F2 DA 85 12 04 2730   	jp c,ls_close_error
0411F6             2731   
0411F6 FE 41       2732   	cp MAX_COLORS + 1
0411F8 D2 85 12 04 2733   	jp nc,ls_close_error
0411FC             2734   
0411FC             2735   	; store colors count
0411FC 21 23 19 04 2736   	ld hl,colors_count
041200 77          2737   	ld (hl),a
041201             2738   
041201             2739   	; redraw palette
041201 C5          2740   	push bc
041202 CD 65 17 04 2741   	call fn_draw_the_palette
041206 C1          2742   	pop bc
041207             2743   
041207             2744   	; get frames count
041207             2745   	moscall mos_fgetc
041207 3E 0C       0001M  		LD	A, function
041209 49 CF       0002M  		RST.LIS	08h
04120B DA 85 12 04 2746   	jp c,ls_close_error
04120F             2747   
04120F             2748   	; store frames count
04120F 21 29 19 04 2749   	ld hl,frames_count
041213 77          2750   	ld (hl),a
041214             2751   
041214             2752   	; set last frame as current frame
041214 21 28 19 04 2753   	ld hl,current_frame
041218 3D          2754   	dec a
041219 77          2755   	ld (hl),a
04121A             2756   
04121A             2757   	; get sprite size
04121A             2758   	moscall mos_fgetc
04121A 3E 0C       0001M  		LD	A, function
04121C 49 CF       0002M  		RST.LIS	08h
04121E DA 85 12 04 2759   	jp c,ls_close_error
041222             2760   
041222             2761   	; store sprite size
041222 21 03 18 04 2762   	ld hl,spr_size
041226 77          2763   	ld (hl),a
041227             2764   
041227             2765   	; set 4x4 pixel width
041227 FE 04       2766   	cp SPR44
041229 20 09       2767   	jr nz,ls_next1
04122B             2768   
04122B 21 02 18 04 2769   	ld hl,pixel_width
04122F 06 20       2770   	ld b,SPR44_width
041231 70          2771   	ld (hl),b
041232 18 21       2772   	jr ls_next4
041234             2773   
041234             2774   ls_next1:
041234             2775   	; set 8x8 pixel width
041234 FE 08       2776   	cp SPR88
041236 20 09       2777   	jr nz,ls_next2
041238             2778   
041238 21 02 18 04 2779   	ld hl,pixel_width
04123C 06 10       2780   	ld b,SPR88_width
04123E 70          2781   	ld (hl),b
04123F 18 14       2782   	jr ls_next4
041241             2783   
041241             2784   ls_next2:
041241             2785   
041241             2786   	; set 16x16 pixel width
041241 FE 10       2787   	cp SPR1616
041243 20 09       2788   	jr nz,ls_next3
041245             2789   
041245 21 02 18 04 2790   	ld hl,pixel_width
041249 06 08       2791   	ld b,SPR1616_width
04124B 70          2792   	ld (hl),b
04124C 18 07       2793   	jr ls_next4
04124E             2794   
04124E             2795   ls_next3:
04124E             2796   
04124E 21 02 18 04 2797   	ld hl,pixel_width
041252 06 04       2798   	ld b,SPR3232_width
041254 70          2799   	ld (hl),b
041255             2800   
041255             2801   ls_next4:
041255 21 00 00 00 2802   	ld hl,#000000
041259 6F          2803   	ld l,a
04125A 67          2804   	ld h,a
04125B ED 6C       2805   	mlt hl ; one frame sprite length
04125D E5          2806   	push hl
04125E             2807   
04125E             2808   	; get frames count
04125E 21 29 19 04 2809   	ld hl,frames_count
041262 46          2810   	ld b,(hl)
041263             2811   
041263 E1          2812   	pop hl
041264             2813   
041264 05          2814   	dec b
041265 78          2815   	ld a,b
041266 FE 00       2816   	cp 0
041268 28 05       2817   	jr z,ls_read_data
04126A             2818   
04126A             2819   	; de = one frame sprite length
04126A E5          2820   	push hl
04126B D1          2821   	pop de
04126C             2822   ls_add_length:
04126C 19          2823   	add hl,de
04126D 10 FD       2824   	djnz ls_add_length
04126F             2825   
04126F             2826   ls_read_data:
04126F E5          2827   	push hl ; all frames length
041270 E5          2828   	push hl
041271 D1          2829   	pop de
041272 21 31 19 04 2830   	ld hl,sprite_buffer
041276             2831   	moscall mos_fread
041276 3E 1A       0001M  		LD	A, function
041278 49 CF       0002M  		RST.LIS	08h
04127A E1          2832   	pop hl ; frame length
04127B B7          2833   	or a
04127C ED 52       2834   	sbc hl,de
04127E 19          2835   	add hl,de ; compare frame length with loaded bytes
04127F 20 04       2836   	jr nz,ls_close_error
041281 C3 B2 12 04 2837   	jp ls_close
041285             2838   
041285             2839   ls_close_error:
041285 C5          2840   	push bc
041286             2841   
041286             2842   	; read error
041286 CD 41 15 04 2843   	call fn_print_file_error
04128A             2844   
04128A C1          2845   	pop bc
04128B             2846   
04128B             2847   	; close the file
04128B             2848   	moscall mos_fclose
04128B 3E 0B       0001M  		LD	A, function
04128D 49 CF       0002M  		RST.LIS	08h
04128F             2849   
04128F             2850   	; set path to home
04128F 21 9C 18 04 2851   	ld hl,back_path
041293             2852   	moscall mos_cd
041293 3E 03       0001M  		LD	A, function
041295 49 CF       0002M  		RST.LIS	08h
041297             2853   
041297             2854   	; exit on error
041297 FE 00       2855   	cp 0
041299 C2 AA 12 04 2856   	jp nz,ls_folder_error
04129D             2857   
04129D             2858   
04129D             2859   	; reset current frame and coordinates of the drawing pixel
04129D 21 FE 17 04 2860   	ld hl,xpix
0412A1 AF          2861   	xor a
0412A2 77          2862   	ld (hl),a
0412A3 21 FF 17 04 2863   	ld hl,ypix
0412A7 77          2864   	ld (hl),a
0412A8 18 25       2865   	jr ls_exit
0412AA             2866   
0412AA             2867   ls_folder_error:
0412AA             2868   	; write error
0412AA CD 78 15 04 2869   	call fn_print_folder_error
0412AE C3 CF 12 04 2870   	jp ls_exit
0412B2             2871   
0412B2             2872   ls_close:
0412B2             2873   	; close the file
0412B2             2874   	moscall mos_fclose
0412B2 3E 0B       0001M  		LD	A, function
0412B4 49 CF       0002M  		RST.LIS	08h
0412B6             2875   
0412B6             2876   	; set path to home
0412B6 21 9C 18 04 2877   	ld hl,back_path
0412BA             2878   	moscall mos_cd
0412BA 3E 03       0001M  		LD	A, function
0412BC 49 CF       0002M  		RST.LIS	08h
0412BE             2879   
0412BE             2880   	; exit on error
0412BE FE 00       2881   	cp 0
0412C0 C2 AA 12 04 2882   	jp nz,ls_folder_error
0412C4             2883   
0412C4             2884   	; reset current frame and coordinates of the drawing pixel
0412C4 21 FE 17 04 2885   	ld hl,xpix
0412C8 AF          2886   	xor a
0412C9 77          2887   	ld (hl),a
0412CA 21 FF 17 04 2888   	ld hl,ypix
0412CE 77          2889   	ld (hl),a
0412CF             2890   
0412CF             2891   ls_exit:
0412CF CD C7 16 04 2892   	call fn_show_spr_descr
0412D3 CD 5D 16 04 2893   	call fn_change_frame
0412D7 CD 82 16 04 2894   	call fn_change_frames_count
0412DB C9          2895   	ret
0412DC             2896   
0412DC             2897   ls_file_error:
0412DC CD 41 15 04 2898   	call fn_print_file_error
0412E0             2899   
0412E0             2900   	; set path to home
0412E0 21 9C 18 04 2901   	ld hl,back_path
0412E4             2902   	moscall mos_cd
0412E4 3E 03       0001M  		LD	A, function
0412E6 49 CF       0002M  		RST.LIS	08h
0412E8             2903   
0412E8             2904   	; exit on error
0412E8 FE 00       2905   	cp 0
0412EA C2 AA 12 04 2906   	jp nz,ls_folder_error
0412EE             2907   
0412EE C9          2908   	ret
0412EF             2909   
0412EF             2910   ; save a sprite, giving its name
0412EF             2911   fn_save_sprite:
0412EF             2912   	; clear filename on the screen
0412EF 21 7A 18 04 2913   	ld hl,filename
0412F3 06 10       2914   	ld b,FILENAME_LENGTH
0412F5 AF          2915   	xor a
0412F6             2916   
0412F6             2917   ss_clear_filename:
0412F6 77          2918   	ld (hl),a
0412F7 23          2919   	inc hl
0412F8 10 FC       2920   	djnz ss_clear_filename
0412FA             2921   
0412FA             2922   	; get filename
0412FA CD 97 0D 04 2923   	call fn_input_text8
0412FE             2924   
0412FE             2925   	; set path to sprite path
0412FE 21 8B 18 04 2926   	ld hl,sprite_path
041302             2927   	moscall mos_cd
041302 3E 03       0001M  		LD	A, function
041304 49 CF       0002M  		RST.LIS	08h
041306             2928   
041306             2929   	; create it on error
041306 FE 00       2930   	cp 0
041308 F5          2931   	push af
041309 C4 5C 17 04 2932   	call nz,fn_create_sprite_folder
04130D F1          2933   	pop af
04130E 28 08       2934   	jr z,ss_next
041310             2935   
041310             2936   	; set path to sprite path
041310 21 8B 18 04 2937   	ld hl,sprite_path
041314             2938   	moscall mos_cd
041314 3E 03       0001M  		LD	A, function
041316 49 CF       0002M  		RST.LIS	08h
041318             2939   
041318             2940   ss_next:
041318             2941   	; exit on error
041318 FE 00       2942   	cp 0
04131A C2 AA 13 04 2943   	jp nz,ss_folder_error
04131E             2944   
04131E             2945   	; open the file for write
04131E 21 7A 18 04 2946   	ld hl,filename
041322 0E 0A       2947   	ld c,fa_create_always|fa_write
041324             2948   	moscall mos_fopen
041324 3E 0A       0001M  		LD	A, function
041326 49 CF       0002M  		RST.LIS	08h
041328             2949   
041328             2950   	; exit on error
041328 FE 00       2951   	cp 0
04132A CA E7 13 04 2952   	jp z,ss_file_error
04132E             2953   
04132E             2954   	; filehandle -> C
04132E 4F          2955   	ld c,a
04132F             2956   
04132F             2957   	; store colors count in the file
04132F 21 23 19 04 2958   	ld hl,colors_count
041333 46          2959   	ld b,(hl)
041334             2960   	moscall mos_fputc
041334 3E 0D       0001M  		LD	A, function
041336 49 CF       0002M  		RST.LIS	08h
041338             2961   
041338             2962   	; store frames count in the file
041338 21 29 19 04 2963   	ld hl,frames_count
04133C 46          2964   	ld b,(hl)
04133D             2965   	moscall mos_fputc
04133D 3E 0D       0001M  		LD	A, function
04133F 49 CF       0002M  		RST.LIS	08h
041341             2966   
041341             2967   	; store sprite size in the file
041341 21 03 18 04 2968   	ld hl,spr_size
041345 46          2969   	ld b,(hl)
041346             2970   	moscall mos_fputc
041346 3E 0D       0001M  		LD	A, function
041348 49 CF       0002M  		RST.LIS	08h
04134A             2971   
04134A             2972   	; de = size²
04134A 21 00 00 00 2973   	ld hl,#000000
04134E 68          2974   	ld l,b
04134F 60          2975   	ld h,b
041350 ED 6C       2976   	mlt hl ; HL = sprite length
041352 E5          2977   	push hl
041353             2978   
041353             2979   	; get frames count
041353 21 29 19 04 2980   	ld hl,frames_count
041357 46          2981   	ld b,(hl)
041358             2982   
041358 E1          2983   	pop hl
041359             2984   
041359 05          2985   	dec b
04135A 78          2986   	ld a,b
04135B FE 00       2987   	cp 0
04135D 28 05       2988   	jr z,ss_write_data
04135F             2989   
04135F E5          2990   	push hl
041360 D1          2991   	pop de
041361             2992   ss_add_length:
041361 19          2993   	add hl,de
041362 10 FD       2994   	djnz ss_add_length
041364             2995   
041364             2996   ss_write_data:
041364 E5          2997   	push hl
041365 E5          2998   	push hl
041366 D1          2999   	pop de
041367 21 31 19 04 3000   	ld hl,sprite_buffer
04136B             3001   	moscall mos_fwrite
04136B 3E 1B       0001M  		LD	A, function
04136D 49 CF       0002M  		RST.LIS	08h
04136F E1          3002   	pop hl
041370 B7          3003   	or a
041371 ED 52       3004   	sbc hl,de
041373 19          3005   	add hl,de
041374 20 04       3006   	jr nz,ss_close_error
041376 C3 B2 13 04 3007   	jp ss_close
04137A             3008   
04137A             3009   ss_close_error:
04137A C5          3010   	push bc
04137B             3011   
04137B             3012   	; write error
04137B CD 41 15 04 3013   	call fn_print_file_error
04137F             3014   
04137F C1          3015   	pop bc
041380             3016   
041380             3017   	; close the file
041380             3018   	moscall mos_fclose
041380 3E 0B       0001M  		LD	A, function
041382 49 CF       0002M  		RST.LIS	08h
041384             3019   
041384             3020   	; set path to home
041384 21 9C 18 04 3021   	ld hl,back_path
041388             3022   	moscall mos_cd
041388 3E 03       0001M  		LD	A, function
04138A 49 CF       0002M  		RST.LIS	08h
04138C             3023   
04138C             3024   	; exit on error
04138C FE 00       3025   	cp 0
04138E C2 AA 13 04 3026   	jp nz,ss_folder_error
041392             3027   
041392             3028   	; reset current frame and coordinates of the drawing pixel
041392 21 29 19 04 3029   	ld hl,frames_count
041396 7E          3030   	ld a,(hl)
041397 3D          3031   	dec a
041398 21 28 19 04 3032   	ld hl,current_frame
04139C 77          3033   	ld (hl),a
04139D 21 FE 17 04 3034   	ld hl,xpix
0413A1 AF          3035   	xor a
0413A2 77          3036   	ld (hl),a
0413A3 21 FF 17 04 3037   	ld hl,ypix
0413A7 77          3038   	ld (hl),a
0413A8 18 30       3039   	jr ss_exit
0413AA             3040   
0413AA             3041   ss_folder_error:
0413AA             3042   	; write error
0413AA CD 78 15 04 3043   	call fn_print_folder_error
0413AE C3 DA 13 04 3044   	jp ss_exit
0413B2             3045   
0413B2             3046   ss_close:
0413B2             3047   	; close the file
0413B2             3048   	moscall mos_fclose
0413B2 3E 0B       0001M  		LD	A, function
0413B4 49 CF       0002M  		RST.LIS	08h
0413B6             3049   
0413B6             3050   	; set path to home
0413B6 21 9C 18 04 3051   	ld hl,back_path
0413BA             3052   	moscall mos_cd
0413BA 3E 03       0001M  		LD	A, function
0413BC 49 CF       0002M  		RST.LIS	08h
0413BE             3053   
0413BE             3054   	; exit on error
0413BE FE 00       3055   	cp 0
0413C0 C2 AA 13 04 3056   	jp nz,ss_folder_error
0413C4             3057   
0413C4             3058   	; reset current frame and coordinates of the drawing pixel
0413C4 21 29 19 04 3059   	ld hl,frames_count
0413C8 7E          3060   	ld a,(hl)
0413C9 3D          3061   	dec a
0413CA 21 28 19 04 3062   	ld hl,current_frame
0413CE 77          3063   	ld (hl),a
0413CF 21 FE 17 04 3064   	ld hl,xpix
0413D3 AF          3065   	xor a
0413D4 77          3066   	ld (hl),a
0413D5 21 FF 17 04 3067   	ld hl,ypix
0413D9 77          3068   	ld (hl),a
0413DA             3069   
0413DA             3070   ss_exit:
0413DA CD C7 16 04 3071   	call fn_show_spr_descr
0413DE CD 5D 16 04 3072   	call fn_change_frame
0413E2 CD 82 16 04 3073   	call fn_change_frames_count
0413E6 C9          3074   	ret
0413E7             3075   
0413E7             3076   ss_file_error:
0413E7 CD 41 15 04 3077   	call fn_print_file_error
0413EB             3078   
0413EB             3079   	; set path to home
0413EB 21 9C 18 04 3080   	ld hl,back_path
0413EF             3081   	moscall mos_cd
0413EF 3E 03       0001M  		LD	A, function
0413F1 49 CF       0002M  		RST.LIS	08h
0413F3             3082   
0413F3             3083   	; exit on error
0413F3 FE 00       3084   	cp 0
0413F5 C2 AA 13 04 3085   	jp nz,ss_folder_error
0413F9 C9          3086   	ret
0413FA             3087   
0413FA             3088   ; export sprite data in assembly language, giving its name
0413FA             3089   fn_export_sprite:
0413FA             3090   	; clear filename
0413FA 21 7A 18 04 3091   	ld hl,filename
0413FE 06 10       3092   	ld b,FILENAME_LENGTH
041400 AF          3093   	xor a
041401             3094   
041401             3095   es_clear_filename:
041401 77          3096   	ld (hl),a
041402 23          3097   	inc hl
041403 10 FC       3098   	djnz es_clear_filename
041405             3099   
041405             3100   	; get filename
041405 CD 97 0D 04 3101   	call fn_input_text8
041409             3102   
041409             3103   	; set path to sprite path
041409 21 8B 18 04 3104   	ld hl,sprite_path
04140D             3105   	moscall mos_cd
04140D 3E 03       0001M  		LD	A, function
04140F 49 CF       0002M  		RST.LIS	08h
041411             3106   
041411             3107   	; create it on error
041411 FE 00       3108   	cp 0
041413 F5          3109   	push af
041414 C4 5C 17 04 3110   	call nz,fn_create_sprite_folder
041418 F1          3111   	pop af
041419 28 0E       3112   	jr z,es_next
04141B             3113   
04141B             3114   	; set path to sprite path
04141B 21 8B 18 04 3115   	ld hl,sprite_path
04141F             3116   	moscall mos_cd
04141F 3E 03       0001M  		LD	A, function
041421 49 CF       0002M  		RST.LIS	08h
041423             3117   
041423             3118   	; exit on error
041423 FE 00       3119   	cp 0
041425 C2 25 15 04 3120   	jp nz,es_folder_error
041429             3121   
041429             3122   es_next:
041429             3123   	; open the file for write
041429 21 7A 18 04 3124   	ld hl,filename
04142D 0E 0A       3125   	ld c,fa_create_always|fa_write
04142F             3126   	moscall mos_fopen
04142F 3E 0A       0001M  		LD	A, function
041431 49 CF       0002M  		RST.LIS	08h
041433             3127   
041433             3128   	; exit on error
041433 FE 00       3129   	cp 0
041435 CA 2E 15 04 3130   	jp z,es_file_error
041439             3131   
041439             3132   	; filehandle -> C
041439 4F          3133   	ld c,a
04143A             3134   
04143A             3135   
04143A             3136   	; L = first frame
04143A 3E 00       3137   	ld a,0
04143C 21 31 19 04 3138   	ld hl,sprite_buffer
041440 11 00 00 00 3139   	ld de,$000000
041444             3140   
041444             3141   es_frames_repeat:
041444 F5          3142   	push af
041445 E5          3143   	push hl
041446             3144   
041446 F5          3145   	push af
041447             3146   
041447             3147   	; start to write...
041447 1E 00       3148   	ld e,0 ; rows
041449             3149   
041449 06 3B       3150   	ld b,';'
04144B             3151   	moscall mos_fputc
04144B 3E 0D       0001M  		LD	A, function
04144D 49 CF       0002M  		RST.LIS	08h
04144F             3152   
04144F 06 20       3153   	ld b,' '
041451             3154   	moscall mos_fputc
041451 3E 0D       0001M  		LD	A, function
041453 49 CF       0002M  		RST.LIS	08h
041455             3155   
041455 06 46       3156   	ld b,'F'
041457             3157   	moscall mos_fputc
041457 3E 0D       0001M  		LD	A, function
041459 49 CF       0002M  		RST.LIS	08h
04145B             3158   
04145B 06 72       3159   	ld b,'r'
04145D             3160   	moscall mos_fputc
04145D 3E 0D       0001M  		LD	A, function
04145F 49 CF       0002M  		RST.LIS	08h
041461             3161   
041461 06 6D       3162   	ld b,'m'
041463             3163   	moscall mos_fputc
041463 3E 0D       0001M  		LD	A, function
041465 49 CF       0002M  		RST.LIS	08h
041467             3164   
041467 06 20       3165   	ld b,' '
041469             3166   	moscall mos_fputc
041469 3E 0D       0001M  		LD	A, function
04146B 49 CF       0002M  		RST.LIS	08h
04146D             3167   
04146D F1          3168   	pop af
04146E C6 30       3169   	add a,'0'
041470 47          3170   	ld b,a
041471             3171   	moscall mos_fputc
041471 3E 0D       0001M  		LD	A, function
041473 49 CF       0002M  		RST.LIS	08h
041475             3172   
041475 06 0D       3173   	ld b,13
041477             3174   	moscall mos_fputc
041477 3E 0D       0001M  		LD	A, function
041479 49 CF       0002M  		RST.LIS	08h
04147B             3175   
04147B 06 0A       3176   	ld b,10
04147D             3177   	moscall mos_fputc
04147D 3E 0D       0001M  		LD	A, function
04147F 49 CF       0002M  		RST.LIS	08h
041481             3178   
041481             3179   es_repeat:
041481             3180   
041481 06 44       3181   	ld b,'D'
041483             3182   	moscall mos_fputc
041483 3E 0D       0001M  		LD	A, function
041485 49 CF       0002M  		RST.LIS	08h
041487             3183   
041487 06 42       3184   	ld b,'B'
041489             3185   	moscall mos_fputc
041489 3E 0D       0001M  		LD	A, function
04148B 49 CF       0002M  		RST.LIS	08h
04148D             3186   
04148D 06 20       3187   	ld b,' '
04148F             3188   	moscall mos_fputc
04148F 3E 0D       0001M  		LD	A, function
041491 49 CF       0002M  		RST.LIS	08h
041493             3189   
041493 16 00       3190   	ld d,0 ; columns
041495             3191   
041495             3192   es_repeat_line:
041495 D5          3193   	push de
041496             3194   
041496 7E          3195   	ld a,(hl)
041497 23          3196   	inc hl
041498             3197   
041498             3198   	; convert A to BCD
041498 CD E1 17 04 3199   	call fn_hex2bcd
04149C             3200   
04149C             3201   	; write two numbers (chars)
04149C 5F          3202   	ld e,a
04149D E6 F0       3203   	and $f0
04149F 0F          3204   	rrca
0414A0 0F          3205   	rrca
0414A1 0F          3206   	rrca
0414A2 0F          3207   	rrca
0414A3 C6 30       3208   	add '0'
0414A5             3209   
0414A5 47          3210   	ld b,a
0414A6             3211   	moscall mos_fputc
0414A6 3E 0D       0001M  		LD	A, function
0414A8 49 CF       0002M  		RST.LIS	08h
0414AA             3212   
0414AA 7B          3213   	ld a,e
0414AB E6 0F       3214   	and $0f
0414AD C6 30       3215   	add '0'
0414AF             3216   
0414AF 47          3217   	ld b,a
0414B0             3218   	moscall mos_fputc
0414B0 3E 0D       0001M  		LD	A, function
0414B2 49 CF       0002M  		RST.LIS	08h
0414B4             3219   
0414B4 D1          3220   	pop de
0414B5 14          3221   	inc d
0414B6 3A 03 18 04 3222   	ld a,(spr_size)
0414BA BA          3223   	cp d
0414BB F5          3224   	push af
0414BC C4 DA 17 04 3225   	call nz,fn_comma
0414C0 F1          3226   	pop af
0414C1 C2 95 14 04 3227   	jp nz,es_repeat_line
0414C5             3228   
0414C5 06 0D       3229   	ld b,13 ; CR
0414C7             3230   	moscall mos_fputc
0414C7 3E 0D       0001M  		LD	A, function
0414C9 49 CF       0002M  		RST.LIS	08h
0414CB             3231   
0414CB 06 0A       3232   	ld b,10 ; LF
0414CD             3233   	moscall mos_fputc
0414CD 3E 0D       0001M  		LD	A, function
0414CF 49 CF       0002M  		RST.LIS	08h
0414D1             3234   
0414D1 1C          3235   	inc e
0414D2 3A 03 18 04 3236   	ld a,(spr_size)
0414D6 BB          3237   	cp e
0414D7 C2 81 14 04 3238   	jp nz,es_repeat
0414DB             3239   
0414DB 06 0D       3240   	ld b,13 ; CR
0414DD             3241   	moscall mos_fputc
0414DD 3E 0D       0001M  		LD	A, function
0414DF 49 CF       0002M  		RST.LIS	08h
0414E1             3242   
0414E1 06 0A       3243   	ld b,10 ; LF
0414E3             3244   	moscall mos_fputc
0414E3 3E 0D       0001M  		LD	A, function
0414E5 49 CF       0002M  		RST.LIS	08h
0414E7             3245   
0414E7 E1          3246   	pop hl
0414E8 D5          3247   	push de
0414E9 ED 5C       3248   	mlt de
0414EB 19          3249   	add hl,de
0414EC D1          3250   	pop de
0414ED F1          3251   	pop af
0414EE 3C          3252   	inc a
0414EF DD 21 29 19 3253   	ld ix,frames_count
       04          
0414F4 DD BE 00    3254   	cp (ix+0)
0414F7 C2 44 14 04 3255   	jp nz,es_frames_repeat
0414FB             3256   
0414FB             3257   	; close the file
0414FB             3258   	moscall mos_fclose
0414FB 3E 0B       0001M  		LD	A, function
0414FD 49 CF       0002M  		RST.LIS	08h
0414FF             3259   
0414FF             3260   	; set path to home
0414FF 21 9C 18 04 3261   	ld hl,back_path
041503             3262   	moscall mos_cd
041503 3E 03       0001M  		LD	A, function
041505 49 CF       0002M  		RST.LIS	08h
041507             3263   
041507             3264   	; exit on error
041507 FE 00       3265   	cp 0
041509 C2 25 15 04 3266   	jp nz,es_folder_error
04150D             3267   
04150D             3268   	; reset current frame and coordinates of the drawing pixel
04150D 21 29 19 04 3269   	ld hl,frames_count
041511 7E          3270   	ld a,(hl)
041512 3D          3271   	dec a
041513 21 28 19 04 3272   	ld hl,current_frame
041517 77          3273   	ld (hl),a
041518 21 FE 17 04 3274   	ld hl,xpix
04151C AF          3275   	xor a
04151D 77          3276   	ld (hl),a
04151E 21 FF 17 04 3277   	ld hl,ypix
041522 77          3278   	ld (hl),a
041523 18 08       3279   	jr es_exit
041525             3280   
041525             3281   es_folder_error:
041525             3282   	; write error
041525 CD 78 15 04 3283   	call fn_print_folder_error
041529 C3 2D 15 04 3284   	jp es_exit
04152D             3285   
04152D             3286   es_exit:
04152D C9          3287   	ret
04152E             3288   
04152E             3289   es_file_error:
04152E CD 41 15 04 3290   	call fn_print_file_error
041532             3291   
041532             3292   	; set path to home
041532 21 9C 18 04 3293   	ld hl,back_path
041536             3294   	moscall mos_cd
041536 3E 03       0001M  		LD	A, function
041538 49 CF       0002M  		RST.LIS	08h
04153A             3295   
04153A             3296   	; exit on error
04153A FE 00       3297   	cp 0
04153C C2 25 15 04 3298   	jp nz,es_folder_error
041540 C9          3299   	ret
041541             3300   
041541             3301   ; print 'file error'
041541             3302   fn_print_file_error:
041541             3303   	vdu 7
041541 3E 07       0001M  		LD	A, function
041543 49 D7       0002M  		RST.LIS	10h
041545             3304   
041545             3305   	; locate x,y
041545             3306   	vdu 31
041545 3E 1F       0001M  		LD	A, function
041547 49 D7       0002M  		RST.LIS	10h
041549             3307   	vdu FILENAME_X
041549 3E 07       0001M  		LD	A, function
04154B 49 D7       0002M  		RST.LIS	10h
04154D             3308   	vdu FILENAME_Y
04154D 3E 18       0001M  		LD	A, function
04154F 49 D7       0002M  		RST.LIS	10h
041551             3309   
041551             3310   	; print text
041551 21 BB 18 04 3311   	ld hl,file_error
041555 01 00 00 00 3312   	ld bc,0
041559 AF          3313   	xor a
04155A 49 DF       3314   	rst.lis $18
04155C             3315   
04155C CD 90 0D 04 3316   	call fn_input_key
041560             3317   
041560             3318   	; locate x,y
041560             3319   	vdu 31
041560 3E 1F       0001M  		LD	A, function
041562 49 D7       0002M  		RST.LIS	10h
041564             3320   	vdu FILENAME_X
041564 3E 07       0001M  		LD	A, function
041566 49 D7       0002M  		RST.LIS	10h
041568             3321   	vdu FILENAME_Y
041568 3E 18       0001M  		LD	A, function
04156A 49 D7       0002M  		RST.LIS	10h
04156C             3322   
04156C             3323   	; print text
04156C 21 A1 18 04 3324   	ld hl,void_filename
041570 01 00 00 00 3325   	ld bc,0
041574 AF          3326   	xor a
041575 49 DF       3327   	rst.lis $18
041577             3328   
041577 C9          3329   	ret
041578             3330   
041578             3331   ; print 'folder error'
041578             3332   fn_print_folder_error:
041578             3333   	vdu 7
041578 3E 07       0001M  		LD	A, function
04157A 49 D7       0002M  		RST.LIS	10h
04157C             3334   
04157C             3335   	; locate x,y
04157C             3336   	vdu 31
04157C 3E 1F       0001M  		LD	A, function
04157E 49 D7       0002M  		RST.LIS	10h
041580             3337   	vdu FILENAME_X
041580 3E 07       0001M  		LD	A, function
041582 49 D7       0002M  		RST.LIS	10h
041584             3338   	vdu FILENAME_Y
041584 3E 18       0001M  		LD	A, function
041586 49 D7       0002M  		RST.LIS	10h
041588             3339   
041588             3340   	; print text
041588 21 D5 18 04 3341   	ld hl,folder_error
04158C 01 00 00 00 3342   	ld bc,0
041590 AF          3343   	xor a
041591 49 DF       3344   	rst.lis $18
041593             3345   
041593 CD 90 0D 04 3346   	call fn_input_key
041597             3347   
041597             3348   	; locate x,y
041597             3349   	vdu 31
041597 3E 1F       0001M  		LD	A, function
041599 49 D7       0002M  		RST.LIS	10h
04159B             3350   	vdu FILENAME_X
04159B 3E 07       0001M  		LD	A, function
04159D 49 D7       0002M  		RST.LIS	10h
04159F             3351   	vdu FILENAME_Y
04159F 3E 18       0001M  		LD	A, function
0415A1 49 D7       0002M  		RST.LIS	10h
0415A3             3352   
0415A3             3353   	; print text
0415A3 21 A1 18 04 3354   	ld hl,void_filename
0415A7 01 00 00 00 3355   	ld bc,0
0415AB AF          3356   	xor a
0415AC 49 DF       3357   	rst.lis $18
0415AE             3358   
0415AE C9          3359   	ret
0415AF             3360   
0415AF             3361   ; print 'header error'
0415AF             3362   fn_print_header_error:
0415AF             3363   	vdu 7
0415AF 3E 07       0001M  		LD	A, function
0415B1 49 D7       0002M  		RST.LIS	10h
0415B3             3364   
0415B3             3365   	; locate x,y
0415B3             3366   	vdu 31
0415B3 3E 1F       0001M  		LD	A, function
0415B5 49 D7       0002M  		RST.LIS	10h
0415B7             3367   	vdu FILENAME_X
0415B7 3E 07       0001M  		LD	A, function
0415B9 49 D7       0002M  		RST.LIS	10h
0415BB             3368   	vdu FILENAME_Y
0415BB 3E 18       0001M  		LD	A, function
0415BD 49 D7       0002M  		RST.LIS	10h
0415BF             3369   
0415BF             3370   	; print text
0415BF 21 EF 18 04 3371   	ld hl,header_error
0415C3 01 00 00 00 3372   	ld bc,0
0415C7 AF          3373   	xor a
0415C8 49 DF       3374   	rst.lis $18
0415CA             3375   
0415CA CD 90 0D 04 3376   	call fn_input_key
0415CE             3377   
0415CE             3378   	; locate x,y
0415CE             3379   	vdu 31
0415CE 3E 1F       0001M  		LD	A, function
0415D0 49 D7       0002M  		RST.LIS	10h
0415D2             3380   	vdu FILENAME_X
0415D2 3E 07       0001M  		LD	A, function
0415D4 49 D7       0002M  		RST.LIS	10h
0415D6             3381   	vdu FILENAME_Y
0415D6 3E 18       0001M  		LD	A, function
0415D8 49 D7       0002M  		RST.LIS	10h
0415DA             3382   
0415DA             3383   	; print text
0415DA 21 A1 18 04 3384   	ld hl,void_filename
0415DE 01 00 00 00 3385   	ld bc,0
0415E2 AF          3386   	xor a
0415E3 49 DF       3387   	rst.lis $18
0415E5             3388   
0415E5 C9          3389   	ret
0415E6             3390   
0415E6             3391   ; print 'data error'
0415E6             3392   fn_print_data_error:
0415E6             3393   	vdu 7
0415E6 3E 07       0001M  		LD	A, function
0415E8 49 D7       0002M  		RST.LIS	10h
0415EA             3394   
0415EA             3395   	; locate x,y
0415EA             3396   	vdu 31
0415EA 3E 1F       0001M  		LD	A, function
0415EC 49 D7       0002M  		RST.LIS	10h
0415EE             3397   	vdu FILENAME_X
0415EE 3E 07       0001M  		LD	A, function
0415F0 49 D7       0002M  		RST.LIS	10h
0415F2             3398   	vdu FILENAME_Y
0415F2 3E 18       0001M  		LD	A, function
0415F4 49 D7       0002M  		RST.LIS	10h
0415F6             3399   
0415F6             3400   	; print text
0415F6 21 09 19 04 3401   	ld hl,data_error
0415FA 01 00 00 00 3402   	ld bc,0
0415FE AF          3403   	xor a
0415FF 49 DF       3404   	rst.lis $18
041601             3405   
041601 CD 90 0D 04 3406   	call fn_input_key
041605             3407   
041605             3408   	; locate x,y
041605             3409   	vdu 31
041605 3E 1F       0001M  		LD	A, function
041607 49 D7       0002M  		RST.LIS	10h
041609             3410   	vdu FILENAME_X
041609 3E 07       0001M  		LD	A, function
04160B 49 D7       0002M  		RST.LIS	10h
04160D             3411   	vdu FILENAME_Y
04160D 3E 18       0001M  		LD	A, function
04160F 49 D7       0002M  		RST.LIS	10h
041611             3412   
041611             3413   	; print text
041611 21 A1 18 04 3414   	ld hl,void_filename
041615 01 00 00 00 3415   	ld bc,0
041619 AF          3416   	xor a
04161A 49 DF       3417   	rst.lis $18
04161C             3418   
04161C C9          3419   	ret
04161D             3420   
04161D             3421   ; refresh all the current sprite frame
04161D             3422   fn_refresh_sprite:
04161D 06 00       3423   	ld b,0 ; B -> x cordinate
04161F 0E 00       3424   	ld c,0 ; C -> y cordinate
041621             3425   
041621             3426   rs_loop:
041621 C5          3427   	push bc
041622             3428   
041622 21 FE 17 04 3429   	ld hl,xpix
041626 70          3430   	ld (hl),b
041627 21 FF 17 04 3431   	ld hl,ypix
04162B 71          3432   	ld (hl),c
04162C CD 22 0C 04 3433   	call fn_draw_pixel_without_border
041630             3434   
041630 C1          3435   	pop bc
041631             3436   
041631 04          3437   	inc b
041632 21 03 18 04 3438   	ld hl,spr_size
041636 7E          3439   	ld a,(hl)
041637 B8          3440   	cp b
041638 28 04       3441   	jr z,rs_next_line
04163A C3 21 16 04 3442   	jp rs_loop
04163E             3443   
04163E             3444   rs_next_line:
04163E 06 00       3445   	ld b,0
041640 0C          3446   	inc c
041641 21 03 18 04 3447   	ld hl,spr_size
041645 7E          3448   	ld a,(hl)
041646 B9          3449   	cp c
041647 28 04       3450   	jr z,rs_end
041649 C3 21 16 04 3451   	jp rs_loop
04164D             3452   
04164D             3453   rs_end:
04164D AF          3454   	xor a
04164E 21 FE 17 04 3455   	ld hl,xpix
041652 77          3456   	ld (hl),a
041653 21 FF 17 04 3457   	ld hl,ypix
041657 77          3458   	ld (hl),a
041658 CD 0E 0C 04 3459   	call fn_draw_pixel_with_border
04165C             3460   
04165C C9          3461   	ret
04165D             3462   
04165D             3463   fn_change_frame:
04165D 21 28 19 04 3464   	ld hl,current_frame
041661 7E          3465   	ld a,(hl)
041662 3C          3466   	inc a
041663 C6 30       3467   	add a,48
041665 21 2A 19 04 3468   	ld hl,current_frame_ascii
041669 77          3469   	ld (hl),a
04166A             3470   
04166A             3471   	; locate 21,3
04166A             3472   	vdu 31
04166A 3E 1F       0001M  		LD	A, function
04166C 49 D7       0002M  		RST.LIS	10h
04166E             3473   	vdu 21
04166E 3E 15       0001M  		LD	A, function
041670 49 D7       0002M  		RST.LIS	10h
041672             3474   	vdu 3
041672 3E 03       0001M  		LD	A, function
041674 49 D7       0002M  		RST.LIS	10h
041676             3475   
041676             3476   	; print text
041676 21 2A 19 04 3477   	ld hl,current_frame_ascii
04167A 01 00 00 00 3478   	ld bc,0
04167E AF          3479   	xor a
04167F 49 DF       3480   	rst.lis $18
041681             3481   
041681 C9          3482   	ret
041682             3483   
041682             3484   fn_change_frames_count:
041682 21 29 19 04 3485   	ld hl,frames_count
041686 7E          3486   	ld a,(hl)
041687 C6 30       3487   	add a,48
041689 21 2C 19 04 3488   	ld hl,frames_count_ascii
04168D 77          3489   	ld (hl),a
04168E             3490   
04168E             3491   	; locate 23,3
04168E             3492   	vdu 31
04168E 3E 1F       0001M  		LD	A, function
041690 49 D7       0002M  		RST.LIS	10h
041692             3493   	vdu 23
041692 3E 17       0001M  		LD	A, function
041694 49 D7       0002M  		RST.LIS	10h
041696             3494   	vdu 3
041696 3E 03       0001M  		LD	A, function
041698 49 D7       0002M  		RST.LIS	10h
04169A             3495   
04169A             3496   	; print text
04169A 21 2C 19 04 3497   	ld hl,frames_count_ascii
04169E 01 00 00 00 3498   	ld bc,0
0416A2 AF          3499   	xor a
0416A3 49 DF       3500   	rst.lis $18
0416A5             3501   
0416A5 C9          3502   	ret
0416A6             3503   
0416A6             3504   ; slowdown (wait delay)
0416A6             3505   fn_slowdown:
0416A6 DD 21 2E 19 3506   	ld ix,keydata
       04          
0416AB DD 7E 02    3507   	ld a,(ix+2)
0416AE E6 02       3508   	and 2
0416B0 FE 02       3509   	cp 2 ; shift key to disable delay
0416B2 C8          3510   	ret z
0416B3             3511   
0416B3             3512   	moscall mos_sysvars
0416B3 3E 08       0001M  		LD	A, function
0416B5 49 CF       0002M  		RST.LIS	08h
0416B7 DD 4E 00    3513   	ld c,(ix+sysvar_time)
0416BA             3514   
0416BA             3515   sd_loop:
0416BA             3516   	moscall mos_sysvars
0416BA 3E 08       0001M  		LD	A, function
0416BC 49 CF       0002M  		RST.LIS	08h
0416BE DD 7E 00    3517   	ld a,(ix+sysvar_time)
0416C1 91          3518   	sub c
0416C2 FE 14       3519   	cp SLOWDOWN_DELAY
0416C4 20 F4       3520   	jr nz,sd_loop
0416C6 C9          3521   	ret
0416C7             3522   
0416C7             3523   fn_show_spr_descr:
0416C7             3524   	; locate 15,3
0416C7             3525   	vdu 31
0416C7 3E 1F       0001M  		LD	A, function
0416C9 49 D7       0002M  		RST.LIS	10h
0416CB             3526   	vdu 15
0416CB 3E 0F       0001M  		LD	A, function
0416CD 49 D7       0002M  		RST.LIS	10h
0416CF             3527   	vdu 3
0416CF 3E 03       0001M  		LD	A, function
0416D1 49 D7       0002M  		RST.LIS	10h
0416D3             3528   
0416D3             3529   	; print text
0416D3 21 4E 18 04 3530   	ld hl,spr_descr
0416D7 01 00 00 00 3531   	ld bc,0
0416DB AF          3532   	xor a
0416DC 49 DF       3533   	rst.lis $18
0416DE             3534   
0416DE             3535   	; locate 15,5
0416DE             3536   	vdu 31
0416DE 3E 1F       0001M  		LD	A, function
0416E0 49 D7       0002M  		RST.LIS	10h
0416E2             3537   	vdu 15
0416E2 3E 0F       0001M  		LD	A, function
0416E4 49 D7       0002M  		RST.LIS	10h
0416E6             3538   	vdu 5
0416E6 3E 05       0001M  		LD	A, function
0416E8 49 D7       0002M  		RST.LIS	10h
0416EA             3539   
0416EA             3540   	; check for sprite size...
0416EA 21 03 18 04 3541   	ld hl,spr_size
0416EE 7E          3542   	ld a,(hl)
0416EF             3543   
0416EF FE 04       3544   	cp 4
0416F1 20 0C       3545   	jr nz,ssd_8x8
0416F3             3546   
0416F3             3547   	; print text 4x4
0416F3 21 58 18 04 3548   	ld hl,spr_descr1
0416F7 01 00 00 00 3549   	ld bc,0
0416FB AF          3550   	xor a
0416FC 49 DF       3551   	rst.lis $18
0416FE C9          3552   	ret
0416FF             3553   
0416FF             3554   ssd_8x8:
0416FF FE 08       3555   	cp 8
041701 20 0C       3556   	jr nz,ssd_16x16
041703             3557   
041703             3558   	; print text 8x8
041703 21 5E 18 04 3559   	ld hl,spr_descr2
041707 01 00 00 00 3560   	ld bc,0
04170B AF          3561   	xor a
04170C 49 DF       3562   	rst.lis $18
04170E C9          3563   	ret
04170F             3564   
04170F             3565   ssd_16x16:
04170F FE 10       3566   	cp 16
041711 20 0C       3567   	jr nz,ssd_32x32
041713             3568   
041713             3569   	; print text 16x16
041713 21 64 18 04 3570   	ld hl,spr_descr3
041717 01 00 00 00 3571   	ld bc,0
04171B AF          3572   	xor a
04171C 49 DF       3573   	rst.lis $18
04171E C9          3574   	ret
04171F             3575   
04171F             3576   ssd_32x32:
04171F             3577   	; print text 32x32
04171F 21 6A 18 04 3578   	ld hl,spr_descr4
041723 01 00 00 00 3579   	ld bc,0
041727 AF          3580   	xor a
041728 49 DF       3581   	rst.lis $18
04172A             3582   
04172A C9          3583   	ret
04172B             3584   
04172B             3585   ; input: HL = negative key to check
04172B             3586   fn_inkey:
04172B             3587   	moscall mos_getkbmap
04172B 3E 1E       0001M  		LD	A, function
04172D 49 CF       0002M  		RST.LIS	08h
04172F 23          3588   	INC	HL
041730 7D          3589   	LD	A, L
041731 ED 44       3590   	NEG
041733 4F          3591   	LD	C, A
041734 3E 01       3592   	LD	A, 1
041736 FA 5A 17 04 3593   	JP	M,i_false ; < -128 ?
04173A             3594   
04173A 21 45 00 04 3595   	LD	HL,BITLOOKUP
04173E 11 00 00 00 3596   	LD	DE,0
041742 79          3597   	LD	A,C
041743 E6 07       3598   	AND	00000111b
041745 5F          3599   	LD	E,A
041746 19          3600   	ADD	HL,DE
041747 46          3601   	LD	B,(HL)
041748             3602   
041748 79          3603   	LD	A,C
041749 E6 78       3604   	AND	01111000b
04174B 0F          3605   	RRCA
04174C 0F          3606   	RRCA
04174D 0F          3607   	RRCA
04174E 5F          3608   	LD	E, A
04174F DD 19       3609   	ADD	IX,DE
041751 DD 7E 00    3610   	LD	A,(IX+0)
041754 A0          3611   	AND	B
041755 28 03       3612   	JR Z,i_false
041757 3E 01       3613   	LD A,1
041759 C9          3614   	RET
04175A             3615   i_false:
04175A AF          3616   	XOR A
04175B C9          3617   	RET
04175C             3618   
04175C             3619   fn_create_sprite_folder:
04175C 21 8B 18 04 3620   	ld hl,sprite_path
041760             3621   	moscall mos_mkdir
041760 3E 07       0001M  		LD	A, function
041762 49 CF       0002M  		RST.LIS	08h
041764 C9          3622   	ret
041765             3623   
041765             3624   ; draw the palette
041765             3625   fn_draw_the_palette:
041765 0E 00       3626   	ld c,0
041767             3627   
041767             3628   fndtp_palette_loop:
041767 C5          3629   	push bc
041768             3630   
041768             3631   	; choose palette color
041768             3632   	vdu 18
041768 3E 12       0001M  		LD	A, function
04176A 49 D7       0002M  		RST.LIS	10h
04176C             3633   	vdu 0
04176C 3E 00       0001M  		LD	A, function
04176E 49 D7       0002M  		RST.LIS	10h
041770 C1          3634   	pop bc
041771 C5          3635   	push bc
041772 79          3636   	ld a,c
041773 F5          3637   	push af
041774             3638   	vdu_a
041774 49 D7       0001M  		RST.LIS	10h
041776 F1          3639   	pop af
041777 E5          3640   	push hl
041778 21 23 19 04 3641   	ld hl,colors_count
04177C BE          3642   	cp (hl)
04177D E1          3643   	pop hl
04177E 38 0B       3644   	jr c,fndtppl_zap
041780             3645   
041780             3646   	; set 0 if color is out of palette
041780             3647   	vdu 18
041780 3E 12       0001M  		LD	A, function
041782 49 D7       0002M  		RST.LIS	10h
041784             3648   	vdu 0
041784 3E 00       0001M  		LD	A, function
041786 49 D7       0002M  		RST.LIS	10h
041788 AF          3649   	xor a
041789             3650   	vdu_a
041789 49 D7       0001M  		RST.LIS	10h
04178B             3651   
04178B             3652   fndtppl_zap:
04178B             3653   	; store coordinates for a palette square
04178B DD 21 EE 17 3654   	ld ix,x1
       04          
041790 E1          3655   	pop hl
041791 E5          3656   	push hl
041792 26 05       3657   	ld h,5
041794 ED 6C       3658   	mlt hl
041796 E5          3659   	push hl
041797 DD 75 00    3660   	ld (ix+0),l
04179A DD 74 01    3661   	ld (ix+1),h
04179D             3662   
04179D DD 21 F0 17 3663   	ld ix,y1
       04          
0417A2 21 00 00 00 3664   	ld hl,0
0417A6 DD 75 00    3665   	ld (ix+0),l
0417A9 DD 74 01    3666   	ld (ix+1),h
0417AC             3667   
0417AC DD 21 F2 17 3668   	ld ix,x2
       04          
0417B1 E1          3669   	pop hl
0417B2 11 04 00 00 3670   	ld de,4
0417B6 19          3671   	add hl,de
0417B7 DD 75 00    3672   	ld (ix+0),l
0417BA DD 74 01    3673   	ld (ix+1),h
0417BD             3674   
0417BD DD 21 F4 17 3675   	ld ix,y2
       04          
0417C2 21 0A 00 00 3676   	ld hl,10
0417C6 DD 75 00    3677   	ld (ix+0),l
0417C9 DD 74 01    3678   	ld (ix+1),h
0417CC             3679   
0417CC             3680   	; draw the palette filled square
0417CC CD 40 0B 04 3681   	call fn_rectf
0417D0             3682   
0417D0             3683   	; next color ?
0417D0 C1          3684   	pop bc
0417D1 0C          3685   	inc c
0417D2 79          3686   	ld a,c
0417D3 FE 40       3687   	cp MAX_COLORS
0417D5 C2 67 17 04 3688   	jp nz,fndtp_palette_loop
0417D9             3689   
0417D9 C9          3690   	ret
0417DA             3691   
0417DA             3692   fn_comma:
0417DA 06 2C       3693   	ld b,','
0417DC             3694   	moscall mos_fputc
0417DC 3E 0D       0001M  		LD	A, function
0417DE 49 CF       0002M  		RST.LIS	08h
0417E0 C9          3695   	ret
0417E1             3696   
0417E1             3697   ; Hex to BCD
0417E1             3698   ; converts a hex number (eg. $10) to its BCD representation (eg. $16).
0417E1             3699   ; Input: a = hex number
0417E1             3700   ; Output: a = BCD number
0417E1             3701   ; Clobbers: b,c
0417E1             3702   fn_hex2bcd:
0417E1 C5          3703   		push bc
0417E2 4F          3704   		ld c,a  ; Original (hex) number
0417E3 06 08       3705   		ld b,8  ; How many bits
0417E5 AF          3706   		xor a   ; Output (BCD) number, starts at 0
0417E6 CB 21       3707   htb:	sla c   ; shift c into carry
0417E8 8F          3708   		adc a,a
0417E9 27          3709   		daa     ; Decimal adjust a, so shift = BCD x2 plus carry
0417EA 10 FA       3710   		djnz htb  ; Repeat for 8 bits
0417EC C1          3711   		pop bc
0417ED C9          3712   		ret
0417EE             3713   
0417EE             3714   ;======================================================================
0417EE             3715   
0417EE             3716   ; coordinates for rectangles
0417EE             3717   x1:
0417EE 00 00       3718   	dw $0000
0417F0             3719   y1:
0417F0 00 00       3720   	dw $0000
0417F2             3721   x2:
0417F2 00 00       3722   	dw $0000
0417F4             3723   y2:
0417F4 00 00       3724   	dw $0000
0417F6             3725   
0417F6             3726   ; coordinates of the edited sprite
0417F6             3727   xs1:
0417F6 5F 00       3728   	dw 95
0417F8             3729   ys1:
0417F8 37 00       3730   	dw 55
0417FA             3731   xs2:
0417FA E0 00       3732   	dw 224
0417FC             3733   ys2:
0417FC B8 00       3734   	dw 184
0417FE             3735   
0417FE             3736   ; coordinates of active pixels to draw
0417FE             3737   xpix:
0417FE 00          3738   	db 0
0417FF             3739   ypix:
0417FF 00          3740   	db 0
041800             3741   
041800             3742   ; memorized coordinates of active pixels to draw
041800             3743   memxpix:
041800 00          3744   	db 0
041801             3745   memypix:
041801 00          3746   	db 0
041802             3747   
041802             3748   ; width of a pixel in the sprite
041802             3749   pixel_width:
041802 00          3750   	db 0
041803             3751   
041803             3752   ; sprite size, in resized pixels
041803             3753   spr_size:
041803 00          3754   	db 0
041804             3755   
041804             3756   ; pen color (0-63)
041804             3757   current_pen:
041804 00          3758   	db 0
041805             3759   
041805             3760   ; texts for 1st menu
041805             3761   title:
041805 53 50 52 2D 3762   	db "SPR-EDIT",0
       45 44 49 54 
       00          
04180E             3763   
04180E             3764   menu1:
04180E 46 31 2E 20 3765   	db "F1. 4x4 Sprite",0
       34 78 34 20 
       53 70 72 69 
       74 65 00    
04181D             3766   menu2:
04181D 46 32 2E 20 3767   	db "F2. 8x8 Sprite",0
       38 78 38 20 
       53 70 72 69 
       74 65 00    
04182C             3768   menu3:
04182C 46 33 2E 20 3769   	db "F3. 16x16 Sprite",0
       31 36 78 31 
       36 20 53 70 
       72 69 74 65 
       00          
04183D             3770   menu4:
04183D 46 34 2E 20 3771   	db "F4. 32x32 Sprite",0
       33 32 78 33 
       32 20 53 70 
       72 69 74 65 
       00          
04184E             3772   
04184E             3773   ; descriptions of sprites
04184E             3774   spr_descr:
04184E 46 72 61 6D 3775   	db "Frame:1/1",0
       65 3A 31 2F 
       31 00       
041858             3776   spr_descr1:
041858 34 78 34 20 3777   	db "4x4  ",0
       20 00       
04185E             3778   spr_descr2:
04185E 38 78 38 20 3779   	db "8x8  ",0
       20 00       
041864             3780   spr_descr3:
041864 31 36 78 31 3781   	db "16x16",0
       36 00       
04186A             3782   spr_descr4:
04186A 33 32 78 33 3783   	db "32x32",0
       32 00       
041870             3784   
041870             3785   ; label before filename
041870             3786   filename_label:
041870 46 69 6C 65 3787   	db "Filename:",0
       6E 61 6D 65 
       3A 00       
04187A             3788   
04187A             3789   ; filename without extension
04187A             3790   filename:
04187A             3791   	ds 17
04188B             3792   
04188B             3793   sprite_path:
04188B 73 70 72 69 3794   	db "sprites",0
       74 65 73 00 
041893             3795   
041893             3796   palette_path:
041893 70 61 6C 65 3797   	db "palettes",0
       74 74 65 73 
       00          
04189C             3798   
04189C             3799   back_path:
04189C 2E 2E 00    3800   	db "..",0
04189F             3801   
04189F             3802   ; single space char to print
04189F             3803   spacechar:
04189F 20 00       3804   	db " ",0
0418A1             3805   
0418A1             3806   ; spaces to remove filename label
0418A1             3807   void_filename:
0418A1 20 20 20 20 3808   	db "                         ",0
       20 20 20 20 
       20 20 20 20 
       20 20 20 20 
       20 20 20 20 
       20 20 20 20 
       20 00       
0418BB             3809   
0418BB             3810   ; file error message
0418BB             3811   file_error:
0418BB 46 69 6C 65 3812   	db "File error !             ",0
       20 65 72 72 
       6F 72 20 21 
       20 20 20 20 
       20 20 20 20 
       20 20 20 20 
       20 00       
0418D5             3813   
0418D5             3814   ; folder error message
0418D5             3815   folder_error:
0418D5 46 6F 6C 64 3816   	db "Folder error !           ",0
       65 72 20 65 
       72 72 6F 72 
       20 21 20 20 
       20 20 20 20 
       20 20 20 20 
       20 00       
0418EF             3817   
0418EF             3818   ; header error message
0418EF             3819   header_error:
0418EF 48 65 61 64 3820   	db "Header error !           ",0
       65 72 20 65 
       72 72 6F 72 
       20 21 20 20 
       20 20 20 20 
       20 20 20 20 
       20 00       
041909             3821   
041909             3822   ; data error message
041909             3823   data_error:
041909 44 61 74 61 3824   	db "Data error !             ",0
       20 65 72 72 
       6F 72 20 21 
       20 20 20 20 
       20 20 20 20 
       20 20 20 20 
       20 00       
041923             3825   
041923             3826   ; number of colors
041923             3827   colors_count:
041923 00          3828   	db 0
041924             3829   
041924             3830   ; real number of colors
041924             3831   new_colors_count:
041924 00          3832   	db 0
041925             3833   
041925             3834   red_tint:
041925 00          3835   	db 0
041926             3836   
041926             3837   green_tint:
041926 00          3838   	db 0
041927             3839   
041927             3840   blue_tint:
041927 00          3841   	db 0
041928             3842   
041928             3843   ; current frame
041928             3844   current_frame:
041928 00          3845   	db 0
041929             3846   
041929             3847   ; frames count
041929             3848   frames_count:
041929 00          3849   	db 0
04192A             3850   
04192A             3851   current_frame_ascii:
04192A 30 00       3852   	db '0',0
04192C             3853   
04192C             3854   frames_count_ascii:
04192C 30 00       3855   	db '0',0
04192E             3856   
04192E             3857   ; keycode, keydown & keymods are stored here
04192E             3858   keydata:
04192E 00 00 00    3859   	db 0,0,0
041931             3860   
041931             3861   ; buffer for the current sprite
041931             3862   sprite_buffer:
041931             3863   	ds BUFFER_SIZE
043931             3864   
043931             3865   header_buffer:
043931             3866   	ds HEADER_BUFFER_SIZE
043941             3867   
043941             3868   color_buffer:
043941 00 00 00    3869   	db 0,0,0
043944             3870   
043944             3871   palette_buffer:
043944             3872   	ds MAX_PAL_DATA + 1
043C89             3873   
043C89             3874   temp_chars_buffer:
043C89 00 00 00 00 3875   	db 0,0,0,0
043C8D             3876   
043C8D             3877   header:
043C8D 4A 41 53 43 3878   	db "JASC-PAL",13,10
       2D 50 41 4C 
       0D 0A       
043C97 30 31 30 30 3879   	db "0100",13,10
       0D 0A       
043C9D             3880   
043C9D             3881   ; buffer to perform some operations
043C9D             3882   swap_sprite_buffer:
043C9D             3883   	ds ONE_FRAME_BUFFER_SIZE
04409D             3884   
04409D             3885   asm_line:
04409D 44 42 20    3886   	DB "DB "
0440A0             3887   
0440A0             3888   asm_line_length:
0440A0 03          3889   	DB 3
0440A1             3890   
0440A1             3891   rgb_palette:
0440A1 00 00 00    3892   	db $00,$00,$00
0440A4 AA 00 00    3893   	db $AA,$00,$00
0440A7 00 AA 00    3894   	db $00,$AA,$00
0440AA AA AA 00    3895   	db $AA,$AA,$00
0440AD 00 00 AA    3896   	db $00,$00,$AA
0440B0 AA 00 AA    3897   	db $AA,$00,$AA
0440B3 00 AA AA    3898   	db $00,$AA,$AA
0440B6 AA AA AA    3899   	db $AA,$AA,$AA
0440B9             3900   
0440B9 55 55 55    3901   	db $55,$55,$55
0440BC FF 00 00    3902   	db $FF,$00,$00
0440BF 00 FF 00    3903   	db $00,$FF,$00
0440C2 FF FF 00    3904   	db $FF,$FF,$00
0440C5 00 00 FF    3905   	db $00,$00,$FF
0440C8 FF 00 FF    3906   	db $FF,$00,$FF
0440CB 00 FF FF    3907   	db $00,$FF,$FF
0440CE FF FF FF    3908   	db $FF,$FF,$FF
0440D1             3909   
0440D1 00 00 55    3910   	db $00,$00,$55
0440D4 00 55 00    3911   	db $00,$55,$00
0440D7 00 55 55    3912   	db $00,$55,$55
0440DA 00 55 AA    3913   	db $00,$55,$AA
0440DD 00 55 FF    3914   	db $00,$55,$FF
0440E0 00 AA 55    3915   	db $00,$AA,$55
0440E3 00 AA FF    3916   	db $00,$AA,$FF
0440E6 00 FF 55    3917   	db $00,$FF,$55
0440E9             3918   
0440E9 00 FF AA    3919   	db $00,$FF,$AA
0440EC 55 00 00    3920   	db $55,$00,$00
0440EF 55 00 55    3921   	db $55,$00,$55
0440F2 55 00 AA    3922   	db $55,$00,$AA
0440F5 55 00 FF    3923   	db $55,$00,$FF
0440F8 55 55 00    3924   	db $55,$55,$00
0440FB 55 55 AA    3925   	db $55,$55,$AA
0440FE 55 55 FF    3926   	db $55,$55,$FF
044101             3927   
044101 55 AA 00    3928   	db $55,$AA,$00
044104 55 AA 55    3929   	db $55,$AA,$55
044107 55 AA AA    3930   	db $55,$AA,$AA
04410A 55 AA FF    3931   	db $55,$AA,$FF
04410D 55 FF 00    3932   	db $55,$FF,$00
044110 55 FF 55    3933   	db $55,$FF,$55
044113 55 FF AA    3934   	db $55,$FF,$AA
044116 55 FF FF    3935   	db $55,$FF,$FF
044119             3936   
044119 AA 00 55    3937   	db $AA,$00,$55
04411C AA 00 FF    3938   	db $AA,$00,$FF
04411F AA 55 00    3939   	db $AA,$55,$00
044122 AA 55 55    3940   	db $AA,$55,$55
044125 AA 55 AA    3941   	db $AA,$55,$AA
044128 AA 55 FF    3942   	db $AA,$55,$FF
04412B AA AA 55    3943   	db $AA,$AA,$55
04412E AA AA FF    3944   	db $AA,$AA,$FF
044131             3945   
044131 AA FF 00    3946   	db $AA,$FF,$00
044134 AA FF 55    3947   	db $AA,$FF,$55
044137 AA FF AA    3948   	db $AA,$FF,$AA
04413A AA FF FF    3949   	db $AA,$FF,$FF
04413D FF 00 55    3950   	db $FF,$00,$55
044140 FF 00 AA    3951   	db $FF,$00,$AA
044143 FF 55 00    3952   	db $FF,$55,$00
044146 FF 55 55    3953   	db $FF,$55,$55
044149             3954   
044149 FF 55 AA    3955   	db $FF,$55,$AA
04414C FF 55 FF    3956   	db $FF,$55,$FF
04414F FF AA 00    3957   	db $FF,$AA,$00
044152 FF AA 55    3958   	db $FF,$AA,$55
044155 FF AA AA    3959   	db $FF,$AA,$AA
044158 FF AA FF    3960   	db $FF,$AA,$FF
04415B FF FF 55    3961   	db $FF,$FF,$55
04415E FF FF AA    3962   	db $FF,$FF,$AA
044161             3963   
044161             3964   ; sprite structure:
044161             3965   ; =================
044161             3966   ; colors_count  :   byte
044161             3967   ; frames count	:	byte
044161             3968   ; spr size		:	byte
044161             3969   ; data			:   width x height bytes of colors
044161             3970   
044161             3971   ; ===============================================
044161             3972   ; A = byte to debug
044161             3973   debug_byte:
044161 F5          3974   	PUSH AF
044162 C5          3975   	PUSH BC
044163 D5          3976   	PUSH DE
044164 E5          3977   	PUSH HL
044165 21 00 00 00 3978   	LD HL,$000000
044169 6F          3979   	LD L,A
04416A 11 A6 41 04 3980   	LD DE,debug_text
04416E D5          3981   	PUSH DE
04416F CD AC 41 04 3982   	CALL num2dec
044173 E1          3983   	POP HL
044174 23          3984   	INC HL
044175 23          3985   	INC HL
044176 01 03 00 00 3986   	LD BC,3
04417A 3E 00       3987   	LD A,0
04417C 49 DF       3988   	RST.LIS $18
04417E E1          3989   	POP HL
04417F D1          3990   	POP DE
044180 C1          3991   	POP BC
044181 F1          3992   	POP AF
044182 C9          3993   	RET
044183             3994   
044183             3995   ; HL = word to debug
044183             3996   debug_word:
044183 F5          3997   	PUSH AF
044184 C5          3998   	PUSH BC
044185 D5          3999   	PUSH DE
044186 E5          4000   	PUSH HL
044187 11 00 00 00 4001   	LD DE,$000000 ; remove HLU
04418B 5D          4002   	LD E,L
04418C 54          4003   	LD D,H
04418D D5          4004   	PUSH DE
04418E E1          4005   	POP HL
04418F 11 A6 41 04 4006   	LD DE,debug_text
044193 D5          4007   	PUSH DE
044194 CD AC 41 04 4008   	CALL num2dec
044198 E1          4009   	POP HL
044199 01 05 00 00 4010   	LD BC,5
04419D 3E 00       4011   	LD A,0
04419F 49 DF       4012   	RST.LIS $18
0441A1 E1          4013   	POP HL
0441A2 D1          4014   	POP DE
0441A3 C1          4015   	POP BC
0441A4 F1          4016   	POP AF
0441A5 C9          4017   	RET
0441A6             4018   
0441A6             4019   debug_text:
0441A6             4020   	DS 6
0441AC             4021   
0441AC             4022   ; 16 bits number to string
0441AC             4023   num2dec:
0441AC 01 F0 D8 FF 4024   	LD BC,-10000
0441B0 CD CD 41 04 4025   	CALL num1
0441B4 01 18 FC FF 4026   	LD BC,-1000
0441B8 CD CD 41 04 4027   	CALL num1
0441BC 01 9C FF FF 4028   	LD BC,-100
0441C0 CD CD 41 04 4029   	CALL num1
0441C4 01 F6 FF FF 4030   	LD BC,-10
0441C8 CD CD 41 04 4031   	CALL num1
0441CC 48          4032   	LD C,B
0441CD             4033   
0441CD 3E 2F       4034   num1: LD A,'0'-1
0441CF 3C          4035   num2: INC A
0441D0 09          4036   	ADD HL,BC
0441D1 38 FC       4037   	JR C,num2
0441D3 ED 42       4038   	SBC HL,BC
0441D5             4039   
0441D5 12          4040   	LD (DE),A
0441D6 13          4041   	INC DE
0441D7 C9          4042   	RET
